<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PSAP Interactive Map</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        /* RapidSOS brand colors */
        :root {
            --royal-blue: #001559; /* Primary dark blue */
            --safety-blue: #29A8DD; /* Primary light blue */
            --white: #FFFFFF;
            --safety-gap: #FFF300; /* Yellow highlight */
            --glow: #005eFF; /* Bright blue highlight */
        }

        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        .toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar button {
            background: var(--royal-blue);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 180px;
            text-align: left;
        }

        .toolbar button:hover {
            background: var(--glow);
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .toolbar button.active {
            background: #28a745;
        }

        .toolbar button.danger {
            background: #dc3545;
        }

        .toolbar button.danger:hover {
            background: #c82333;
        }

        #selectionPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .panel-header {
            background: var(--royal-blue);
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
        }

        .selected-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .selected-item:hover {
            background: #f8f9fa;
        }

        .selected-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .panel-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Search bar styles */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .search-input-container {
            display: flex;
            width: 100%;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 2px solid var(--safety-blue);
            border-right: none;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
        }
        
        .search-button {
            background: var(--safety-blue);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        .search-results {
            width: 100%;
            background: white;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background: #f0f0f0;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <div id="viewDiv"></div>
    
    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-input-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for a PSAP...">
            <button class="search-button" id="searchButton">üîç</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Toolbar for multiselect and downloads -->
    <div class="toolbar">
        <button id="selectModeBtn">üñ±Ô∏è Single Select Mode</button>
        <button id="downloadBtn" disabled>üì• Download Selected (0)</button>
        <button id="clearAllBtn" disabled class="danger">‚ùå Clear Selection</button>
    </div>
    
    <!-- Selection Panel -->
    <div id="selectionPanel">
        <div class="panel-header">
            Selected PSAPs (<span id="selectionCount">0</span>)
            <span id="panelToggle" style="cursor: pointer;">‚àí</span>
        </div>
        <div class="panel-content" id="selectionList">
            <!-- Selected items will be populated here -->
        </div>
        <div class="panel-footer">
            Multiple selection: Hold Ctrl/Cmd + click or Multi-Select Mode
        </div>
    </div>

    <div id="status">Single-click to select PSAPs. For multiple: Hold Cmd/Ctrl or Multi-Select Mode.</div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/geometryEngine",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/geometry/projection",
            "esri/geometry/SpatialReference"
        ], function(Map, MapView, FeatureLayer, SimpleFillSymbol, SimpleLineSymbol, SimpleRenderer, Graphic, geometryEngine, Sketch, GraphicsLayer, projection, SpatialReference) {

            let selectedFeatures = []; // Array to store multiple selected features
            let highlightSelections = []; // Array to store highlight handles
            let multiSelectMode = false;

            // UI Elements
            const downloadBtn = document.getElementById('downloadBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const selectModeBtn = document.getElementById('selectModeBtn');
            const selectionPanel = document.getElementById('selectionPanel');
            const selectionList = document.getElementById('selectionList');
            const selectionCount = document.getElementById('selectionCount');
            const panelToggle = document.getElementById('panelToggle');
            const status = document.getElementById('status');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');

            // Create the map
            const map = new Map({
                basemap: "hybrid"
            });

            // Create the map view
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 39.8283], // Center of US
                zoom: 4
            });

            // Define renderer for the layer
            const renderer = new SimpleRenderer({
                symbol: new SimpleFillSymbol({
                    color: [41, 168, 221, 0.4], // Light blue with transparency
                    outline: new SimpleLineSymbol({
                        color: [0, 21, 89, 0.8], // Dark blue outline
                        width: 1
                    })
                })
            });

            // Create the feature layer - PSAP layer instead of Canada towns
            const psapLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/psap_2017/FeatureServer",
                renderer: renderer,
                outFields: ["*"],
                // Set highlight options
                highlightOptions: {
                    color: [255, 243, 0, 0.8], // Bright yellow
                    fillOpacity: 0.8,
                    haloColor: [0, 94, 255], // Blue halo
                    haloOpacity: 1.0,
                    haloSize: 2
                }
            });

            // Add the layer to the map
            map.add(psapLayer);

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            // Reference to layer view for highlighting
            let psapLayerView;

            // Helper function to get consistent feature ID
            function getFeatureId(feature) {
                return feature.attributes.ogc_fid ||
                       feature.attributes.OBJECTID || 
                       feature.attributes.FID ||
                       JSON.stringify(feature.attributes);
            }

            // Helper function to get PSAP name from attributes
            function getPsapName(attributes) {
                return attributes.psap_name || attributes.name || 'Unknown PSAP';
            }

            // Helper function to update selection panel
            function updateSelectionPanel() {
                selectionCount.textContent = selectedFeatures.length;
                downloadBtn.textContent = `üì• Download Selected (${selectedFeatures.length})`;

                if (selectedFeatures.length > 0) {
                    selectionPanel.style.display = 'block';
                    downloadBtn.disabled = false;
                    clearAllBtn.disabled = false;
                } else {
                    selectionPanel.style.display = 'none';
                    downloadBtn.disabled = true;
                    clearAllBtn.disabled = true;
                }

                // Clear and rebuild selection list
                selectionList.innerHTML = '';

                selectedFeatures.forEach((feature, index) => {
                    const psapName = getPsapName(feature.attributes);

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'selected-item';

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'item-name';
                    nameSpan.textContent = psapName;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.textContent = '√ó';
                    removeBtn.title = 'Remove from selection';
                    removeBtn.onclick = () => removeFromSelection(index);

                    itemDiv.appendChild(nameSpan);
                    itemDiv.appendChild(removeBtn);
                    selectionList.appendChild(itemDiv);
                });
            }

            // Helper function to remove item from selection
            function removeFromSelection(index) {
                if (index >= 0 && index < selectedFeatures.length) {
                    // Remove highlight
                    if (highlightSelections[index]) {
                        highlightSelections[index].remove();
                    }

                    // Remove from arrays
                    selectedFeatures.splice(index, 1);
                    highlightSelections.splice(index, 1);

                    updateSelectionPanel();
                    updateStatus();
                }
            }

            // Helper function to clear all selections
            function clearAllSelections() {
                // Remove all highlights
                highlightSelections.forEach(highlight => {
                    if (highlight) highlight.remove();
                });

                selectedFeatures = [];
                highlightSelections = [];
                updateSelectionPanel();
                updateStatus();
            }

            // Helper function to update status message
            function updateStatus() {
                if (selectedFeatures.length === 0) {
                    if (multiSelectMode) {
                        status.textContent = 'üîÑ Multi-select mode active: Click PSAPs to add/remove from selection';
                    } else {
                        // Detect if user is on Mac for better instructions
                        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                        const modifierKey = isMac ? 'Cmd' : 'Ctrl';
                        status.textContent = `Single-click to select PSAPs. Hold ${modifierKey} or use Multi-Select Mode for multiple selections.`;
                    }
                } else {
                    let modeText = '';
                    if (multiSelectMode) modeText = ' (Multi-select mode)';

                    status.textContent = `${selectedFeatures.length} PSAP${selectedFeatures.length > 1 ? 's' : ''} selected${modeText}`;
                }
            }

            // Toggle selection panel
            panelToggle.addEventListener('click', function() {
                const content = document.querySelector('.panel-content');
                const footer = document.querySelector('.panel-footer');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    footer.style.display = 'block';
                    panelToggle.textContent = '‚àí';
                } else {
                    content.style.display = 'none';
                    footer.style.display = 'none';
                    panelToggle.textContent = '+';
                }
            });

            // Toggle multi-select mode
            selectModeBtn.addEventListener('click', function() {
                multiSelectMode = !multiSelectMode;
                
                if (multiSelectMode) {
                    selectModeBtn.textContent = 'üîÑ Multi-Select: ON';
                    selectModeBtn.classList.add('active');
                } else {
                    selectModeBtn.textContent = 'üñ±Ô∏è Single Select Mode';
                    selectModeBtn.classList.remove('active');
                }
                
                updateStatus();
            });

            // Clear all selections
            clearAllBtn.addEventListener('click', clearAllSelections);

            // Search functionality
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            searchButton.addEventListener('click', performSearch);
            
            function performSearch() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length < 2) return;
                
                // Query the layer for matching PSAPs
                const query = psapLayer.createQuery();
                query.where = `psap_name LIKE '%${searchTerm}%' OR account_id LIKE '%${searchTerm}%'`;
                query.outFields = ["*"];
                query.returnGeometry = true;
                
                psapLayer.queryFeatures(query).then(result => {
                    displaySearchResults(result.features);
                }).catch(error => {
                    console.error("Search error:", error);
                });
            }
            
            function displaySearchResults(features) {
                searchResults.innerHTML = '';
                
                if (features.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'search-result-item';
                    noResults.textContent = 'No matching PSAPs found';
                    searchResults.appendChild(noResults);
                } else {
                    features.forEach(feature => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.textContent = getPsapName(feature.attributes);
                        
                        resultItem.addEventListener('click', () => {
                            // Zoom to the feature
                            view.goTo({
                                target: feature.geometry,
                                zoom: 10
                            });
                            
                            // Select the feature
                            selectFeature(feature);
                            
                            // Hide search results
                            searchResults.style.display = 'none';
                        });
                        
                        searchResults.appendChild(resultItem);
                    });
                }
                
                searchResults.style.display = 'block';
            }
            
            // Hide search results when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    searchResults.style.display = 'none';
                }
            });

            // Select a feature programmatically (used by search)
            function selectFeature(feature) {
                if (!multiSelectMode && selectedFeatures.length > 0) {
                    clearAllSelections();
                }
                
                // Check if already selected
                const existingIndex = selectedFeatures.findIndex(f => 
                    getFeatureId(f) === getFeatureId(feature)
                );
                
                if (existingIndex >= 0) {
                    // Already selected - do nothing
                    return;
                }
                
                // Add to selection
                selectedFeatures.push(feature);
                
                // Highlight the feature
                if (psapLayerView) {
                    const highlight = psapLayerView.highlight(feature);
                    highlightSelections.push(highlight);
                }
                
                updateSelectionPanel();
                updateStatus();
            }

            // Click event for feature selection
            view.on("click", function(event) {
                view.hitTest(event).then(function(response) {
                    // Find PSAP features from the hitTest results
                    const psapResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    if (psapResult) {
                        const clickedFeature = psapResult.graphic;
                        
                        // Check for multi-select: either explicit multi-select mode OR modifier keys
                        const isModifierPressed = event.native.ctrlKey || event.native.metaKey;
                        const shouldMultiSelect = multiSelectMode || isModifierPressed;
                        
                        // Check if already selected
                        const existingIndex = selectedFeatures.findIndex(f => 
                            getFeatureId(f) === getFeatureId(clickedFeature)
                        );
                        
                        if (existingIndex >= 0) {
                            // Already selected, so remove it
                            removeFromSelection(existingIndex);
                        } else {
                            // New selection
                            if (!shouldMultiSelect && selectedFeatures.length > 0) {
                                // Clear existing selections in single-select mode
                                clearAllSelections();
                            }
                            
                            // Add to selection
                            selectedFeatures.push(clickedFeature);
                            
                            // Highlight the feature
                            if (psapLayerView) {
                                const highlight = psapLayerView.highlight(clickedFeature);
                                highlightSelections.push(highlight);
                            }
                            
                            updateSelectionPanel();
                            updateStatus();
                        }
                    } else if (!multiSelectMode && !event.native.ctrlKey && !event.native.metaKey) {
                        // Clicked on empty area - clear selection if not in multi-select mode
                        clearAllSelections();
                    }
                });
            });

            // Show tooltip with PSAP name on hover
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    const psapResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    if (psapResult) {
                        const feature = psapResult.graphic;
                        const psapName = getPsapName(feature.attributes);
                        
                        tooltip.textContent = psapName;
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${event.x + 10}px`;
                        tooltip.style.top = `${event.y + 10}px`;
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
            });
            
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
            });

            // Download as GeoJSON
            downloadBtn.addEventListener('click', async function() {
                if (selectedFeatures.length === 0) return;
                
                try {
                    status.textContent = 'Preparing download...';
                    
                    // Process each selected feature
                    const features = await Promise.all(selectedFeatures.map(async feature => {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(feature.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                ...feature.attributes,
                                // Add metadata about projection
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    original_crs: feature.geometry.spatialReference ? 
                                        `EPSG:${feature.geometry.spatialReference.wkid}` : 'Unknown',
                                    target_crs: 'EPSG:4326',
                                    target_crs_name: 'WGS 84'
                                }
                            }
                        };
                    }));
                    
                    // Create GeoJSON object
                    const geoJSON = {
                        type: "FeatureCollection",
                        crs: {
                            type: "name",
                            properties: {
                                name: "urn:ogc:def:crs:EPSG::4326"
                            }
                        },
                        metadata: {
                            exported_by: "RapidSOS PSAP Map",
                            export_date: new Date().toISOString(),
                            feature_count: features.length
                        },
                        features: features
                    };
                    
                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `psap_boundaries_${selectedFeatures.length}_polygons_WGS84_${timestamp}.geojson`;
                    
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                } catch (error) {
                    console.error('Error downloading GeoJSON:', error);
                    status.textContent = 'Error preparing download';
                }
            });

            // Helper function to convert ESRI geometry to GeoJSON with projection
            async function convertEsriGeometryToGeoJSON(geometry) {
                try {
                    // Create target spatial reference (WGS84 / EPSG:4326)
                    const wgs84 = new SpatialReference({ wkid: 4326 });

                    let projectedGeometry = geometry;

                    // Check if geometry needs projection
                    if (geometry.spatialReference && geometry.spatialReference.wkid !== 4326) {
                        console.log(`Projecting from EPSG:${geometry.spatialReference.wkid} to EPSG:4326`);

                        // Load projection engine if not already loaded
                        await projection.load();

                        // Project geometry to WGS84
                        projectedGeometry = projection.project(geometry, wgs84);
                    }

                    // Convert to GeoJSON coordinate format
                    if (projectedGeometry.rings) {
                        // Polygon geometry
                        return projectedGeometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }

                    return [];
                } catch (error) {
                    console.error('Error converting geometry coordinates:', error);
                    console.log('Falling back to original coordinates');

                    // Fallback to original method if projection fails
                    if (geometry.rings) {
                        return geometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }
                    return [];
                }
            }

            // Get a reference to the layer view for highlighting
            view.whenLayerView(psapLayer).then(function(layerView) {
                psapLayerView = layerView;
                console.log("Layer view created for highlighting");
            });

            // Wait for layer to load and zoom to extent
            psapLayer.when(function() {
                console.log("PSAP layer loaded successfully");
                status.textContent = "PSAP data loaded! Click to select boundaries.";

                // Get layer extent and zoom to it
                if (psapLayer.fullExtent) {
                    view.goTo(psapLayer.fullExtent);
                }

                // Initialize UI
                updateStatus();

            }).catch(function(error) {
                console.error("Error loading layer:", error);
                status.textContent = 'Error loading PSAP layer';
            });
        });
    </script>
</body>
</html>
