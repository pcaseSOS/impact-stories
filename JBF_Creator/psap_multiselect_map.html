<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PSAP Interactive Map</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        /* RapidSOS brand colors */
        :root {
            --royal-blue: #001559; /* Primary dark blue */
            --safety-blue: #29A8DD; /* Primary light blue */
            --white: #FFFFFF;
            --safety-gap: #FFF300; /* Yellow highlight */
            --glow: #005eFF; /* Bright blue highlight */
        }

        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        .toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar button {
            background: var(--royal-blue);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 180px;
            text-align: left;
        }

        .toolbar button:hover {
            background: var(--glow);
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .toolbar button.active {
            background: #28a745;
        }

        .toolbar button.danger {
            background: #dc3545;
        }

        .toolbar button.danger:hover {
            background: #c82333;
        }

        #selectionPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .panel-header {
            background: var(--royal-blue);
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
        }

        .selected-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .selected-item:hover {
            background: #f8f9fa;
        }

        .selected-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .panel-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Search bar styles */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .search-input-container {
            display: flex;
            width: 100%;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 2px solid var(--safety-blue);
            border-right: none;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
        }
        
        .search-button {
            background: var(--safety-blue);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        .search-results {
            width: 100%;
            background: white;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background: #f0f0f0;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* Interactive Walkthrough Tutorial Styles */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            z-index: 1000;
            pointer-events: auto;
        }
        
        .tutorial-spotlight {
            position: absolute;
            border-radius: 8px;
            /* Remove dark background box shadow */
            box-shadow: none;
            z-index: 1001;
            pointer-events: none;
            outline: 3px solid var(--royal-blue);
            transition: all 0.5s ease-in-out;
            animation: spotlight-glow 2s infinite alternate;
        }
        
        @keyframes spotlight-glow {
            from { box-shadow: 0 0 10px 5px rgba(0, 116, 217, 0.7); }
            to { box-shadow: 0 0 20px 10px rgba(0, 116, 217, 0.9); }
        }
        
        .tutorial-tooltip {
            position: absolute;
            background-color: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            width: 300px;
            z-index: 1002;
            pointer-events: auto;
            transition: all 0.3s ease;
        }
        
        .tutorial-tooltip h3 {
            margin-top: 0;
            color: var(--royal-blue);
        }
        
        .tutorial-tooltip p {
            margin-bottom: 15px;
        }
        
        .tutorial-tooltip .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .tutorial-tooltip button {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }
        
        .tutorial-tooltip .next-btn {
            background-color: var(--royal-blue);
            color: white;
        }
        
        .tutorial-tooltip .skip-btn {
            background-color: #f0f0f0;
            color: #666;
        }
        
        .highlight-element {
            position: relative;
            z-index: 1002;
            pointer-events: auto !important;
            animation: pulse-highlight 1.5s infinite;
            box-shadow: 0 0 0 5px rgba(0, 116, 217, 0.7);
            outline: 3px solid var(--royal-blue);
            border-radius: 4px;
        }
        
        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(0, 116, 217, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(0, 116, 217, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 116, 217, 0); }
        }
        
        /* Area Selection Modal Styles */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }
        
        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 400px;
            max-width: 80%;
            text-align: center;
        }
        
        .modal h2 {
            margin-top: 0;
            color: #333;
        }
        
        .modal p {
            margin-bottom: 20px;
            font-size: 16px;
            color: #555;
        }
        
        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .select-area-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background-color: #2b6da8;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .select-area-btn:hover {
            background-color: #3980bd;
            transform: translateY(-2px);
        }
        
        .select-area-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <div id="viewDiv"></div>
    
    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-input-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for a PSAP...">
            <button class="search-button" id="searchButton">üîç</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Toolbar for multiselect and downloads -->
    <div class="toolbar" id="toolbar">
        <button id="layerSwitchBtn">Focus: US PSAPs</button>
        <button id="multiSelectBtn">üîò Multi-Select: ON</button>
        <button id="drawPolygonBtn">‚úèÔ∏è Draw Polygon</button>
        <button id="downloadBtn" disabled>üì• Download Selected (0)</button>
        <button id="downloadDrawnBtn" style="display:none;">üì• Download Drawn Polygon</button>
        <button id="clearAllBtn" disabled class="danger">‚ùå Clear Selection</button>
        <button id="startTutorialBtn" class="esri-button--small">‚ùì Tutorial</button>
    </div>
    
    <!-- Selection Panel -->
    <div id="selectionPanel">
        <div class="panel-header">
            <span id="selectionHeaderText">Selected Features</span> (<span id="selectionCount">0</span>)
            <span id="panelToggle" style="cursor: pointer;">‚àí</span>
        </div>
        <div class="panel-content" id="selectionList">
            <!-- Selected items will be populated here -->
        </div>
        <div class="panel-footer">
            Multiple selection is enabled by default. Hold Ctrl/Cmd + click to add more.
        </div>
    </div>

    <div id="status">Single-click to select PSAPs. For multiple: Hold Cmd/Ctrl or Multi-Select Mode.</div>
    
    <!-- Area Selection Modal -->
    <div id="areaSelectionModal" class="modal">
        <div class="modal-content">
            <h2>Select Area</h2>
            <p>Which area would you like to work with?</p>
            <div class="modal-buttons">
                <button id="selectUSBtn" class="select-area-btn">United States</button>
                <button id="selectCanadaBtn" class="select-area-btn">Canada</button>
                <button id="selectDefaultBtn" class="select-area-btn">Other (Default)</button>
            </div>
        </div>
    </div>

    <!-- Interactive Walkthrough Elements -->
    <div id="tutorialOverlay" class="tutorial-overlay" style="display: none;"></div>
    <div id="tutorialSpotlight" class="tutorial-spotlight" style="display: none;"></div>
    <div id="tutorialTooltip" class="tutorial-tooltip" style="display: none;">
        <h3 id="tooltipTitle">Welcome to the PSAP Map!</h3>
        <p id="tooltipContent">This interactive tutorial will walk you through how to use this map effectively. Click 'Next' to begin.</p>
        <div class="buttons">
            <button id="skipTutorialBtn" class="skip-btn">Skip Tutorial</button>
            <button id="nextTutorialBtn" class="next-btn">Next</button>
        </div>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/geometryEngine",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/geometry/projection",
            "esri/geometry/SpatialReference",
            "esri/widgets/Expand"
        ], function(Map, MapView, FeatureLayer, SimpleFillSymbol, SimpleLineSymbol, SimpleRenderer, Graphic, geometryEngine, Sketch, GraphicsLayer, projection, SpatialReference, Expand) {

            // Initialize variables
            let sketchGraphicsLayer;
            let drawnPolygon = null;
            let selectedFeatures = [];
            let highlightSelections = [];
            let psapLayerView;
            let canadaTownsLayerView;
            let initialLoadComplete = false;
            let activeLayer = 'psap'; // Default to PSAP layer
            let multiSelectMode = true; // Default multi-select to ON
            let drawnPolygons = [];
            let drawingMode = false; // Used in toggleDrawingMode
            let sketch = null; // For sketch widget

            // UI Elements
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadDrawnBtn = document.getElementById('downloadDrawnBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const multiSelectBtn = document.getElementById('multiSelectBtn');
            const drawPolygonBtn = document.getElementById('drawPolygonBtn');
            const selectionPanel = document.getElementById('selectionPanel');
            const selectionList = document.getElementById('selectionList');
            const selectionCount = document.getElementById('selectionCount');
            const panelToggle = document.getElementById('panelToggle');
            const status = document.getElementById('status');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');

            // Create the map
            const map = new Map({
                basemap: "hybrid"
            });

            // Create the map view
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 39.8283], // Center of US
                zoom: 4
            });

            // Define renderer for the layer
            const renderer = new SimpleRenderer({
                symbol: new SimpleFillSymbol({
                    color: [41, 168, 221, 0.4], // Light blue with transparency
                    outline: new SimpleLineSymbol({
                        color: [0, 21, 89, 0.8], // Dark blue outline
                        width: 1
                    })
                })
            });

            // Create the feature layer - PSAP layer instead of Canada towns
            const psapLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/psap_2017/FeatureServer",
                renderer: renderer,
                outFields: ["*"],
                // Set highlight options
                highlightOptions: {
                    color: [255, 243, 0, 0.8], // Bright yellow
                    fillOpacity: 0.8,
                    haloColor: [0, 94, 255], // Blue halo
                    haloOpacity: 1.0,
                    haloSize: 2
                }
            });

            // Create graphics layer for drawings
            const drawLayer = new GraphicsLayer({
                title: "User-Drawn Polygons"
            });
            
            // Create the Canadian Towns layer with its own renderer
            const canadaTownsLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/Canada_Town/FeatureServer",
                title: "Canadian Towns",
                renderer: new SimpleRenderer({
                    symbol: new SimpleFillSymbol({
                        color: [51, 51, 204, 0.3], // Blue with transparency
                        outline: new SimpleLineSymbol({
                            color: [51, 51, 204, 0.8], // Dark blue outline
                            width: 1
                        })
                    })
                }),
                outFields: ["*"],  // Get all fields for proper attribute handling
                popupEnabled: false,  // Disable click popups for Canadian Towns
                // No popupTemplate needed since popups are disabled
                // We'll still show information via custom hover tooltips instead
                // Set highlight options
                highlightOptions: {
                    color: [0, 102, 255, 0.8], // Blue highlight
                    fillOpacity: 0.7,
                    haloColor: [0, 102, 255],
                    haloOpacity: 0.7
                }
            });
            
            // Add all layers to the map
            map.add(psapLayer);
            map.add(canadaTownsLayer);
            map.add(drawLayer);

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            // Reference to layer view for highlighting already declared at the top
            // Using the existing psapLayerView and canadaTownsLayerView variables

            // Centralized function to highlight all selected features
            function highlightSelectedFeatures() {
                console.log('Highlighting selected features:', selectedFeatures.length);
                
                // Clear existing highlights first
                highlightSelections.forEach(highlight => {
                    if (highlight && highlight.remove) highlight.remove();
                });
                highlightSelections = [];
                
                if (selectedFeatures.length === 0) {
                    console.log('No features to highlight');
                    return;
                }
                
                // Apply highlights to all selected features based on which layer they belong to
                selectedFeatures.forEach(feature => {
                    try {
                        // Check which layer the feature belongs to
                        const isPsapFeature = feature.layer === psapLayer;
                        
                        if (isPsapFeature && psapLayerView) {
                            const highlight = psapLayerView.highlight(feature);
                            highlightSelections.push(highlight);
                            console.log('Added PSAP highlight');
                        } else if (!isPsapFeature && canadaTownsLayerView) {
                            const highlight = canadaTownsLayerView.highlight(feature);
                            highlightSelections.push(highlight);
                            console.log('Added Canadian Towns highlight');
                        }
                    } catch (error) {
                        console.error('Error highlighting feature:', error);
                    }
                });
            }

            // Helper function to get consistent feature ID
            function getFeatureId(feature) {
                return feature.attributes.ogc_fid ||
                       feature.attributes.OBJECTID || 
                       feature.attributes.FID ||
                       JSON.stringify(feature.attributes);
            }

            // Helper function to get PSAP name from attributes
            function getPsapName(attributes) {
                return attributes.psap_name || attributes.name || 'Unknown PSAP';
            }
            
            // Helper function to get town name from attributes
            function getTownName(attributes) {
                // For debugging - log all attributes to see what's available
                console.log('Canadian Town attributes:', attributes);
                
                // Try specific field names that should exist in the Canadian Towns layer
                if (attributes.NAME) {
                    return attributes.NAME;
                }
                
                if (attributes.name) {
                    return attributes.name;
                }
                
                if (attributes.TOWN_NAME) {
                    return attributes.TOWN_NAME;
                }
                
                // Prioritize fields with 'name', 'town', or 'city' in them
                const nameFields = Object.keys(attributes).filter(key => 
                    key.toLowerCase().includes('name') || 
                    key.toLowerCase().includes('town') || 
                    key.toLowerCase().includes('city')
                );
                
                for (const field of nameFields) {
                    if (attributes[field] && typeof attributes[field] === 'string' && attributes[field].trim() !== '') {
                        return attributes[field];
                    }
                }
                
                // If no name found, combine the ID and any other useful information
                return `Town ID: ${attributes.OBJECTID || attributes.FID || 'Unknown'}`;
            }

            // Helper function to update selection panel - implementation from Canada app
            function updateSelectionPanel() {
                console.log('Updating selection panel with', selectedFeatures.length, 'features');
                
                // Update count display and button text
                selectionCount.textContent = selectedFeatures.length;
                downloadBtn.textContent = `üì• Download Selected (${selectedFeatures.length})`;
                
                // Count how many features of each type
                const psapCount = selectedFeatures.filter(f => f.layer === psapLayer).length;
                const townCount = selectedFeatures.filter(f => f.layer !== psapLayer).length;
                
                // Create an appropriate header text based on what's selected
                const headerTextElement = document.getElementById('selectionHeaderText');
                if (psapCount > 0 && townCount > 0) {
                    headerTextElement.textContent = `Selected Features (${psapCount} PSAPs, ${townCount} Towns)`;
                } else if (psapCount > 0) {
                    headerTextElement.textContent = `Selected PSAPs`;
                } else if (townCount > 0) {
                    headerTextElement.textContent = `Selected Towns`;
                } else {
                    headerTextElement.textContent = `Selected Features`;
                }
                
                // Show/hide panel and update button states
                if (selectedFeatures.length > 0) {
                    selectionPanel.style.display = 'block';
                    downloadBtn.disabled = false;
                    clearAllBtn.disabled = false;
                } else {
                    selectionPanel.style.display = 'none';
                    downloadBtn.disabled = true;
                    clearAllBtn.disabled = true;
                }
                
                // Clear and rebuild selection list - IMPORTANT: Do this in one place only
                selectionList.innerHTML = '';
                
                // Add each selected feature to the panel
                selectedFeatures.forEach((feature, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'selected-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'item-name';
                    
                    // Get appropriate name based on which layer the feature belongs to
                    const isPsapFeature = feature.layer === psapLayer;
                    
                    if (isPsapFeature) {
                        nameSpan.textContent = getPsapName(feature.attributes);
                    } else {
                        nameSpan.textContent = getTownName(feature.attributes);
                    }
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.textContent = '√ó';
                    removeBtn.title = 'Remove from selection';
                    removeBtn.onclick = () => removeFromSelection(index);
                    
                    itemDiv.appendChild(nameSpan);
                    itemDiv.appendChild(removeBtn);
                    selectionList.appendChild(itemDiv);
                });
            }
            
            // Helper function to remove item from selection - from Canada app
            function removeFromSelection(index) {
                if (index >= 0 && index < selectedFeatures.length) {
                    // Get the feature to show in status message
                    const feature = selectedFeatures[index];
                    const isPsapFeature = feature.layer === psapLayer;
                    const featureName = isPsapFeature ? 
                        getPsapName(feature.attributes) : 
                        getTownName(feature.attributes);
                    
                    // Remove highlight
                    if (highlightSelections[index]) {
                        highlightSelections[index].remove();
                    }
                    
                    // Remove from arrays
                    selectedFeatures.splice(index, 1);
                    highlightSelections.splice(index, 1);
                    
                    // Update UI
                    updateSelectionPanel();
                    status.textContent = `Removed ${featureName} from selection`;
                }
            }

            // Helper function to clear all selections
            function clearAllSelections() {
                console.log('Clearing all selections');
                
                // Remove all highlights
                highlightSelections.forEach(highlight => {
                    if (highlight && highlight.remove) highlight.remove();
                });
                
                // Clear arrays
                highlightSelections = [];
                selectedFeatures = [];
                
                // Update UI
                updateSelectionPanel();
                status.textContent = 'All selections cleared';
            }

            // Helper function to clear all selections
            function clearAllSelections() {
                console.log('Clearing all selections');
                
                // Remove all highlights
                highlightSelections.forEach(highlight => {
                    if (highlight && highlight.remove) {
                        try {
                            highlight.remove();
                        } catch (e) {
                            console.error('Error removing highlight:', e);
                        }
                    }
                });

                selectedFeatures = [];
                highlightSelections = [];
                
                // Clear PSAP layer highlights if available
                if (psapLayerView && psapLayerView.highlight) {
                    try {
                        psapLayerView.highlight();
                    } catch (e) {
                        console.error('Error clearing PSAP highlights:', e);
                    }
                }
                
                // Clear Canadian Towns layer highlights if available
                if (canadaTownsLayerView && canadaTownsLayerView.highlight) {
                    try {
                        canadaTownsLayerView.highlight();
                    } catch (e) {
                        console.error('Error clearing Canadian Towns highlights:', e);
                    }
                }
                
                updateSelectionPanel();
                updateStatus();
                
                // Update button state
                clearAllBtn.disabled = true;
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'üì• Download Selected (0)';
            }

            // Helper function to update status message
            function updateStatus() {
                if (selectedFeatures.length === 0) {
                    if (activeLayer === 'psap') {
                        status.textContent = 'Click to select PSAPs. Hold Ctrl/Cmd for multiple selection.';
                    } else {
                        status.textContent = 'Click to select Canadian towns. Hold Ctrl/Cmd for multiple selection.';
                    }
                } else {
                    if (activeLayer === 'psap') {
                        status.textContent = `${selectedFeatures.length} PSAP${selectedFeatures.length > 1 ? 's' : ''} selected. Use Ctrl/Cmd+click to add more.`;
                    } else {
                        status.textContent = `${selectedFeatures.length} town${selectedFeatures.length > 1 ? 's' : ''} selected. Use Ctrl/Cmd+click to add more.`;
                    }
                }
            }

            // Toggle selection panel
            panelToggle.addEventListener('click', function() {
                const content = document.querySelector('.panel-content');
                const footer = document.querySelector('.panel-footer');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    footer.style.display = 'block';
                    panelToggle.textContent = '‚àí';
                } else {
                    content.style.display = 'none';
                    footer.style.display = 'none';
                    panelToggle.textContent = '+';
                }
            });

            // Clear all selections
            clearAllBtn.addEventListener('click', clearAllSelections);

            // Search functionality
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            searchButton.addEventListener('click', performSearch);
            
            function performSearch() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length < 2) return;
                
                // Different query based on active layer
                if (activeLayer === 'psap') {
                    // Query PSAP layer
                    const query = psapLayer.createQuery();
                    query.where = `psap_name LIKE '%${searchTerm}%' OR account_id LIKE '%${searchTerm}%' OR NAME LIKE '%${searchTerm}%'`;
                    query.outFields = ["*"];
                    query.returnGeometry = true;
                    
                    psapLayer.queryFeatures(query).then(result => {
                        displaySearchResults(result.features, 'psap');
                    }).catch(error => {
                        console.error("PSAP search error:", error);
                    });
                } else {
                    // Query Canadian Towns layer
                    const query = canadaTownsLayer.createQuery();
                    
                    // Create a more comprehensive search query for town names
                    let whereClause = '';
                    
                    // Look for fields that might contain the town name
                    const nameFields = ['NAME', 'TOWN_NAME', 'CITY_NAME', 'MUNICIPALITY'];
                    nameFields.forEach(fieldName => {
                        if (whereClause) {
                            whereClause += ` OR ${fieldName} LIKE '%${searchTerm}%'`;
                        } else {
                            whereClause = `${fieldName} LIKE '%${searchTerm}%'`;
                        }
                    });
                    
                    query.where = whereClause || "1=0"; // Use 1=0 if no valid fields (will return no results)
                    query.outFields = ["*"];
                    query.returnGeometry = true;
                    
                    canadaTownsLayer.queryFeatures(query).then(result => {
                        displaySearchResults(result.features, 'canada');
                    }).catch(error => {
                        console.error("Canadian Towns search error:", error);
                    });
                }
            }
            
            function displaySearchResults(features, layerType) {
                searchResults.innerHTML = '';
                
                if (features.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'search-result-item';
                    noResults.textContent = layerType === 'psap' ? 'No matching PSAPs found' : 'No matching towns found';
                    searchResults.appendChild(noResults);
                    return;
                }
                
                features.forEach(feature => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // Get name from attributes based on layer type
                    let name;
                    if (layerType === 'psap') {
                        name = feature.attributes.NAME || feature.attributes.PSAP_NAME || feature.attributes.psap_name || 
                              `PSAP ${feature.attributes.OBJECTID || ''}`;
                    } else {
                        name = getTownName(feature.attributes);
                    }
                    resultItem.textContent = name;
                    
                    // Click to select
                    resultItem.addEventListener('click', function() {
                        // Close search results
                        searchResults.innerHTML = '';
                        searchInput.value = '';
                        
                        // Select the feature
                        selectFeature(feature);
                        
                        // Zoom to the feature
                        view.goTo({
                            target: feature.geometry,
                            zoom: 10
                        });
                    });
                    
                    searchResults.appendChild(resultItem);
                });
                
                // Make search results visible
                searchResults.style.display = 'block';
            }
            
            // Hide search results when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    searchResults.style.display = 'none';
                }
            });

            // Select a feature programmatically (used by search)
            function selectFeature(feature) {
                if (!multiSelectMode && selectedFeatures.length > 0) {
                    clearAllSelections();
                }
                
                // Check if already selected
                const existingIndex = selectedFeatures.findIndex(f => 
                    getFeatureId(f) === getFeatureId(feature)
                );
                
                if (existingIndex >= 0) {
                    // Already selected - do nothing
                    return;
                }
                
                // Add to selection
                selectedFeatures.push(feature);
                
                // Highlight the feature
                if (psapLayerView) {
                    const highlight = psapLayerView.highlight(feature);
                    highlightSelections.push(highlight);
                }
                
                // Update selection panel with newly selected feature
                updateSelectionPanel();
                updateStatus();
            }
            
            // Hide tooltip when leaving map area
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
            });
            
            // Show tooltip with feature name on hover for both layers
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    // Check for PSAP layer feature
                    const psapResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    // Check for Canada Towns layer feature
                    const canadaResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === canadaTownsLayer
                    );
                    
                    // First try the focused layer, then the other
                    let hoverResult = null;
                    if (activeLayer === 'psap') {
                        hoverResult = psapResult || canadaResult;
                    } else {
                        hoverResult = canadaResult || psapResult;
                    }
                    
                    // Show tooltip if we found a feature
                    if (hoverResult) {
                        const feature = hoverResult.graphic;
                        let featureName = '';
                        
                        // Determine which layer the feature belongs to and create appropriate tooltip content
                        if (feature.layer === psapLayer) {
                            // For PSAP layer, get the PSAP name and format tooltip
                            featureName = getPsapName(feature.attributes);
                            tooltip.innerHTML = `<strong>${featureName}</strong>`;
                            
                            // Add additional PSAP info if available
                            if (feature.attributes.state) {
                                tooltip.innerHTML += `<br>State: ${feature.attributes.state}`;
                            }
                        } else {
                            // For Canadian Towns layer, get town name and format tooltip with more details
                            featureName = getTownName(feature.attributes);
                            tooltip.innerHTML = `<strong>${featureName}</strong>`;
                            
                            // Add additional town info if available
                            const attrs = feature.attributes;
                            if (attrs.PROVINCE) {
                                tooltip.innerHTML += `<br>Province: ${attrs.PROVINCE}`;
                            }
                            if (attrs.POPULATION) {
                                tooltip.innerHTML += `<br>Population: ${attrs.POPULATION.toLocaleString()}`;
                            }
                        }
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${event.x + 10}px`;
                        tooltip.style.top = `${event.y + 10}px`;
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
            });
            
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
            });

            // Download as GeoJSON
            downloadBtn.addEventListener('click', async function() {
                if (selectedFeatures.length === 0) return;
                
                try {
                    status.textContent = 'Preparing download...';
                    
                    // Process each selected feature
                    const features = await Promise.all(selectedFeatures.map(async feature => {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(feature.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                ...feature.attributes,
                                // Add metadata about projection
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    original_crs: feature.geometry.spatialReference ? 
                                        `EPSG:${feature.geometry.spatialReference.wkid}` : 'Unknown',
                                    target_crs: 'EPSG:4326',
                                    target_crs_name: 'WGS 84'
                                }
                            }
                        };
                    }));
                    
                    // Create GeoJSON object
                    const geoJSON = {
                        type: "FeatureCollection",
                        crs: {
                            type: "name",
                            properties: {
                                name: "urn:ogc:def:crs:EPSG::4326"
                            }
                        },
                        metadata: {
                            exported_by: "RapidSOS PSAP Map",
                            export_date: new Date().toISOString(),
                            feature_count: features.length
                        },
                        features: features
                    };
                    
                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `psap_boundaries_${selectedFeatures.length}_polygons_WGS84_${timestamp}.geojson`;
                    
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    if (activeLayer === 'psap') {
                        status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                    } else if (activeLayer === 'canada') {
                        status.textContent = `Downloaded ${selectedFeatures.length} Canada Towns polygons in WGS84 format`;
                    } else {
                        status.textContent = `Downloaded ${selectedFeatures.length} features in WGS84 format`;
                    }
                } catch (error) {
                    console.error('Error downloading GeoJSON:', error);
                    status.textContent = 'Error preparing download';
                }
            });

            // Helper function to convert ESRI geometry to GeoJSON with projection
            async function convertEsriGeometryToGeoJSON(geometry) {
                try {
                    // Create target spatial reference (WGS84 / EPSG:4326)
                    const wgs84 = new SpatialReference({ wkid: 4326 });

                    let projectedGeometry = geometry;

                    // Check if geometry needs projection
                    if (geometry.spatialReference && geometry.spatialReference.wkid !== 4326) {
                        console.log(`Projecting from EPSG:${geometry.spatialReference.wkid} to EPSG:4326`);

                        // Load projection engine if not already loaded
                        await projection.load();

                        // Project geometry to WGS84
                        projectedGeometry = projection.project(geometry, wgs84);
                    }

                    // Convert to GeoJSON coordinate format
                    if (projectedGeometry.rings) {
                        // Polygon geometry
                        return projectedGeometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }

                    return [];
                } catch (error) {
                    console.error('Error converting geometry coordinates:', error);
                    console.log('Falling back to original coordinates');

                    // Fallback to original method if projection fails
                    if (geometry.rings) {
                        return geometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }
                    return [];
                }
            }

            // Set up the sketch widget for polygon drawing
            function setupDrawTools() {
                // Create the sketch widget for drawing polygons
                sketch = new Sketch({
                    layer: drawLayer,
                    view: view,
                    creationMode: "update",
                    availableCreateTools: ["polygon"], // Only allow polygon creation
                    defaultCreateOptions: {
                        mode: "click" // Default to click-by-click polygon creation
                    },
                    visibleElements: {
                        createTools: {
                            point: false,
                            polyline: false,
                            polygon: true,
                            rectangle: false,
                            circle: false
                        },
                        selectionTools: {
                            "lasso-selection": false,
                            "rectangle-selection": false
                        },
                        undoRedoMenu: true,
                        settingsMenu: false
                    }
                });
                
                // Track drawing state
                sketch.on(["create", "update", "delete"], function(event) {
                    if (event.state === "complete") {
                        // Show download button when drawing is complete
                        if (drawLayer.graphics.length > 0) {
                            downloadDrawnBtn.style.display = "block";
                            status.textContent = "Polygon drawn! You can now download it or continue editing.";
                        } else {
                            downloadDrawnBtn.style.display = "none";
                        }
                    }
                });
                
                return sketch;
            }
            
            // Toggle drawing mode
            function toggleDrawingMode() {
                drawingMode = !drawingMode;
                
                if (drawingMode) {
                    // Activate drawing mode
                    if (!sketch) {
                        sketch = setupDrawTools();
                    }
                    view.ui.add(sketch, { position: "bottom-right" });
                    drawPolygonBtn.textContent = "‚úèÔ∏è Exit Drawing Mode";
                    drawPolygonBtn.classList.add("active");
                    status.textContent = "Drawing mode active. Click to create polygon vertices, double-click to complete.";
                } else {
                    // Deactivate drawing mode
                    if (sketch) {
                        view.ui.remove(sketch);
                    }
                    drawPolygonBtn.textContent = "‚úèÔ∏è Draw Polygon";
                    drawPolygonBtn.classList.remove("active");
                    status.textContent = "Drawing mode exited.";
                }
            }
            
            // Get a reference to the layer view for highlighting
            view.whenLayerView(psapLayer).then(function(layerView) {
                psapLayerView = layerView;
                console.log("Layer view created for highlighting");
            });

            // Function to download drawn polygons as GeoJSON
            async function downloadDrawnPolygons() {
                // Get all graphics from the draw layer
                const graphics = drawLayer.graphics.toArray();
                
                if (graphics.length === 0) {
                    alert("No polygons drawn! Draw a polygon first.");
                    return;
                }
                
                try {
                    status.textContent = 'Preparing download of drawn polygon...';
                    
                    // Process each drawn graphic
                    const features = await Promise.all(graphics.map(async function(graphic, index) {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(graphic.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                id: index + 1,
                                name: `User Drawn Polygon ${index + 1}`,
                                drawn_date: new Date().toISOString(),
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    source: "User Drawing",
                                    target_crs: "EPSG:4326",
                                    target_crs_name: "WGS 84"
                                }
                            }
                        };
                    }));
                    
                    // Create GeoJSON object
                    const geoJSON = {
                        type: "FeatureCollection",
                        crs: {
                            type: "name",
                            properties: {
                                name: "urn:ogc:def:crs:EPSG::4326"
                            }
                        },
                        metadata: {
                            exported_by: "RapidSOS PSAP Map - Drawing Tool",
                            export_date: new Date().toISOString(),
                            feature_count: features.length
                        },
                        features: features
                    };
                    
                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `user_drawn_polygons_${timestamp}.geojson`;
                    
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    status.textContent = `Downloaded ${drawnPolygons.length} drawn polygon(s) as GeoJSON`;
                } catch (error) {
                    console.error('Error downloading drawn polygons:', error);
                    alert('Error downloading drawn polygons. Please try again.');
                    status.textContent = 'Error during download';
                }
            }
            
            // Multi-select is now the default behavior, so no toggle function needed
            
            function downloadSelected() {
                if (selectedFeatures.length === 0) return;
                
                try {
                    status.textContent = 'Preparing download...';
                    
                    // Process each selected feature
                    Promise.all(selectedFeatures.map(async feature => {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(feature.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                ...feature.attributes,
                                // Add metadata about projection
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    original_crs: feature.geometry.spatialReference ? 
                                        `EPSG:${feature.geometry.spatialReference.wkid}` : 'Unknown',
                                    target_crs: 'EPSG:4326',
                                    target_crs_name: 'WGS 84'
                                }
                            }
                        };
                    })).then(features => {
                        // Create GeoJSON object
                        const geoJSON = {
                            type: "FeatureCollection",
                            crs: {
                                type: "name",
                                properties: {
                                    name: "urn:ogc:def:crs:EPSG::4326"
                                }
                            },
                            metadata: {
                                exported_by: "RapidSOS PSAP Map",
                                export_date: new Date().toISOString(),
                                feature_count: features.length
                            },
                            features: features
                        };
                        
                        // Convert to JSON string and download
                        const json = JSON.stringify(geoJSON, null, 2);
                        const blob = new Blob([json], {type: "application/json"});
                        const url = URL.createObjectURL(blob);
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = `${activeLayer === 'psap' ? 'psap' : 'canada_towns'}_export_${new Date().toISOString().slice(0,10)}.geojson`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(url);
                        
                        if (activeLayer === 'psap') {
                            status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                        } else {
                            status.textContent = `Downloaded ${selectedFeatures.length} Canadian Towns in WGS84 format`;
                        }
                    }).catch(error => {
                        console.error('Error downloading GeoJSON:', error);
                        alert('Error preparing download. Please try again.');
                        status.textContent = 'Error during download';
                    });
                    
                } catch (error) {
                    console.error('Error downloading GeoJSON:', error);
                    alert('Error downloading GeoJSON. Please try again.');
                    status.textContent = 'Error during download';
                }
            }
            
            // Attach event handlers to buttons
            // Make sure clearAllBtn event listener is properly attached
            clearAllBtn.addEventListener('click', clearAllSelections);
            downloadBtn.addEventListener('click', downloadSelected);
            drawPolygonBtn.addEventListener('click', toggleDrawingMode);
            downloadDrawnBtn.addEventListener('click', downloadDrawnPolygons);
            layerSwitchBtn.addEventListener('click', switchActiveLayer);
            
            // Multi-select button functionality
            multiSelectBtn.addEventListener('click', function() {
                multiSelectMode = !multiSelectMode;
                multiSelectBtn.textContent = multiSelectMode ? 'üîò Multi-Select: ON' : 'üîò Multi-Select: OFF';
                status.textContent = multiSelectMode ? 'Multi-select mode activated. Click on multiple features to select them.' : 'Multi-select mode deactivated. Click on a feature to select it.';
            });
            
            // Function to switch between PSAP and Canadian Towns layers
            // Now just changes visual focus but both layers remain selectable
            function switchActiveLayer() {
                if (activeLayer === 'psap') {
                    // Switch to Canadian Towns layer as visual focus
                    activeLayer = 'canada';
                    // Keep both layers visible, but adjust opacity to show which is in focus
                    psapLayer.opacity = 0.3;
                    canadaTownsLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: Canadian Towns';
                    
                    // Get Canada layer view for highlighting
                    if (!canadaTownsLayerView) {
                        view.whenLayerView(canadaTownsLayer).then(function(layerView) {
                            console.log('Created Canadian Towns layer view');
                            canadaTownsLayerView = layerView;
                        });
                    }
                    
                    // Update status text
                    status.textContent = 'Switched to Canadian Towns layer. Click to select towns';
                    
                    // Zoom to Canada
                    view.goTo({
                        target: {
                            xmin: -140.0,
                            ymin: 40.0,
                            xmax: -50.0,
                            ymax: 70.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 40, right: 40, top: 40, bottom: 40 }
                    });
                    
                    console.log('Switched to Canadian Towns layer');
                } else {
                    // Switch to PSAP layer as visual focus
                    activeLayer = 'psap';
                    // Keep both layers visible, but adjust opacity to show which is in focus
                    canadaTownsLayer.opacity = 0.3;
                    psapLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: US PSAPs';
                    
                    // Make sure we have the PSAP layer view for highlighting
                    if (!psapLayerView) {
                        view.whenLayerView(psapLayer).then(function(layerView) {
                            console.log('Created PSAP layer view');
                            psapLayerView = layerView;
                            initialLoadComplete = true;
                        });
                    }
                    
                    // Update status text
                    status.textContent = 'Switched to US PSAPs layer. Click to select PSAPs.';
                    
                    // Zoom back to continental US
                    view.goTo({
                        target: {
                            xmin: -125.0,
                            ymin: 24.0,
                            xmax: -66.0,
                            ymax: 49.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    console.log('Switched to PSAP layer');
                }
            }
            
            // Interactive Walkthrough Tutorial Functionality
            const startTutorialBtn = document.getElementById('startTutorialBtn');
            const tutorialOverlay = document.getElementById('tutorialOverlay');
            const tutorialSpotlight = document.getElementById('tutorialSpotlight');
            const tutorialTooltip = document.getElementById('tutorialTooltip');
            const tooltipTitle = document.getElementById('tooltipTitle');
            const tooltipContent = document.getElementById('tooltipContent');
            const skipTutorialBtn = document.getElementById('skipTutorialBtn');
            const nextTutorialBtn = document.getElementById('nextTutorialBtn');
            
            // Tutorial steps
            const tutorialSteps = [
                {
                    // Welcome step
                    title: 'Welcome to the Enhanced PSAP Map!',
                    content: 'This interactive tutorial will guide you through using this map to work with both US PSAP boundaries and Canadian Towns. Ready to begin?',
                    target: null,
                    position: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                    spotlightSize: null
                },
                {
                    // Map overview
                    title: 'The Map',
                    content: 'This map now displays both US PSAP boundaries and Canadian Towns. You can interact with either layer in several ways.',
                    target: '#viewDiv',
                    position: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                    spotlightSize: { width: '80%', height: '80%' }
                },
                {
                    // Layer switching
                    title: 'Layer Focus',
                    content: 'Click this button to switch focus between US PSAPs and Canadian Towns. Both layers remain visible, but the focused layer is highlighted.',
                    target: '#layerSwitchBtn',
                    position: { top: '75px', left: '200px' },
                    spotlightSize: { width: '180px', height: '45px' }
                },
                {
                    // Multi-select button
                    title: 'Multi-Select Mode',
                    content: 'Multi-select mode is ON by default, allowing you to select multiple features from either layer. Toggle this button to switch between single and multi-select modes.',
                    target: '#multiSelectBtn',
                    position: { top: '75px', left: '360px' },
                    spotlightSize: { width: '180px', height: '45px' }
                },
                {
                    // Search bar
                    title: 'Search Functionality',
                    content: 'You can search for specific US PSAPs or Canadian Towns by name using this search bar. The search works for whichever layer currently has focus.',
                    target: '.search-container',
                    position: { top: '75px', left: '50%', transform: 'translateX(-50%)' },
                    spotlightSize: { width: '320px', height: '60px' }
                },
                {
                    // Drawing button
                    title: 'Drawing Tool',
                    content: 'Click this button to enter drawing mode, which lets you create your own custom polygons over either layer.',
                    target: '#drawPolygonBtn',
                    position: { top: '75px', right: '340px' },
                    spotlightSize: { width: '150px', height: '45px' }
                },
                {
                    // Method 1: Selecting existing boundaries
                    title: 'Option 1: Select Existing Boundaries',
                    content: 'You can click directly on PSAP boundaries to select them. They will highlight in blue when selected. Try clicking on a boundary now!',
                    target: '#viewDiv',
                    position: { top: '30%', left: '50%', transform: 'translateX(-50%)' },
                    spotlightSize: { width: '50%', height: '50%' }
                },
                {
                    // Selected panel
                    title: 'Selected Features Panel',
                    content: 'Your selected PSAPs and Towns appear here. You can remove individual selections or download them all as GeoJSON.',
                    target: '#selectionPanel',
                    position: { top: '150px', left: '250px' },
                    spotlightSize: null,
                    condition: function() { return selectedFeatures.length > 0; },
                    retry: 'Please select a boundary first by clicking on it, then continue.'
                },
                {
                    // Download selected button
                    title: 'Download Selected',
                    content: 'Once you have selected PSAPs, click this button to download them as a GeoJSON file.',
                    target: '#downloadBtn',
                    position: { top: '140px', right: '220px' },
                    spotlightSize: null
                },
                {
                    // Method 2: Drawing custom polygons
                    title: 'Option 2: Draw Custom Polygons',
                    content: "Now let's learn how to draw your own custom polygons. Click 'Next' to continue.",
                    target: null,
                    position: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                    spotlightSize: null
                },
                {
                    // Activate drawing mode
                    title: 'Start Drawing Mode',
                    content: 'Click the "Draw Polygon" button to activate drawing mode.',
                    target: '#drawPolygonBtn',
                    position: { top: '110px', right: '220px' },
                    spotlightSize: null,
                    action: function() {
                        // Actually highlight the button
                        addHighlightClass('#drawPolygonBtn');
                    },
                    cleanup: function() {
                        removeHighlightClass('#drawPolygonBtn');
                    }
                },
                {
                    // Drawing tools instruction
                    title: 'Drawing Tools',
                    content: 'When in drawing mode, use the sketch widget that appears in the bottom-right corner to draw your polygon. Click on the map to create vertices, and double-click to complete your polygon.',
                    target: '#viewDiv',
                    position: { bottom: '120px', right: '120px' },
                    spotlightSize: { width: '300px', height: '200px' }
                },
                {
                    // Download drawn polygon
                    title: 'Download Your Polygon',
                    content: 'After drawing a polygon, the "Download Drawn Polygon" button will appear. Click it to save your custom polygon as a GeoJSON file.',
                    target: '#downloadDrawnBtn',
                    position: { top: '170px', right: '220px' },
                    spotlightSize: null
                },
                {
                    // Final step
                    title: 'Tutorial Complete!',
                    content: 'You now know how to select existing PSAP boundaries and draw your own custom polygons. Click "Finish" to start using the map.',
                    target: null,
                    position: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                    spotlightSize: null,
                    buttonText: 'Finish'
                }
            ];
            
            let currentStep = 0;
            
            // Function to start the tutorial
            function startTutorial() {
                currentStep = 0;
                showTutorialStep();
            }
            
            // Function to show a specific tutorial step
            function showTutorialStep() {
                const step = tutorialSteps[currentStep];
                
                // Check if step has a condition and if it's not met
                if (step.condition && !step.condition()) {
                    tooltipContent.textContent = step.retry || 'Please complete this step before continuing.';
                    return;
                }
                
                // Display overlay
                tutorialOverlay.style.display = 'block';
                
                // Reset any existing positions
                resetTooltipAndSpotlightPositions();
                
                // Set tooltip content
                tooltipTitle.textContent = step.title;
                tooltipContent.textContent = step.content;
                
                // Update button text if specified
                nextTutorialBtn.textContent = step.buttonText || 'Next';
                
                // If step has an action, perform it
                if (step.action) {
                    step.action();
                }
                
                // Position spotlight and tooltip
                if (step.target) {
                    const targetElement = document.querySelector(step.target);
                    if (targetElement) {
                        // Add highlight class to make element interactive and bring to front
                        targetElement.classList.add('highlight-element');
                        
                        // Make sure the element is visible by scrolling to it if needed
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                        
                        // Calculate position for spotlight
                        const rect = targetElement.getBoundingClientRect();
                        
                        // Position spotlight
                        tutorialSpotlight.style.display = 'block';
                        
                        // Add more padding to the spotlight for better visibility
                        const spotlightPadding = 15; // increased padding for better visibility
                        
                        if (step.spotlightSize) {
                            // Custom spotlight size
                            let width, height;
                            
                            // Handle percentage or pixel values
                            if (typeof step.spotlightSize.width === 'string' && step.spotlightSize.width.includes('%')) {
                                const percentage = parseInt(step.spotlightSize.width) / 100;
                                width = window.innerWidth * percentage;
                            } else {
                                width = step.spotlightSize.width.replace('px', '');
                            }
                            
                            if (typeof step.spotlightSize.height === 'string' && step.spotlightSize.height.includes('%')) {
                                const percentage = parseInt(step.spotlightSize.height) / 100;
                                height = window.innerHeight * percentage;
                            } else {
                                height = step.spotlightSize.height.replace('px', '');
                            }
                            
                            tutorialSpotlight.style.width = `${width}px`;
                            tutorialSpotlight.style.height = `${height}px`;
                            
                            // Center spotlight on element
                            tutorialSpotlight.style.top = `${rect.top - ((height - rect.height) / 2)}px`;
                            tutorialSpotlight.style.left = `${rect.left - ((width - rect.width) / 2)}px`;
                        } else {
                            // Default spotlight size based on element with increased size for better visibility
                            // Precise pixel positioning based on getBoundingClientRect
                            // The spotlightPadding is used to make the spotlight larger than the element
                            const elementCenterX = rect.left + (rect.width / 2);
                            const elementCenterY = rect.top + (rect.height / 2);
                            const spotlightWidth = rect.width + (spotlightPadding * 2.5);
                            const spotlightHeight = rect.height + (spotlightPadding * 2.5);
                            
                            // Position from the center of the element for more accurate alignment
                            tutorialSpotlight.style.top = `${elementCenterY - (spotlightHeight / 2)}px`;
                            tutorialSpotlight.style.left = `${elementCenterX - (spotlightWidth / 2)}px`;
                            tutorialSpotlight.style.width = `${spotlightWidth}px`;
                            tutorialSpotlight.style.height = `${spotlightHeight}px`;
                        }
                        
                        // Position tooltip - display it after positioning to avoid flicker
                        positionTooltip(step, rect);
                    }
                } else {
                    // No target, center the tooltip
                    tutorialSpotlight.style.display = 'none';
                    tutorialTooltip.style.display = 'block';
                    
                    if (step.position) {
                        if (step.position.top) tutorialTooltip.style.top = step.position.top;
                        if (step.position.left) tutorialTooltip.style.left = step.position.left;
                        if (step.position.right) tutorialTooltip.style.right = step.position.right;
                        if (step.position.bottom) tutorialTooltip.style.bottom = step.position.bottom;
                        if (step.position.transform) tutorialTooltip.style.transform = step.position.transform;
                    } else {
                        tutorialTooltip.style.top = '50%';
                        tutorialTooltip.style.left = '50%';
                        tutorialTooltip.style.transform = 'translate(-50%, -50%)';
                    }
                }
            }
            
            // Helper function to position the tooltip
            function positionTooltip(step, targetRect) {
                // Reset tooltip position
                tutorialTooltip.style.display = 'block';
                
                // Apply custom positioning if provided
                if (step.position) {
                    if (step.position.top) tutorialTooltip.style.top = step.position.top;
                    if (step.position.left) tutorialTooltip.style.left = step.position.left;
                    if (step.position.right) tutorialTooltip.style.right = step.position.right;
                    if (step.position.bottom) tutorialTooltip.style.bottom = step.position.bottom;
                    if (step.position.transform) tutorialTooltip.style.transform = step.position.transform;
                } else {
                    // Default smarter positioning based on available space
                    const tooltipRect = tutorialTooltip.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;
                    
                    // Clear any existing positions
                    tutorialTooltip.style.top = '';
                    tutorialTooltip.style.left = '';
                    tutorialTooltip.style.right = '';
                    tutorialTooltip.style.bottom = '';
                    tutorialTooltip.style.transform = '';
                    
                    // Determine best position (above, below, left, or right of target)
                    const spaceAbove = targetRect.top;
                    const spaceBelow = viewportHeight - targetRect.bottom;
                    const spaceLeft = targetRect.left;
                    const spaceRight = viewportWidth - targetRect.right;
                    
                    // Find the direction with most space
                    const maxSpace = Math.max(spaceAbove, spaceBelow, spaceLeft, spaceRight);
                    
                    // Position based on available space
                    if (maxSpace === spaceBelow && spaceBelow >= tooltipRect.height) {
                        // Position below
                        tutorialTooltip.style.top = (targetRect.bottom + 10) + 'px';
                        tutorialTooltip.style.left = (targetRect.left + (targetRect.width/2) - (tooltipRect.width/2)) + 'px';
                    } else if (maxSpace === spaceAbove && spaceAbove >= tooltipRect.height) {
                        // Position above
                        tutorialTooltip.style.bottom = (viewportHeight - targetRect.top + 10) + 'px';
                        tutorialTooltip.style.left = (targetRect.left + (targetRect.width/2) - (tooltipRect.width/2)) + 'px';
                    } else if (maxSpace === spaceRight && spaceRight >= tooltipRect.width) {
                        // Position to the right
                        tutorialTooltip.style.left = (targetRect.right + 10) + 'px';
                        tutorialTooltip.style.top = (targetRect.top + (targetRect.height/2) - (tooltipRect.height/2)) + 'px';
                    } else if (maxSpace === spaceLeft && spaceLeft >= tooltipRect.width) {
                        // Position to the left
                        tutorialTooltip.style.right = (viewportWidth - targetRect.left + 10) + 'px';
                        tutorialTooltip.style.top = (targetRect.top + (targetRect.height/2) - (tooltipRect.height/2)) + 'px';
                    } else {
                        // Fallback: center on screen if no good position
                        tutorialTooltip.style.top = '50%';
                        tutorialTooltip.style.left = '50%';
                        tutorialTooltip.style.transform = 'translate(-50%, -50%)';
                    }
                }
            }
            
            // Helper function to reset tooltip and spotlight positions
            function resetTooltipAndSpotlightPositions() {
                // Reset tooltip
                tutorialTooltip.style.top = '';
                tutorialTooltip.style.left = '';
                tutorialTooltip.style.right = '';
                tutorialTooltip.style.bottom = '';
                tutorialTooltip.style.transform = '';
                
                // Reset spotlight
                tutorialSpotlight.style.top = '';
                tutorialSpotlight.style.left = '';
                tutorialSpotlight.style.width = '';
                tutorialSpotlight.style.height = '';
            }
            
            // Function to advance to the next tutorial step
            function nextTutorialStep() {
                // Clean up current step
                cleanupCurrentStep();
                
                // Move to next step
                currentStep++;
                
                // Check if tutorial is complete
                if (currentStep >= tutorialSteps.length) {
                    endTutorial();
                    return;
                }
                
                // Show the next step
                showTutorialStep();
            }
            
            // Function to clean up the current step
            function cleanupCurrentStep() {
                const step = tutorialSteps[currentStep];
                
                // Remove highlight class from any elements
                document.querySelectorAll('.highlight-element').forEach(el => {
                    el.classList.remove('highlight-element');
                });
                
                // Call cleanup function if it exists
                if (step.cleanup) {
                    step.cleanup();
                }
            }
            
            // Function to end the tutorial
            function endTutorial() {
                tutorialOverlay.style.display = 'none';
                tutorialSpotlight.style.display = 'none';
                tutorialTooltip.style.display = 'none';
                
                // Remove any highlight classes
                document.querySelectorAll('.highlight-element').forEach(el => {
                    el.classList.remove('highlight-element');
                });
            }
            
            // Helper functions for highlighting elements
            function addHighlightClass(selector) {
                const el = document.querySelector(selector);
                if (el) el.classList.add('highlight-element');
            }
            
            function removeHighlightClass(selector) {
                const el = document.querySelector(selector);
                if (el) el.classList.remove('highlight-element');
            }
            
            // Event listeners for tutorial buttons
            startTutorialBtn.addEventListener('click', startTutorial);
            skipTutorialBtn.addEventListener('click', endTutorial);
            nextTutorialBtn.addEventListener('click', nextTutorialStep);
            
            // Function to handle showing the area selection modal ONE TIME ONLY
            function handleAreaSelection() {
                // Check if user has made a selection before (stored in localStorage)
                if (localStorage.getItem('psapMapAreaSelected') === 'true') {
                    console.log('Area already selected previously, not showing modal');
                    return; // Skip showing the modal entirely
                }
                
                // Show the modal only ONCE
                console.log('Showing area selection modal');
                areaSelectionModal.style.display = 'block';
                
                // Set up the area selection function to permanently mark selection as made
                selectUSBtn.addEventListener('click', function() {
                    // Mark selection as made FIRST
                    localStorage.setItem('psapMapAreaSelected', 'true'); 
                    selectArea('us');
                    // Start tutorial after a slight delay to allow the map to zoom
                    setTimeout(startTutorial, 1200);
                });
                
                selectCanadaBtn.addEventListener('click', function() {
                    // Mark selection as made FIRST
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('canada');
                    // Start tutorial after a slight delay to allow the map to zoom
                    setTimeout(startTutorial, 1200);
                });
                
                selectDefaultBtn.addEventListener('click', function() {
                    // Mark selection as made FIRST
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('default');
                    // Start tutorial after a slight delay to allow the map to zoom
                    setTimeout(startTutorial, 1200);
                });
            }
            
            // Call the function ONE time at startup
            window.addEventListener('load', function() {
                // Wait for the map to be fully loaded
                setTimeout(handleAreaSelection, 1500);
            });
            
            // Add click handler for feature selection from both layers
            view.on("click", function(event) {
                // Don't process clicks if drawing mode is active
                if (sketch) return;
                
                // Get the screen point for hit testing
                const screenPoint = {
                    x: event.x,
                    y: event.y
                };
                
                // Perform hit test to see if user clicked on a feature
                view.hitTest(screenPoint).then(function(response) {
                    // Check both layers for features, not just the active one
                    // First check for PSAP features
                    const psapFeature = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    // Then check for Canadian Towns features
                    const canadaFeature = response.results.find(result => 
                        result.graphic && result.graphic.layer === canadaTownsLayer
                    );
                    
                    // First try the active layer, then fall back to the other layer
                    let clickedFeature = null;
                    if (activeLayer === 'psap') {
                        clickedFeature = psapFeature || canadaFeature;
                    } else {
                        clickedFeature = canadaFeature || psapFeature;
                    }
                    
                    if (clickedFeature) {
                        const feature = clickedFeature.graphic;
                        console.log('Clicked feature:', feature);
                        
                        // Check for multi-select: either explicit multi-select mode OR modifier keys
                        const isModifierPressed = event.native.ctrlKey || 
                                              event.native.metaKey || 
                                              event.native.shiftKey;
                        
                        const shouldMultiSelect = multiSelectMode || isModifierPressed;
                        console.log('Selection debug:', {
                            multiSelectMode, 
                            isModifierPressed, 
                            shouldMultiSelect, 
                            currentSelectionCount: selectedFeatures.length
                        });
                        
                        // Get feature ID for consistent comparison
                        const featureId = feature.attributes.OBJECTID || feature.attributes.FID;
                        
                        // Check if this feature is already selected
                        const existingIndex = selectedFeatures.findIndex(f => 
                            (f.attributes.OBJECTID === featureId) || (f.attributes.FID === featureId)
                        );
                        
                        if (existingIndex >= 0) {
                            // Feature already selected - remove it (toggle behavior)
                            // Get feature properties for status message
                            const isPsapFeature = feature.layer === psapLayer;
                            const featureName = isPsapFeature ? 
                                getPsapName(feature.attributes) : 
                                getTownName(feature.attributes);
                            
                            // Remove the highlight
                            if (highlightSelections[existingIndex] && highlightSelections[existingIndex].remove) {
                                highlightSelections[existingIndex].remove();
                            }
                            
                            // Remove from arrays
                            selectedFeatures.splice(existingIndex, 1);
                            highlightSelections.splice(existingIndex, 1);
                            
                            // Update UI
                            updateSelectionPanel();
                            status.textContent = `Removed ${featureName} from selection`;
                        } else {
                            // New selection
                            if (!shouldMultiSelect && selectedFeatures.length > 0) {
                                // Single select mode and we have existing selections - clear them first
                                console.log('Clearing previous selections for single select');
                                clearAllSelections();
                            }
                            
                            // Add new selection
                            selectedFeatures.push(feature);
                            console.log('Added feature, total selections:', selectedFeatures.length);
                            
                            // Highlight selected feature based on which layer it belongs to
                            const isPsapFeature = feature.layer === psapLayer;
                            
                            if (isPsapFeature && psapLayerView) {
                                const highlight = psapLayerView.highlight(feature);
                                highlightSelections.push(highlight);
                                const psapName = getPsapName(feature.attributes);
                                status.textContent = `Added ${psapName} to selection (${selectedFeatures.length} total)`;
                            } else if (!isPsapFeature && canadaTownsLayerView) {
                                const highlight = canadaTownsLayerView.highlight(feature);
                                highlightSelections.push(highlight);
                                const townName = getTownName(feature.attributes);
                                status.textContent = `Added ${townName} to selection (${selectedFeatures.length} total)`;
                            }
                            
                            // Update selection panel
                            updateSelectionPanel();
                        }
                    } else {
                        // Clicked on empty area
                        if (!multiSelectMode && !event.native.ctrlKey && !event.native.metaKey && selectedFeatures.length > 0) {
                            // In single-select mode, clear selections when clicking on empty space
                            // (this matches the behavior in the Canada app)
                            clearAllSelections();
                        }
                    }
                });
            });
            
            // Set initial visibility - both layers visible
            psapLayer.visible = true;
            canadaTownsLayer.visible = true;
            
            // Create layer views for both layers and start tutorial when all loaded
            let psapViewLoaded = false;
            let canadaViewLoaded = false;
            
            // Function to check if both layers are loaded and start tutorial
            function checkLayersAndStartTutorial() {
                if (psapViewLoaded && canadaViewLoaded) {
                    console.log("Both layer views created, can start tutorial");
                    // Auto-start tutorial when map is fully loaded
                    // Slight delay to ensure everything is rendered
                    setTimeout(startTutorial, 1000);
                }
            }
            
            view.whenLayerView(psapLayer).then(function(layerView) {
                psapLayerView = layerView;
                initialLoadComplete = true;
                console.log("PSAP layer view created");
                
                // Highlight any selected features
                highlightSelectedFeatures();
                
                // Mark PSAP layer as loaded
                psapViewLoaded = true;
                checkLayersAndStartTutorial();
            });
            
            view.whenLayerView(canadaTownsLayer).then(function(layerView) {
                canadaTownsLayerView = layerView;
                console.log("Canadian Towns layer view created");
                
                // Mark Canada Towns layer as loaded
                canadaViewLoaded = true;
                checkLayersAndStartTutorial();
            });
            
            // Area selection modal functionality
            const areaSelectionModal = document.getElementById('areaSelectionModal');
            const selectUSBtn = document.getElementById('selectUSBtn');
            const selectCanadaBtn = document.getElementById('selectCanadaBtn');
            const selectDefaultBtn = document.getElementById('selectDefaultBtn');
            
            // Function to handle area selection
            function selectArea(area) {
                console.log(`Selected area: ${area}`);
                
                // Close the modal
                areaSelectionModal.style.display = 'none';
                
                // Set the appropriate layer as active based on selection
                if (area === 'canada') {
                    activeLayer = 'canada';
                    psapLayer.opacity = 0.3;
                    canadaTownsLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: Canadian Towns';
                    
                    // Zoom to Canada
                    view.goTo({
                        target: {
                            xmin: -141.0,
                            ymin: 41.0,
                            xmax: -52.0,
                            ymax: 83.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    // Update placeholder text for search input
                    searchInput.placeholder = 'Search for a town...';
                    
                } else {
                    // Default to US/other
                    activeLayer = 'psap';
                    canadaTownsLayer.opacity = 0.3;
                    psapLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: US PSAPs';
                    
                    // Zoom to US
                    view.goTo({
                        target: {
                            xmin: -125.0,
                            ymin: 24.0,
                            xmax: -66.0,
                            ymax: 49.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    // Update placeholder text for search input
                    searchInput.placeholder = 'Search for a PSAP...';
                }
            }
            
            // Event listeners for area selection buttons
            selectUSBtn.addEventListener('click', function() {
                selectArea('us');
            });
            
            selectCanadaBtn.addEventListener('click', function() {
                selectArea('canada');
            });
            
            selectDefaultBtn.addEventListener('click', function() {
                selectArea('other');
            });
            
            // Wait for layer to load and zoom to extent
            psapLayer.when(function() {
                console.log("PSAP layer loaded successfully");
                status.textContent = "PSAP data loaded! Click to select boundaries or use Draw Polygon tool.";

                // Zoom to continental US for better default view
                view.goTo({
                    target: {
                        xmin: -125.0,
                        ymin: 24.0,
                        xmax: -66.0,
                        ymax: 49.0,
                        spatialReference: { wkid: 4326 }
                    },
                    padding: { left: 20, right: 20, top: 20, bottom: 20 }
                });

                // Initialize UI
                updateStatus();
            }).catch(function(error) {
                console.error("Error loading layer:", error);
                status.textContent = 'Error loading PSAP layer';
            });
        });
    </script>
</body>
</html>
