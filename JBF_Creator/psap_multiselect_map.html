<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PSAP Interactive Map</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        /* Tutorial Overlay Styles */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .tutorial-container {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .tutorial-header {
            background: var(--royal-blue);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tutorial-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .tutorial-content {
            padding: 20px;
        }
        
        .tutorial-step {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tutorial-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .tutorial-step h3 {
            color: var(--royal-blue);
            margin-top: 0;
        }
        
        .tutorial-step p {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .tutorial-step kbd {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.9em;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .tutorial-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .tutorial-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .tutorial-button.primary {
            background: var(--safety-blue);
            color: white;
        }
        
        .tutorial-button.secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .tutorial-step-number {
            display: inline-block;
            background: var(--safety-blue);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-weight: bold;
        }

        /* RapidSOS brand colors */
        :root {
            --royal-blue: #001559; /* Primary dark blue */
            --safety-blue: #29A8DD; /* Primary light blue */
            --white: #FFFFFF;
            --safety-gap: #FFF300; /* Yellow highlight */
            --glow: #005eFF; /* Bright blue highlight */
        }

        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        .toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar button {
            background: var(--royal-blue);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 180px;
            text-align: left;
        }

        .toolbar button:hover {
            background: var(--glow);
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .toolbar button.active {
            background: #28a745;
        }

        .toolbar button.danger {
            background: #dc3545;
        }

        .toolbar button.danger:hover {
            background: #c82333;
        }
        
        /* Help Button */
        .help-button {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            font-size: 14px;
        }
        
        .help-button:hover {
            background: #f5f5f5;
        }
        
        .help-button:hover {
            background: var(--safety-blue);
            transform: scale(1.1);
        }
        
        .help-button svg {
            width: 20px;
            height: 20px;
        }

        #selectionPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .panel-header {
            background: var(--royal-blue);
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
        }

        .selected-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .selected-item:hover {
            background: #f8f9fa;
        }

        .selected-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .panel-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Search bar styles */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .search-input-container {
            display: flex;
            width: 100%;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 2px solid var(--safety-blue);
            border-right: none;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
        }
        
        .search-button {
            background: var(--safety-blue);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .search-result-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        
        .search-result-type {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .search-result-details {
            font-size: 13px;
            color: #6c757d;
            margin: 8px 0;
            max-height: 100px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .search-result-detail {
            margin-bottom: 4px;
            line-height: 1.4;
        }
        
        .search-result-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .search-result-actions .btn {
            font-size: 12px;
            padding: 3px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .no-details {
            color: #adb5bd;
            font-style: italic;
            font-size: 12px;
        }
        
        /* Area Selection Modal Styles */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }
        
        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 400px;
            max-width: 80%;
            text-align: center;
        }
        
        .modal h2 {
            margin-top: 0;
            color: #333;
        }
        
        .modal p {
            margin-bottom: 20px;
            font-size: 16px;
            color: #555;
        }
        
        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .select-area-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background-color: #2b6da8;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .select-area-btn:hover {
            background-color: #3980bd;
            transform: translateY(-2px);
        }
        
        .select-area-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <!-- Help Button has been moved to the toolbar below -->
    
    <div id="viewDiv"></div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay">
        <div class="tutorial-container">
            <div class="tutorial-header">
                <h2>PSAP Map Tutorial</h2>
                <button class="tutorial-close">&times;</button>
            </div>
            <div class="tutorial-content">
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">1</span>Selecting Features</h3>
                    <p>Click on any PSAP or Canadian town to select it. Selected features will be highlighted.</p>
                    <p>To select multiple features:</p>
                    <ul>
                        <li>Hold <kbd>Ctrl</kbd> (Windows) or <kbd>⌘</kbd> (Mac) while clicking</li>
                        <li>Or enable <strong>Multi-Select Mode</strong> to select multiple features without holding keys</li>
                    </ul>
                </div>
                
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">2</span>Searching for Locations</h3>
                    <p>Use the search bar in the top-left to find specific PSAPs or Canadian towns.</p>
                    <p>Click on a search result to zoom to that location and select it.</p>
                </div>
                
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">3</span>Managing Selections</h3>
                    <p>View your selected features in the panel on the left. You can:</p>
                    <ul>
                        <li>Click the <strong>×</strong> next to an item to remove it</li>
                        <li>Click <strong>Clear All</strong> to remove all selections</li>
                        <li>Click <strong>Download Selected</strong> to export your selection as GeoJSON</li>
                    </ul>
                </div>
                
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">4</span>Drawing Tools</h3>
                    <p>Use the drawing tools to create custom areas of interest:</p>
                    <ul>
                        <li>Click the <strong>Draw Polygon</strong> button to start drawing</li>
                        <li>Click to add points, double-click to complete the shape</li>
                        <li>Download your drawn areas using the download button</li>
                    </ul>
                </div>
                
                <div class="tutorial-buttons">
                    <button class="tutorial-button secondary" id="dontShowAgain">Don't Show Again</button>
                    <button class="tutorial-button primary" id="tutorialGotIt">Got it, thanks!</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-input-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for a PSAP...">
            <button class="search-button" id="searchButton">🔍</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Toolbar for multiselect and downloads -->
    <div class="toolbar" id="toolbar">
        <button id="layerSwitchBtn">Focus: US PSAPs</button>
        <button id="multiSelectBtn">🔘 Multi-Select: ON</button>
        <button id="drawPolygonBtn">✏️ Draw Polygon</button>
        <button id="downloadBtn" disabled>📥 Download Selected (0)</button>
        <button id="downloadDrawnBtn" style="display:none;">📥 Download Drawn Polygon</button>
        <button id="clearAllBtn" disabled class="danger">❌ Clear Selection</button>
        <button id="helpButton" class="help-button" title="Show Map Tutorial">📚 Map Tutorial</button>
    </div>
    
    <!-- Selection Panel -->
    <div id="selectionPanel">
        <div class="panel-header">
            <span id="selectionHeaderText">Selected Features</span> (<span id="selectionCount">0</span>)
            <span id="panelToggle" style="cursor: pointer;">−</span>
        </div>
        <div class="panel-content" id="selectionList">
            <!-- Selected items will be populated here -->
        </div>
        <div class="panel-footer">
            Multiple selection is enabled by default. Hold Ctrl/Cmd + click to add more.
        </div>
    </div>

    <div id="status">Single-click to select PSAPs. For multiple: Hold Cmd/Ctrl or Multi-Select Mode.</div>
    
    <!-- Area Selection Modal -->
    <div id="areaSelectionModal" class="modal">
        <div class="modal-content">
            <h2>Select Area</h2>
            <p>Which area would you like to work with?</p>
            <div class="modal-buttons">
                <button id="selectUSBtn" class="select-area-btn">United States</button>
                <button id="selectCanadaBtn" class="select-area-btn">Canada</button>
                <button id="selectDefaultBtn" class="select-area-btn">Other (Default)</button>
            </div>
        </div>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/geometryEngine",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/geometry/projection",
            "esri/geometry/SpatialReference",
            "esri/widgets/Expand"
        ], function(Map, MapView, FeatureLayer, SimpleFillSymbol, SimpleLineSymbol, SimpleRenderer, Graphic, geometryEngine, Sketch, GraphicsLayer, projection, SpatialReference, Expand) {

            // Initialize variables
            let sketchGraphicsLayer;
            let drawnPolygon = null;
            let selectedFeatures = [];
            let highlightSelections = [];
            let psapLayerView;
            let canadaTownsLayerView;
            let activeLayer = 'psap'; // Default to PSAP layer
            let multiSelectMode = true; // Default multi-select to ON
            let drawnPolygons = [];
            let drawingMode = false; // Used in toggleDrawingMode
            let sketch = null; // For sketch widget

            // UI Elements
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadDrawnBtn = document.getElementById('downloadDrawnBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const multiSelectBtn = document.getElementById('multiSelectBtn');
            const drawPolygonBtn = document.getElementById('drawPolygonBtn');
            const selectionPanel = document.getElementById('selectionPanel');
            const selectionList = document.getElementById('selectionList');
            const selectionCount = document.getElementById('selectionCount');
            const panelToggle = document.getElementById('panelToggle');
            const status = document.getElementById('status');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');

            // Create the map
            const map = new Map({
                basemap: "hybrid"
            });

            // Create the map view
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 39.8283], // Center of US
                zoom: 4
            });

            // Define renderer for the layer
            const renderer = new SimpleRenderer({
                symbol: new SimpleFillSymbol({
                    color: [41, 168, 221, 0.4], // Light blue with transparency
                    outline: new SimpleLineSymbol({
                        color: [0, 21, 89, 0.8], // Dark blue outline
                        width: 1
                    })
                })
            });

            // Create the feature layer - PSAP layer instead of Canada towns
            const psapLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/psap_2017/FeatureServer",
                renderer: renderer,
                outFields: ["*"],
                // Set highlight options
                highlightOptions: {
                    color: [255, 243, 0, 0.8], // Bright yellow
                    fillOpacity: 0.8,
                    haloColor: [0, 94, 255], // Blue halo
                    haloOpacity: 1.0,
                    haloSize: 2
                }
            });

            // Create graphics layer for drawings
            const drawLayer = new GraphicsLayer({
                title: "User-Drawn Polygons"
            });
            
            // Create the Canadian Towns layer with its own renderer
            const canadaTownsLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/Canada_Town/FeatureServer",
                title: "Canadian Towns",
                renderer: new SimpleRenderer({
                    symbol: new SimpleFillSymbol({
                        color: [51, 51, 204, 0.3], // Blue with transparency
                        outline: new SimpleLineSymbol({
                            color: [51, 51, 204, 0.8], // Dark blue outline
                            width: 1
                        })
                    })
                }),
                outFields: ["*"],  // Get all fields for proper attribute handling
                popupEnabled: false,  // Disable click popups for Canadian Towns
                // No popupTemplate needed since popups are disabled
                // We'll still show information via custom hover tooltips instead
                // Set highlight options
                highlightOptions: {
                    color: [0, 102, 255, 0.8], // Blue highlight
                    fillOpacity: 0.7,
                    haloColor: [0, 102, 255],
                    haloOpacity: 0.7
                }
            });
            
            // Add all layers to the map
            map.add(psapLayer);
            map.add(canadaTownsLayer);
            map.add(drawLayer);

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            // Reference to layer view for highlighting already declared at the top
            // Using the existing psapLayerView and canadaTownsLayerView variables

            // Centralized function to highlight all selected features
            function highlightSelectedFeatures() {
                console.log('Highlighting selected features:', selectedFeatures.length);
                
                // Clear existing highlights first
                highlightSelections.forEach(highlight => {
                    if (highlight && highlight.remove) highlight.remove();
                });
                highlightSelections = [];
                
                if (selectedFeatures.length === 0) {
                    console.log('No features to highlight');
                    return;
                }
                
                // Apply highlights to all selected features based on which layer they belong to
                selectedFeatures.forEach(feature => {
                    try {
                        // Check which layer the feature belongs to
                        const isPsapFeature = feature.layer === psapLayer;
                        
                        if (isPsapFeature && psapLayerView) {
                            const highlight = psapLayerView.highlight(feature);
                            highlightSelections.push(highlight);
                            console.log('Added PSAP highlight');
                        } else if (!isPsapFeature && canadaTownsLayerView) {
                            const highlight = canadaTownsLayerView.highlight(feature);
                            highlightSelections.push(highlight);
                            console.log('Added Canadian Towns highlight');
                        }
                    } catch (error) {
                        console.error('Error highlighting feature:', error);
                    }
                });
            }

            // Helper function to get consistent feature ID
            function getFeatureId(feature) {
                if (!feature || !feature.attributes) {
                    console.warn('Invalid feature object in getFeatureId:', feature);
                    return Math.random().toString(36).substr(2, 9); // Return random ID as fallback
                }
                
                // Try common ID fields
                const id = feature.attributes.ogc_fid ||
                          feature.attributes.OBJECTID || 
                          feature.attributes.FID ||
                          feature.attributes.objectid ||
                          feature.attributes.OBJECTID_1 ||
                          feature.attributes.fid;
                
                // If no ID field found, create a hash of the attributes
                if (id === undefined || id === null) {
                    try {
                        return JSON.stringify(feature.attributes);
                    } catch (e) {
                        console.warn('Failed to stringify feature attributes:', e);
                        return Math.random().toString(36).substr(2, 9);
                    }
                }
                
                return id;
            }

            // Helper function to get PSAP name from attributes
            function getPsapName(attributes) {
                return attributes.psap_name || attributes.name || 'Unknown PSAP';
            }
            
            // Helper function to get town name from attributes
            function getTownName(attributes) {
                // For debugging - log all attributes to see what's available
                console.log('Canadian Town attributes:', attributes);
                
                // Try specific field names that should exist in the Canadian Towns layer
                if (attributes.NAME) {
                    return attributes.NAME;
                }
                
                if (attributes.name) {
                    return attributes.name;
                }
                
                if (attributes.TOWN_NAME) {
                    return attributes.TOWN_NAME;
                }
                
                // Prioritize fields with 'name', 'town', or 'city' in them
                const nameFields = Object.keys(attributes).filter(key => 
                    key.toLowerCase().includes('name') || 
                    key.toLowerCase().includes('town') || 
                    key.toLowerCase().includes('city')
                );
                
                for (const field of nameFields) {
                    if (attributes[field] && typeof attributes[field] === 'string' && attributes[field].trim() !== '') {
                        return attributes[field];
                    }
                }
                
                // If no name found, combine the ID and any other useful information
                return `Town ID: ${attributes.OBJECTID || attributes.FID || 'Unknown'}`;
            }

            // Helper function to update selection panel - implementation from Canada app
            function updateSelectionPanel() {
                console.log('Updating selection panel with', selectedFeatures.length, 'features');
                
                // Update count display and button text
                selectionCount.textContent = selectedFeatures.length;
                downloadBtn.textContent = `📥 Download Selected (${selectedFeatures.length})`;
                
                // Count how many features of each type
                const psapCount = selectedFeatures.filter(f => f.layer === psapLayer).length;
                const townCount = selectedFeatures.filter(f => f.layer !== psapLayer).length;
                
                // Create an appropriate header text based on what's selected
                const headerTextElement = document.getElementById('selectionHeaderText');
                if (psapCount > 0 && townCount > 0) {
                    headerTextElement.textContent = `Selected Features (${psapCount} PSAPs, ${townCount} Towns)`;
                } else if (psapCount > 0) {
                    headerTextElement.textContent = `Selected PSAPs`;
                } else if (townCount > 0) {
                    headerTextElement.textContent = `Selected Towns`;
                } else {
                    headerTextElement.textContent = `Selected Features`;
                }
                
                // Show/hide panel and update button states
                if (selectedFeatures.length > 0) {
                    selectionPanel.style.display = 'block';
                    downloadBtn.disabled = false;
                    clearAllBtn.disabled = false;
                } else {
                    selectionPanel.style.display = 'none';
                    downloadBtn.disabled = true;
                    clearAllBtn.disabled = true;
                }
                
                // Clear and rebuild selection list - IMPORTANT: Do this in one place only
                selectionList.innerHTML = '';
                
                // Add each selected feature to the panel
                selectedFeatures.forEach((feature, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'selected-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'item-name';
                    
                    // Get appropriate name based on which layer the feature belongs to
                    const isPsapFeature = feature.layer === psapLayer;
                    
                    if (isPsapFeature) {
                        nameSpan.textContent = getPsapName(feature.attributes);
                    } else {
                        nameSpan.textContent = getTownName(feature.attributes);
                    }
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.textContent = '×';
                    removeBtn.title = 'Remove from selection';
                    removeBtn.onclick = () => removeFromSelection(index);
                    
                    itemDiv.appendChild(nameSpan);
                    itemDiv.appendChild(removeBtn);
                    selectionList.appendChild(itemDiv);
                });
            }
            
            // Helper function to remove item from selection - from Canada app
            function removeFromSelection(index) {
                if (index >= 0 && index < selectedFeatures.length) {
                    // Get the feature to show in status message
                    const feature = selectedFeatures[index];
                    const isPsapFeature = feature.layer === psapLayer;
                    const featureName = isPsapFeature ? 
                        getPsapName(feature.attributes) : 
                        getTownName(feature.attributes);
                    
                    // Remove highlight
                    if (highlightSelections[index]) {
                        highlightSelections[index].remove();
                    }
                    
                    // Remove from arrays
                    selectedFeatures.splice(index, 1);
                    highlightSelections.splice(index, 1);
                    
                    // Update UI
                    updateSelectionPanel();
                    status.textContent = `Removed ${featureName} from selection`;
                }
            }

            // Helper function to clear all selections
            function clearAllSelections() {
                console.log('Clearing all selections');
                
                // Remove all highlights
                highlightSelections.forEach(highlight => {
                    if (highlight && highlight.remove) {
                        try {
                            highlight.remove();
                        } catch (e) {
                            console.error('Error removing highlight:', e);
                        }
                    }
                });

                selectedFeatures = [];
                highlightSelections = [];
                
                // Clear PSAP layer highlights if available
                if (psapLayerView && psapLayerView.highlight) {
                    try {
                        psapLayerView.highlight();
                    } catch (e) {
                        console.error('Error clearing PSAP highlights:', e);
                    }
                }
                
                // Clear Canadian Towns layer highlights if available
                if (canadaTownsLayerView && canadaTownsLayerView.highlight) {
                    try {
                        canadaTownsLayerView.highlight();
                    } catch (e) {
                        console.error('Error clearing Canadian Towns highlights:', e);
                    }
                }
                
                updateSelectionPanel();
                updateStatus();
                
                // Update button state
                clearAllBtn.disabled = true;
                downloadBtn.disabled = true;
                downloadBtn.textContent = '📥 Download Selected (0)';
            }

            // Helper function to update status message
            function updateStatus() {
                if (selectedFeatures.length === 0) {
                    if (activeLayer === 'psap') {
                        status.textContent = 'Click to select PSAPs. Hold Ctrl/Cmd for multiple selection.';
                    } else {
                        status.textContent = 'Click to select Canadian towns. Hold Ctrl/Cmd for multiple selection.';
                    }
                } else {
                    if (activeLayer === 'psap') {
                        status.textContent = `${selectedFeatures.length} PSAP${selectedFeatures.length > 1 ? 's' : ''} selected. Use Ctrl/Cmd+click to add more.`;
                    } else {
                        status.textContent = `${selectedFeatures.length} town${selectedFeatures.length > 1 ? 's' : ''} selected. Use Ctrl/Cmd+click to add more.`;
                    }
                }
            }

            // Toggle selection panel
            panelToggle.addEventListener('click', function() {
                const content = document.querySelector('.panel-content');
                const footer = document.querySelector('.panel-footer');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    footer.style.display = 'block';
                    panelToggle.textContent = '−';
                } else {
                    content.style.display = 'none';
                    footer.style.display = 'none';
                    panelToggle.textContent = '+';
                }
            });

            // Clear all selections
            clearAllBtn.addEventListener('click', clearAllSelections);

            // Search functionality
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            searchButton.addEventListener('click', performSearch);
            
            // Handle clicks on search result buttons
            searchResults.addEventListener('click', function(e) {
                const zoomBtn = e.target.closest('.zoom-to-feature');
                const selectBtn = e.target.closest('.select-feature');
                
                if (!(zoomBtn || selectBtn)) return;
                
                e.stopPropagation();
                e.preventDefault();
                
                const featureItem = (zoomBtn || selectBtn).closest('.search-result-item');
                if (!featureItem || !featureItem.featureData) return;
                
                const featureData = featureItem.featureData;
                console.log('Search result clicked:', featureData);
                
                if (zoomBtn) {
                    // Zoom to the feature
                    try {
                        if (featureData.geometry) {
                            view.goTo({
                                target: featureData.geometry,
                                zoom: 12
                            });
                        } else if (featureData.extent) {
                            view.goTo({
                                target: featureData.extent,
                                zoom: 12
                            });
                        } else if (featureData.attributes && featureData.attributes.Shape) {
                            view.goTo({
                                target: featureData.attributes.Shape,
                                zoom: 12
                            });
                        }
                        // Don't hide results when just zooming
                        return;
                    } catch (error) {
                        console.error('Error zooming to feature:', error);
                    }
                }
                
                if (selectBtn) {
                    try {
                        // Make sure the feature has the required properties
                        const featureToSelect = {
                            attributes: featureData.attributes || {},
                            geometry: featureData.geometry,
                            layer: featureData.layerType === 'psap' ? psapLayer : canadaTownsLayer
                        };
                        
                        // Select the feature
                        selectFeature(featureToSelect);
                        
                        // Highlight the feature
                        try {
                            if (featureData.layerType === 'psap' && psapLayerView) {
                                const highlight = psapLayerView.highlight(featureToSelect);
                                highlightSelections.push(highlight);
                            } else if (featureData.layerType === 'canada' && canadaTownsLayerView) {
                                const highlight = canadaTownsLayerView.highlight(featureToSelect);
                                highlightSelections.push(highlight);
                            }
                        } catch (highlightError) {
                            console.error('Error highlighting feature:', highlightError);
                        }
                        
                        // Hide search results after selection
                        searchResults.style.display = 'none';
                        
                    } catch (error) {
                        console.error('Error selecting feature:', error);
                        status.textContent = 'Error selecting feature: ' + (error.message || 'Unknown error');
                    }
                }
            });
            
            function performSearch() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length < 2) return;
                
                // Clear previous search results
                searchResults.innerHTML = '';
                
                // Search only the currently focused layer
                if (activeLayer === 'psap') {
                    try {
                        if (!psapLayer) {
                            throw new Error('PSAP layer not initialized');
                        }
                        
                        // Ensure the layer is loaded
                        if (!psapLayer.loaded) {
                            console.log('PSAP layer not loaded yet, waiting...');
                            return psapLayer.load()
                                .then(() => {
                                    console.log('PSAP layer loaded, retrying search...');
                                    return performSearch(); // Retry the search now that the layer is loaded
                                });
                        }
                        
                        const psapQuery = psapLayer.createQuery();
                        psapQuery.where = `UPPER(psap_name) LIKE UPPER('%${searchTerm.replace(/'/g, "''")}%') OR UPPER(account_id) LIKE UPPER('%${searchTerm.replace(/'/g, "''")}%') OR UPPER(NAME) LIKE UPPER('%${searchTerm.replace(/'/g, "''")}%')`;
                        psapQuery.outFields = ["*"];
                        psapQuery.returnGeometry = true;
                        
                        console.log('Executing PSAP query with where clause:', psapQuery.where);
                        
                        return psapLayer.queryFeatures(psapQuery)
                            .then(psapResults => {
                                console.log('PSAP search results:', psapResults);
                                if (!psapResults || !psapResults.features || psapResults.features.length === 0) {
                                    searchResults.innerHTML = `
                                        <div class="search-result-item">
                                            No results found for "${searchTerm}" in PSAP layer
                                        </div>`;
                                    searchResults.style.display = 'block';
                                    return;
                                }
                                
                                // Process features to ensure they have the required structure
                                const processedFeatures = psapResults.features.map(feature => {
                                    // Ensure the feature has attributes
                                    if (!feature.attributes) {
                                        feature.attributes = {};
                                    }
                                    
                                    // Add layer information
                                    feature.layerType = 'psap';
                                    feature.layerName = 'PSAP';
                                    
                                    // Ensure we have a name attribute
                                    if (!feature.attributes.name && !feature.attributes.NAME && feature.attributes.psap_name) {
                                        feature.attributes.name = feature.attributes.psap_name;
                                    } else if (!feature.attributes.name && feature.attributes.NAME) {
                                        feature.attributes.name = feature.attributes.NAME;
                                    } else if (!feature.attributes.name && feature.attributes.account_id) {
                                        feature.attributes.name = feature.attributes.account_id;
                                    } else if (!feature.attributes.name) {
                                        feature.attributes.name = 'Unnamed PSAP';
                                    }
                                    
                                    return feature;
                                });
                                
                                console.log('Processed PSAP features:', processedFeatures);
                                displaySearchResults(processedFeatures);
                            });
                    } catch (error) {
                        console.error('Error in PSAP search:', error);
                        searchResults.innerHTML = `
                            <div class="search-result-item">
                                <strong>Error searching PSAPs:</strong><br>
                                ${error.message || 'Unknown error occurred'}
                            </div>`;
                        searchResults.style.display = 'block';
                    }
                } else {
                    // Canadian Towns search
                    try {
                        if (!canadaTownsLayer) {
                            throw new Error('Canadian Towns layer not initialized');
                        }

                        // Ensure the layer is loaded
                        if (!canadaTownsLayer.loaded) {
                            console.log('Canadian Towns layer not loaded yet, waiting...');
                            return canadaTownsLayer.load()
                                .then(() => {
                                    console.log('Canadian Towns layer loaded, retrying search...');
                                    return performSearch();
                                });
                        }

                        console.log('Searching Canadian Towns layer for:', searchTerm);
                        
                        // Create query specifically for CSDNAME field
                        const canadaQuery = canadaTownsLayer.createQuery();
                        
                        // Search only in the CSDNAME field
                        canadaQuery.where = `UPPER(CSDNAME) LIKE UPPER('%${searchTerm.replace(/'/g, "''")}%')`;
                        canadaQuery.outFields = ["*", "CSDNAME"];
                        canadaQuery.returnGeometry = true;
                        canadaQuery.returnDistinctValues = true;
                        
                        console.log('Executing Canadian Towns query on CSDNAME field:', searchTerm);
                        
                        return canadaTownsLayer.queryFeatures(canadaQuery)
                            .then(canadaResults => {
                                console.log('Canadian Towns search results:', canadaResults);
                                if (!canadaResults || !canadaResults.features || canadaResults.features.length === 0) {
                                    searchResults.innerHTML = `
                                        <div class="search-result-item">
                                            No results found for "${searchTerm}" in Canadian Towns layer
                                        </div>`;
                                    searchResults.style.display = 'block';
                                    return;
                                }
                                
                                // Process features to ensure they have the required structure
                                const processedFeatures = canadaResults.features.map(feature => {
                                    // Ensure the feature has attributes
                                    if (!feature.attributes) {
                                        feature.attributes = {};
                                    }
                                    
                                    // Add layer information
                                    feature.layerType = 'canada';
                                    feature.layerName = 'Canadian Town';
                                    
                                    // Find a suitable name field
                                    const nameField = Object.keys(feature.attributes).find(key => 
                                        /(name|town|city|municipal|nom|ville|community|place)/i.test(key)
                                    );
                                    
                                    // Set a name if we don't have one
                                    if (!feature.attributes.name && nameField) {
                                        feature.attributes.name = feature.attributes[nameField];
                                    } else if (!feature.attributes.name) {
                                        feature.attributes.name = 'Unnamed Location';
                                    }
                                    
                                    return feature;
                                });
                                
                                console.log('Processed Canadian features:', processedFeatures);
                                displaySearchResults(processedFeatures);
                            });
                    } catch (error) {
                        console.error('Error in Canadian Towns search:', error);
                        searchResults.innerHTML = `
                            <div class="search-result-item">
                                <strong>Error searching Canadian Towns:</strong><br>
                                ${error.message || 'Unknown error occurred'}
                            </div>`;
                        searchResults.style.display = 'block';
                        throw error; // Re-throw to be caught by the outer catch
                    }
                }
            }
            
            // Update the layer switch button text
            function updateLayerSwitchText() {
                const button = document.getElementById('layerSwitchBtn');
                if (button) {
                    button.textContent = activeLayer === 'psap' ? 'Focus: PSAP' : 'Focus: Canadian Towns';
                }
            }
            
            // Toggle between PSAP and Canadian Towns layers
            function toggleActiveLayer() {
                try {
                    // Toggle the active layer
                    activeLayer = activeLayer === 'psap' ? 'canada' : 'psap';
                    console.log('Toggling active layer to:', activeLayer);
                    
                    // Ensure both layers are visible but adjust opacity to show which is active
                    if (psapLayer) {
                        psapLayer.visible = true;
                        psapLayer.opacity = activeLayer === 'psap' ? 1 : 0.5;
                        console.log('PSAP layer - visible:', psapLayer.visible, 'opacity:', psapLayer.opacity);
                    }
                    
                    if (canadaTownsLayer) {
                        canadaTownsLayer.visible = true;
                        canadaTownsLayer.opacity = activeLayer === 'canada' ? 1 : 0.5;
                        console.log('Canada Towns layer - visible:', canadaTownsLayer.visible, 'opacity:', canadaTownsLayer.opacity);
                    }
                    
                    // No need to re-initialize popups as both layers are now always visible
                    
                    // Update the button text
                    updateLayerSwitchText();
                    
                    // Update the map view to show the active layer's extent if available
                    if (activeLayer === 'psap' && psapLayer) {
                        zoomToLayerExtent(psapLayer);
                    } else if (activeLayer === 'canada' && canadaTownsLayer) {
                        zoomToLayerExtent(canadaTownsLayer);
                    }
                    
                    // Clear any existing search results when switching layers
                    if (searchResults) {
                        searchResults.innerHTML = '';
                        searchResults.style.display = 'none';
                    }
                    
                    // Update status to show which layer is active
                    if (status) {
                        if (activeLayer === 'psap') {
                            status.textContent = 'PSAP layer active. Click on a PSAP to select it.';
                        } else {
                            status.textContent = 'Canadian Towns layer active. Click on a town to select it.';
                        }
                    }
                    
                    // Clear any existing highlights when switching layers
                    if (psapLayerView) {
                        psapLayerView.highlightRemoveAll();
                    }
                    if (canadaTownsLayerView) {
                        canadaTownsLayerView.highlightRemoveAll();
                    }
                    
                    // Clear the selection panel when switching layers
                    selectedFeatures = [];
                    if (updateSelectionPanel) updateSelectionPanel();
                    if (updateStatus) updateStatus();
                    
                    console.log('Switched to', activeLayer === 'psap' ? 'PSAP' : 'Canadian Towns', 'layer');
                    
                } catch (error) {
                    console.error('Error in toggleActiveLayer:', error);
                    if (status) {
                        status.textContent = 'Error switching layers. Please try again.';
                        setTimeout(() => { status.textContent = ''; }, 3000);
                    }
                }
            }
            
            // Initialize layer switch button
            const layerSwitchBtn = document.getElementById('layerSwitchBtn');
            if (layerSwitchBtn) {
                // Remove any existing event listeners to prevent duplicates
                const newBtn = layerSwitchBtn.cloneNode(true);
                layerSwitchBtn.parentNode.replaceChild(newBtn, layerSwitchBtn);
                newBtn.addEventListener('click', toggleActiveLayer);
                
                // Set initial button text
                updateLayerSwitchText();
            } else {
                console.error('Layer switch button not found');
            }
            
            function displaySearchResults(features) {
                console.log('Displaying search results:', features);
                searchResults.innerHTML = '';
                
                if (features.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                const resultsCount = document.createElement('div');
                resultsCount.className = 'search-result-count';
                resultsCount.textContent = `Found ${features.length} result${features.length !== 1 ? 's' : ''}`;
                searchResults.appendChild(resultsCount);
                
                // Group results by layer type
                const resultsByLayer = {
                    psap: features.filter(f => f.layerType === 'psap' || f.layer?.id === 'psap-layer'),
                    canada: features.filter(f => f.layerType === 'canada' || f.layer?.id === 'canada-towns')
                };
                
                // Display PSAP results
                if (resultsByLayer.psap.length > 0) {
                    const header = document.createElement('div');
                    header.className = 'search-result-header';
                    header.textContent = `US PSAPs (${resultsByLayer.psap.length})`;
                    searchResults.appendChild(header);
                    
                    resultsByLayer.psap.forEach((feature, index) => {
                        const item = createSearchResultItem(feature, 'psap');
                        if (item) {
                            searchResults.appendChild(item);
                        } else {
                            console.error('Failed to create search result item for PSAP feature:', feature);
                        }
                    });
                }
                
                // Display Canadian Towns results
                if (resultsByLayer.canada.length > 0) {
                    const header = document.createElement('div');
                    header.className = 'search-result-header';
                    header.textContent = `Canadian Towns (${resultsByLayer.canada.length})`;
                    searchResults.appendChild(header);
                    
                    resultsByLayer.canada.forEach((feature, index) => {
                        const item = createSearchResultItem(feature, 'canada');
                        if (item) {
                            searchResults.appendChild(item);
                        } else {
                            console.error('Failed to create search result item for Canada feature:', feature);
                        }
                    });
                }
                
                searchResults.style.display = 'block';
                
                function createSearchResultItem(feature, layerType) {
                    try {
                        console.log('Creating search result item:', feature, 'Layer type:', layerType);
                        
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        
                        // Ensure feature has attributes and geometry
                        if (!feature.attributes) {
                            feature.attributes = {};
                        }
                        
                        // Get the feature's attributes with a fallback to empty object
                        const attrs = feature.attributes || {};
                        
                        // Get the display name
                        let displayName = 'Unnamed Feature';
                        if (attrs.name) {
                            displayName = attrs.name;
                        } else if (attrs.NAME) {
                            displayName = attrs.NAME;
                        } else if (attrs.psap_name) {
                            displayName = attrs.psap_name;
                        } else if (attrs.account_id) {
                            displayName = attrs.account_id;
                        } else if (attrs.town) {
                            displayName = attrs.town;
                        } else if (attrs.city) {
                            displayName = attrs.city;
                        } else if (attrs.municipality) {
                            displayName = attrs.municipality;
                        } else if (attrs.community) {
                            displayName = attrs.community;
                        } else if (attrs.place_name) {
                            displayName = attrs.place_name;
                        }
                        
                        // Create a more informative display with available attributes
                        let details = '';
                        const excludeFields = ['shape', 'objectid', 'globalid', 'geometry', 'name', 'NAME', 'psap_name', 'account_id'];
                        
                        if (attrs) {
                            Object.entries(attrs).forEach(([key, value]) => {
                                // Skip if value is empty or key is in exclude list
                                if (!value || 
                                    excludeFields.some(field => key.toLowerCase().includes(field.toLowerCase()))) {
                                    return;
                                }
                                
                                // Format the value for display
                                let displayValue = value;
                                if (typeof value === 'object') {
                                    displayValue = JSON.stringify(value);
                                } else if (typeof value === 'boolean') {
                                    displayValue = value ? 'Yes' : 'No';
                                } else if (typeof value === 'number') {
                                    // Format numbers with commas for better readability
                                    displayValue = value.toLocaleString();
                                }
                                
                                details += `<div class="search-result-detail"><strong>${key}:</strong> ${displayValue}</div>`;
                            });
                        }
                        
                        // Create a unique ID for this feature
                        const featureId = attrs.OBJECTID || attrs.objectid || attrs.id || 
                                       feature.OBJECTID || feature.objectid || feature.id || 
                                       Math.random().toString(36).substr(2, 9);
                        
                        // Store the feature data on the item element
                        item.dataset.featureId = featureId;
                        item.featureData = feature;
                        
                        // Set the HTML content for the search result item
                        item.innerHTML = `
                            <div class="search-result-header">
                                <span class="search-result-title">${displayName}</span>
                                <span class="search-result-type">${layerType === 'psap' ? 'PSAP' : 'Canadian Town'}</span>
                            </div>
                            <div class="search-result-details">
                                ${details || '<div class="no-details">No additional details available</div>'}
                            </div>
                            <div class="search-result-actions">
                                <button class="btn btn-sm btn-primary zoom-to-feature" data-feature-id="${featureId}">
                                    <i class="fas fa-search-location"></i> Zoom to
                                </button>
                                <button class="btn btn-sm btn-success select-feature" data-feature-id="${featureId}">
                                    <i class="fas fa-check"></i> Select
                                </button>
                            </div>
                        `;
                        
                        // Add click handler for the zoom button
                        const zoomBtn = item.querySelector('.zoom-to-feature');
                        if (zoomBtn) {
                            zoomBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                zoomToFeature(feature);
                            });
                        }
                        
                        // Add click handler for the select button
                        const selectBtn = item.querySelector('.select-feature');
                        if (selectBtn) {
                            selectBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                selectFeature(feature);
                            });
                        }
                        
                        return item;
                    } catch (error) {
                        console.error('Error creating search result item:', error);
                        const errorItem = document.createElement('div');
                        errorItem.className = 'search-result-item';
                        errorItem.innerHTML = `
                            <div class="search-result-header">
                                <span class="search-result-title">Error displaying feature</span>
                            </div>
                            <div class="search-result-details">
                                <div class="no-details">${error.message || 'Unknown error occurred'}</div>
                            </div>
                        `;
                        return errorItem;
                    }
                }
                
                // Helper function to zoom to a feature
                function zoomToFeature(feature) {
                    if (!feature || !feature.geometry) return;
                    
                    // Get the geometry's extent
                    const geometryExtent = feature.geometry.extent || 
                                        (feature.geometry.getExtent ? feature.geometry.getExtent() : null);
                    
                    if (geometryExtent) {
                        // Zoom to the feature's extent with some padding
                        view.goTo({
                            target: geometryExtent,
                            padding: 50 // Add some padding around the feature
                        });
                    } else if (feature.geometry.type === 'point' || 
                              feature.geometry.type === 'multipoint') {
                        // For point features, zoom to a fixed level
                        view.goTo({
                            target: feature.geometry,
                            zoom: 12
                        });
                    } else {
                        // For other geometry types, try to fit to the geometry
                        view.goTo({
                            target: feature.geometry
                        });
                    }
                }
            }
            
            // Hide search results when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    searchResults.style.display = 'none';
                }
            });

            // Select a feature programmatically (used by search)
            function selectFeature(feature) {
                console.log('selectFeature called with:', feature);
                
                if (!multiSelectMode && selectedFeatures.length > 0) {
                    clearAllSelections();
                }
                
                // Check if already selected using a more robust comparison
                const existingIndex = selectedFeatures.findIndex(f => {
                    // If features have OBJECTID, compare those
                    if (f.attributes && feature.attributes && 
                        f.attributes.OBJECTID !== undefined && 
                        feature.attributes.OBJECTID !== undefined) {
                        return f.attributes.OBJECTID === feature.attributes.OBJECTID;
                    }
                    // If features have objectid, compare those
                    if (f.attributes && feature.attributes && 
                        f.attributes.objectid !== undefined && 
                        feature.attributes.objectid !== undefined) {
                        return f.attributes.objectid === feature.attributes.objectid;
                    }
                    // If features have a geometry, compare the geometry
                    if (f.geometry && feature.geometry) {
                        return f.geometry === feature.geometry;
                    }
                    // Fallback to strict equality
                    return f === feature;
                });
                
                if (existingIndex >= 0) {
                    console.log('Feature already selected');
                    return;
                }
                
                try {
                    // Add to selection
                    selectedFeatures.push(feature);
                    console.log('Added feature to selection. Total selected:', selectedFeatures.length);
                    
                    // Update the UI
                    updateSelectionPanel();
                    updateStatus();
                    
                    // Enable the download and clear buttons
                    downloadBtn.disabled = false;
                    clearAllBtn.disabled = false;
                    
                } catch (error) {
                    console.error('Error in selectFeature:', error);
                    status.textContent = 'Error selecting feature: ' + (error.message || 'Unknown error');
                }
            }
            
            // Hide tooltip when leaving map area
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
            });
            
            // Show tooltip with feature name on hover for both layers
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    // Check for PSAP layer feature
                    const psapResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    // Check for Canada Towns layer feature
                    const canadaResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === canadaTownsLayer
                    );
                    
                    // First try the focused layer, then the other
                    let hoverResult = null;
                    if (activeLayer === 'psap') {
                        hoverResult = psapResult || canadaResult;
                    } else {
                        hoverResult = canadaResult || psapResult;
                    }
                    
                    // Show tooltip if we found a feature
                    if (hoverResult) {
                        const feature = hoverResult.graphic;
                        let featureName = '';
                        
                        // Determine which layer the feature belongs to and create appropriate tooltip content
                        if (feature.layer === psapLayer) {
                            // For PSAP layer, get the PSAP name and format tooltip
                            featureName = getPsapName(feature.attributes);
                            tooltip.innerHTML = `<strong>${featureName}</strong>`;
                            
                            // Add additional PSAP info if available
                            if (feature.attributes.state) {
                                tooltip.innerHTML += `<br>State: ${feature.attributes.state}`;
                            }
                        } else {
                            // For Canadian Towns layer, get town name and format tooltip with more details
                            featureName = getTownName(feature.attributes);
                            tooltip.innerHTML = `<strong>${featureName}</strong>`;
                            
                            // Add additional town info if available
                            const attrs = feature.attributes;
                            if (attrs.PROVINCE) {
                                tooltip.innerHTML += `<br>Province: ${attrs.PROVINCE}`;
                            }
                            if (attrs.POPULATION) {
                                tooltip.innerHTML += `<br>Population: ${attrs.POPULATION.toLocaleString()}`;
                            }
                        }
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${event.x + 10}px`;
                        tooltip.style.top = `${event.y + 10}px`;
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
            });
            
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
            });

            // Download as GeoJSON
            downloadBtn.addEventListener('click', async function() {
                if (selectedFeatures.length === 0) return;
                
                try {
                    status.textContent = 'Preparing download...';
                    
                    // Process each selected feature
                    const features = await Promise.all(selectedFeatures.map(async feature => {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(feature.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                ...feature.attributes,
                                // Add metadata about projection
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    original_crs: feature.geometry.spatialReference ? 
                                        `EPSG:${feature.geometry.spatialReference.wkid}` : 'Unknown',
                                    target_crs: 'EPSG:4326',
                                    target_crs_name: 'WGS 84'
                                }
                            }
                        };
                    }));
                    
                    // Create GeoJSON object
                    const geoJSON = {
                        type: "FeatureCollection",
                        crs: {
                            type: "name",
                            properties: {
                                name: "urn:ogc:def:crs:EPSG::4326"
                            }
                        },
                        metadata: {
                            exported_by: "RapidSOS PSAP Map",
                            export_date: new Date().toISOString(),
                            feature_count: features.length
                        },
                        features: features
                    };
                    
                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `psap_boundaries_${selectedFeatures.length}_polygons_WGS84_${timestamp}.geojson`;
                    
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    if (activeLayer === 'psap') {
                        status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                    } else if (activeLayer === 'canada') {
                        status.textContent = `Downloaded ${selectedFeatures.length} Canada Towns polygons in WGS84 format`;
                    } else {
                        status.textContent = `Downloaded ${selectedFeatures.length} features in WGS84 format`;
                    }
                } catch (error) {
                    console.error('Error downloading GeoJSON:', error);
                    status.textContent = 'Error preparing download';
                }
            });

            // Helper function to convert ESRI geometry to GeoJSON with projection
            async function convertEsriGeometryToGeoJSON(geometry) {
                try {
                    // Create target spatial reference (WGS84 / EPSG:4326)
                    const wgs84 = new SpatialReference({ wkid: 4326 });

                    let projectedGeometry = geometry;

                    // Check if geometry needs projection
                    if (geometry.spatialReference && geometry.spatialReference.wkid !== 4326) {
                        console.log(`Projecting from EPSG:${geometry.spatialReference.wkid} to EPSG:4326`);

                        // Load projection engine if not already loaded
                        await projection.load();

                        // Project geometry to WGS84
                        projectedGeometry = projection.project(geometry, wgs84);
                    }

                    // Convert to GeoJSON coordinate format
                    if (projectedGeometry.rings) {
                        // Polygon geometry
                        return projectedGeometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }

                    return [];
                } catch (error) {
                    console.error('Error converting geometry coordinates:', error);
                    console.log('Falling back to original coordinates');

                    // Fallback to original method if projection fails
                    if (geometry.rings) {
                        return geometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }
                    return [];
                }
            }

            // Set up the sketch widget for polygon drawing
            function setupDrawTools() {
                // Create the sketch widget for drawing polygons
                sketch = new Sketch({
                    layer: drawLayer,
                    view: view,
                    creationMode: "update",
                    availableCreateTools: ["polygon"], // Only allow polygon creation
                    defaultCreateOptions: {
                        mode: "click" // Default to click-by-click polygon creation
                    },
                    visibleElements: {
                        createTools: {
                            point: false,
                            polyline: false,
                            polygon: true,
                            rectangle: false,
                            circle: false
                        },
                        selectionTools: {
                            "lasso-selection": false,
                            "rectangle-selection": false
                        },
                        undoRedoMenu: true,
                        settingsMenu: false
                    }
                });
                
                // Track drawing state
                sketch.on(["create", "update", "delete"], function(event) {
                    if (event.state === "complete") {
                        // Show download button when drawing is complete
                        if (drawLayer.graphics.length > 0) {
                            downloadDrawnBtn.style.display = "block";
                            status.textContent = "Polygon drawn! You can now download it or continue editing.";
                        } else {
                            downloadDrawnBtn.style.display = "none";
                        }
                    }
                });
                
                return sketch;
            }
            
            // Toggle drawing mode
            function toggleDrawingMode() {
                drawingMode = !drawingMode;
                
                if (drawingMode) {
                    // Activate drawing mode
                    if (!sketch) {
                        sketch = setupDrawTools();
                    }
                    view.ui.add(sketch, { position: "bottom-right" });
                    drawPolygonBtn.textContent = "✏️ Exit Drawing Mode";
                    drawPolygonBtn.classList.add("active");
                    status.textContent = "Drawing mode active. Click to create polygon vertices, double-click to complete.";
                } else {
                    // Deactivate drawing mode
                    if (sketch) {
                        view.ui.remove(sketch);
                    }
                    drawPolygonBtn.textContent = "✏️ Draw Polygon";
                    drawPolygonBtn.classList.remove("active");
                    status.textContent = "Drawing mode exited.";
                }
            }
            
            // Get a reference to the layer view for highlighting
            view.whenLayerView(psapLayer).then(function(layerView) {
                psapLayerView = layerView;
                console.log("Layer view created for highlighting");
            });

            // Function to download drawn polygons as GeoJSON
            async function downloadDrawnPolygons() {
                // Get all graphics from the draw layer
                const graphics = drawLayer.graphics.toArray();
                
                if (graphics.length === 0) {
                    alert("No polygons drawn! Draw a polygon first.");
                    return;
                }
                
                try {
                    status.textContent = 'Preparing download of drawn polygon...';
                    
                    // Process each drawn graphic
                    const features = await Promise.all(graphics.map(async function(graphic, index) {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(graphic.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                id: index + 1,
                                name: `User Drawn Polygon ${index + 1}`,
                                drawn_date: new Date().toISOString(),
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    source: "User Drawing",
                                    target_crs: "EPSG:4326",
                                    target_crs_name: "WGS 84"
                                }
                            }
                        };
                    }));
                    
                    // Create GeoJSON object
                    const geoJSON = {
                        type: "FeatureCollection",
                        crs: {
                            type: "name",
                            properties: {
                                name: "urn:ogc:def:crs:EPSG::4326"
                            }
                        },
                        metadata: {
                            exported_by: "RapidSOS PSAP Map - Drawing Tool",
                            export_date: new Date().toISOString(),
                            feature_count: features.length
                        },
                        features: features
                    };
                    
                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `user_drawn_polygons_${timestamp}.geojson`;
                    
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    status.textContent = `Downloaded ${drawnPolygons.length} drawn polygon(s) as GeoJSON`;
                } catch (error) {
                    console.error('Error downloading drawn polygons:', error);
                    alert('Error downloading drawn polygons. Please try again.');
                    status.textContent = 'Error during download';
                }
            }
            
            // Multi-select is now the default behavior, so no toggle function needed
            
            function downloadSelected() {
                if (selectedFeatures.length === 0) return;
                
                try {
                    status.textContent = 'Preparing download...';
                    
                    // Process each selected feature
                    Promise.all(selectedFeatures.map(async feature => {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(feature.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                ...feature.attributes,
                                // Add metadata about projection
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    original_crs: feature.geometry.spatialReference ? 
                                        `EPSG:${feature.geometry.spatialReference.wkid}` : 'Unknown',
                                    target_crs: 'EPSG:4326',
                                    target_crs_name: 'WGS 84'
                                }
                            }
                        };
                    })).then(features => {
                        // Create GeoJSON object
                        const geoJSON = {
                            type: "FeatureCollection",
                            crs: {
                                type: "name",
                                properties: {
                                    name: "urn:ogc:def:crs:EPSG::4326"
                                }
                            },
                            metadata: {
                                exported_by: "RapidSOS PSAP Map",
                                export_date: new Date().toISOString(),
                                feature_count: features.length
                            },
                            features: features
                        };
                        
                        // Convert to JSON string and download
                        const json = JSON.stringify(geoJSON, null, 2);
                        const blob = new Blob([json], {type: "application/json"});
                        const url = URL.createObjectURL(blob);
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = `${activeLayer === 'psap' ? 'psap' : 'canada_towns'}_export_${new Date().toISOString().slice(0,10)}.geojson`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(url);
                        
                        if (activeLayer === 'psap') {
                            status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                        } else {
                            status.textContent = `Downloaded ${selectedFeatures.length} Canadian Towns in WGS84 format`;
                        }
                    }).catch(error => {
                        console.error('Error downloading GeoJSON:', error);
                        alert('Error preparing download. Please try again.');
                        status.textContent = 'Error during download';
                    });
                    
                } catch (error) {
                    console.error('Error downloading GeoJSON:', error);
                    alert('Error downloading GeoJSON. Please try again.');
                    status.textContent = 'Error during download';
                }
            }
            
            // Attach event handlers to buttons
            // Make sure clearAllBtn event listener is properly attached
            clearAllBtn.addEventListener('click', clearAllSelections);
            downloadBtn.addEventListener('click', downloadSelected);
            drawPolygonBtn.addEventListener('click', toggleDrawingMode);
            downloadDrawnBtn.addEventListener('click', downloadDrawnPolygons);
            
            // Multi-select button functionality
            multiSelectBtn.addEventListener('click', function() {
                multiSelectMode = !multiSelectMode;
                multiSelectBtn.textContent = multiSelectMode ? '🔘 Multi-Select: ON' : '🔘 Multi-Select: OFF';
                status.textContent = multiSelectMode ? 'Multi-select mode activated. Click on multiple features to select them.' : 'Multi-select mode deactivated. Click on a feature to select it.';
            });
            
            // Function to switch between PSAP and Canadian Towns layers
            // Now just changes visual focus but both layers remain selectable
            function switchActiveLayer() {
                // This function is now a wrapper for toggleActiveLayer for backward compatibility
                toggleActiveLayer();
            }
            
            // Area selection functionality
            function handleAreaSelection() {
                // Check if user has made a selection before (stored in localStorage)
                if (localStorage.getItem('psapMapAreaSelected') === 'true') {
                    console.log('Area already selected previously, not showing modal');
                    return; // Skip showing the modal entirely
                }
                
                // Show the modal only ONCE
                console.log('Showing area selection modal');
                areaSelectionModal.style.display = 'block';
                
                // Set up the area selection function to permanently mark selection as made
                selectUSBtn.addEventListener('click', function() {
                    // Mark selection as made
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('us');
                });
                
                selectCanadaBtn.addEventListener('click', function() {
                    // Mark selection as made
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('canada');
                });
                
                selectDefaultBtn.addEventListener('click', function() {
                    // Mark selection as made
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('default');
                });
            }
            
            // Show tutorial on first visit or when help button is clicked
            const tutorialOverlay = document.getElementById('tutorial-overlay');
            const helpButton = document.getElementById('helpButton');
            const tutorialClose = document.querySelector('.tutorial-close');
            const tutorialGotIt = document.getElementById('tutorialGotIt');
            const dontShowAgain = document.getElementById('dontShowAgain');
            
            // Check if user has seen the tutorial before
            const hasSeenTutorial = localStorage.getItem('hasSeenPSAPMapTutorial');
            
            function showTutorial() {
                tutorialOverlay.style.visibility = 'visible';
                tutorialOverlay.style.opacity = '1';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
            }
            
            function hideTutorial() {
                tutorialOverlay.style.opacity = '0';
                setTimeout(() => {
                    tutorialOverlay.style.visibility = 'hidden';
                    document.body.style.overflow = ''; // Re-enable scrolling
                }, 300);
            }
            
            // Event listeners for tutorial controls
            helpButton.addEventListener('click', showTutorial);
            tutorialClose.addEventListener('click', hideTutorial);
            tutorialGotIt.addEventListener('click', hideTutorial);
            
            dontShowAgain.addEventListener('click', function() {
                localStorage.setItem('hasSeenPSAPMapTutorial', 'true');
                hideTutorial();
            });
            
            // Show tutorial on first visit
            if (!hasSeenTutorial) {
                // Wait for map to load
                setTimeout(() => {
                    showTutorial();
                }, 2000);
            }

            // Call the function ONE time at startup
            window.addEventListener('load', function() {
                // Wait for the map to be fully loaded
                setTimeout(handleAreaSelection, 1500);
            });
            
            // Add click handler for feature selection from both layers
            view.on("click", function(event) {
                // Don't process clicks if drawing mode is active
                if (sketch) {
                    return;
                }
                
                // Get the screen point for hit testing
                const screenPoint = {
                    x: event.x,
                    y: event.y
                };
                
                // Perform hit test to see if user clicked on a feature
                view.hitTest(screenPoint).then(function(response) {
                    // Check both layers for features, not just the active one
                    // First check for PSAP features
                    const psapFeature = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    // Then check for Canadian Towns features
                    const canadaFeature = response.results.find(result => 
                        result.graphic && result.graphic.layer === canadaTownsLayer
                    );
                    
                    // First try the active layer, then fall back to the other layer
                    let clickedFeature = null;
                    if (activeLayer === 'psap') {
                        clickedFeature = psapFeature || canadaFeature;
                    } else {
                        clickedFeature = canadaFeature || psapFeature;
                    }
                    
                    if (clickedFeature) {
                        const feature = clickedFeature.graphic;
                        console.log('Clicked feature:', feature);
                        
                        // Check for multi-select: either explicit multi-select mode OR modifier keys
                        const isModifierPressed = event.native.ctrlKey || 
                                              event.native.metaKey || 
                                              event.native.shiftKey;
                        
                        const shouldMultiSelect = multiSelectMode || isModifierPressed;
                        console.log('Selection debug:', {
                            multiSelectMode, 
                            isModifierPressed, 
                            shouldMultiSelect, 
                            currentSelectionCount: selectedFeatures.length
                        });
                        
                        // Get feature ID for consistent comparison
                        const featureId = feature.attributes.OBJECTID || feature.attributes.FID;
                        
                        // Check if this feature is already selected
                        const existingIndex = selectedFeatures.findIndex(f => 
                            (f.attributes.OBJECTID === featureId) || (f.attributes.FID === featureId)
                        );
                        
                        if (existingIndex >= 0) {
                            // Feature already selected - remove it (toggle behavior)
                            // Get feature properties for status message
                            const isPsapFeature = feature.layer === psapLayer;
                            const featureName = isPsapFeature ? 
                                getPsapName(feature.attributes) : 
                                getTownName(feature.attributes);
                            
                            // Remove the highlight
                            if (highlightSelections[existingIndex] && highlightSelections[existingIndex].remove) {
                                highlightSelections[existingIndex].remove();
                            }
                            
                            // Remove from arrays
                            selectedFeatures.splice(existingIndex, 1);
                            highlightSelections.splice(existingIndex, 1);
                            
                            // Update UI
                            updateSelectionPanel();
                            status.textContent = `Removed ${featureName} from selection`;
                        } else {
                            // New selection
                            if (!shouldMultiSelect && selectedFeatures.length > 0) {
                                // Single select mode and we have existing selections - clear them first
                                console.log('Clearing previous selections for single select');
                                clearAllSelections();
                            }
                            
                            // Add new selection
                            selectedFeatures.push(feature);
                            console.log('Added feature, total selections:', selectedFeatures.length);
                            
                            // Highlight selected feature based on which layer it belongs to
                            const isPsapFeature = feature.layer === psapLayer;
                            
                            if (isPsapFeature && psapLayerView) {
                                const highlight = psapLayerView.highlight(feature);
                                highlightSelections.push(highlight);
                                const psapName = getPsapName(feature.attributes);
                                status.textContent = `Added ${psapName} to selection (${selectedFeatures.length} total)`;
                            } else if (!isPsapFeature && canadaTownsLayerView) {
                                const highlight = canadaTownsLayerView.highlight(feature);
                                highlightSelections.push(highlight);
                                const townName = getTownName(feature.attributes);
                                status.textContent = `Added ${townName} to selection (${selectedFeatures.length} total)`;
                            }
                            
                            // Update selection panel
                            updateSelectionPanel();
                        }
                    } else {
                        // Clicked on empty area
                        if (!multiSelectMode && !event.native.ctrlKey && !event.native.metaKey && selectedFeatures.length > 0) {
                            // In single-select mode, clear selections when clicking on empty space
                            // (this matches the behavior in the Canada app)
                            clearAllSelections();
                        }
                    }
                });
            });
            
            // Set initial visibility - both layers visible
            psapLayer.visible = true;
            canadaTownsLayer.visible = true;
            
            // Create layer views for both layers
            view.whenLayerView(psapLayer).then(function(layerView) {
                psapLayerView = layerView;
                console.log("Layer view created for highlighting");
                
                // Highlight any selected features
                highlightSelectedFeatures();
            });
            
            view.whenLayerView(canadaTownsLayer).then(function(layerView) {
                canadaTownsLayerView = layerView;
                console.log("Canada Towns layer view created");
            });
            
            // Area selection modal functionality
            const areaSelectionModal = document.getElementById('areaSelectionModal');
            const selectUSBtn = document.getElementById('selectUSBtn');
            const selectCanadaBtn = document.getElementById('selectCanadaBtn');
            const selectDefaultBtn = document.getElementById('selectDefaultBtn');
            
            // Function to handle area selection
            function selectArea(area) {
                console.log(`Selected area: ${area}`);
                
                // Close the modal
                areaSelectionModal.style.display = 'none';
                
                // Set the appropriate layer as active based on selection
                if (area === 'canada') {
                    activeLayer = 'canada';
                    psapLayer.opacity = 0.3;
                    canadaTownsLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: Canadian Towns';
                    
                    // Zoom to Canada
                    view.goTo({
                        target: {
                            xmin: -141.0,
                            ymin: 41.0,
                            xmax: -52.0,
                            ymax: 83.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    // Update placeholder text for search input
                    searchInput.placeholder = 'Search for a town...';
                    
                } else {
                    // Default to US/other
                    activeLayer = 'psap';
                    canadaTownsLayer.opacity = 0.3;
                    psapLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: US PSAPs';
                    
                    // Zoom to US
                    view.goTo({
                        target: {
                            xmin: -125.0,
                            ymin: 24.0,
                            xmax: -66.0,
                            ymax: 49.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    // Update placeholder text for search input
                    searchInput.placeholder = 'Search for a PSAP...';
                }
            }
            
            // Event listeners for area selection buttons
            selectUSBtn.addEventListener('click', function() {
                selectArea('us');
            });
            
            selectCanadaBtn.addEventListener('click', function() {
                selectArea('canada');
            });
            
            selectDefaultBtn.addEventListener('click', function() {
                selectArea('other');
            });
            
            // Wait for layer to load and zoom to extent
            psapLayer.when(function() {
                console.log("PSAP layer loaded successfully");
                status.textContent = "PSAP data loaded! Click to select boundaries or use Draw Polygon tool.";

                // Zoom to continental US for better default view
                view.goTo({
                    target: {
                        xmin: -125.0,
                        ymin: 24.0,
                        xmax: -66.0,
                        ymax: 49.0,
                        spatialReference: { wkid: 4326 }
                    },
                    padding: { left: 20, right: 20, top: 20, bottom: 20 }
                });

                // Initialize UI
                updateStatus();
            }).catch(function(error) {
                console.error("Error loading layer:", error);
                status.textContent = 'Error loading PSAP layer';
            });
        });
    </script>
</body>
</html>
