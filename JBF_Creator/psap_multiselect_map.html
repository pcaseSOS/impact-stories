<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PSAP Interactive Map</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        /* Tutorial Overlay Styles */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .tutorial-container {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .tutorial-header {
            background: var(--royal-blue);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tutorial-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .tutorial-content {
            padding: 20px;
        }
        
        .tutorial-step {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tutorial-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .tutorial-step h3 {
            color: var(--royal-blue);
            margin-top: 0;
        }
        
        .tutorial-step p {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .tutorial-step kbd {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.9em;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .tutorial-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .tutorial-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .tutorial-button.primary {
            background: var(--safety-blue);
            color: white;
        }
        
        .tutorial-button.secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .tutorial-step-number {
            display: inline-block;
            background: var(--safety-blue);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-weight: bold;
        }

        /* RapidSOS brand colors */
        :root {
            --royal-blue: #001559; /* Primary dark blue */
            --safety-blue: #29A8DD; /* Primary light blue */
            --white: #FFFFFF;
            --safety-gap: #FFF300; /* Yellow highlight */
            --glow: #005eFF; /* Bright blue highlight */
        }

        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        .toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar button {
            background: var(--royal-blue);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 180px;
            text-align: left;
        }

        .toolbar button:hover {
            background: var(--glow);
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .toolbar button.active {
            background: #28a745;
        }

        .toolbar button.danger {
            background: #dc3545;
        }

        .toolbar button.danger:hover {
            background: #c82333;
        }
        
        /* Help Button in Toolbar */
        #helpButton {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
        }
        
        #helpButton svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        #selectionPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .panel-header {
            background: var(--royal-blue);
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
        }

        .selected-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .selected-item:hover {
            background: #f8f9fa;
        }

        .selected-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .panel-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        /* Search bar styles */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .search-input-container {
            display: flex;
            width: 100%;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 2px solid var(--safety-blue);
            border-right: none;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
        }
        
        .search-button {
            background: var(--safety-blue);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        .search-results {
            width: 100%;
            background: white;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px 10px 30px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.2s ease;
            font-size: 14px;
            line-height: 1.4;
            background: white;
        }
        
        .search-result-item:hover {
            background-color: #e9f5ff;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .search-result-category {
            padding: 8px 12px;
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-result-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4e73df;
        }
        
        .search-result-item[data-type='canada']::before {
            background-color: #1cc88a;
        }
        
        .search-result-item .subtext {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* Area Selection Modal Styles */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }
        
        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            width: 400px;
            max-width: 80%;
            text-align: center;
        }
        
        .modal h2 {
            margin-top: 0;
            color: #333;
        }
        
        .modal p {
            margin-bottom: 20px;
            font-size: 16px;
            color: #555;
        }
        
        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .select-area-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background-color: #2b6da8;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .select-area-btn:hover {
            background-color: #3980bd;
            transform: translateY(-2px);
        }
        
        .select-area-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>

    
    <div id="viewDiv"></div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay">
        <div class="tutorial-container">
            <div class="tutorial-header">
                <h2>PSAP Map Tutorial</h2>
                <button class="tutorial-close">&times;</button>
            </div>
            <div class="tutorial-content">
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">1</span>Selecting Features</h3>
                    <p>Click on any PSAP or Canadian town to select it. Selected features will be highlighted.</p>
                    <p>To select multiple features:</p>
                    <ul>
                        <li>Hold <kbd>Ctrl</kbd> (Windows) or <kbd>⌘</kbd> (Mac) while clicking</li>
                        <li>Or enable <strong>Multi-Select Mode</strong> to select multiple features without holding keys</li>
                    </ul>
                </div>
                
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">2</span>Searching for Locations</h3>
                    <p>Use the search bar in the top-left to find specific PSAPs or Canadian towns.</p>
                    <p>Click on a search result to zoom to that location and select it.</p>
                </div>
                
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">3</span>Managing Selections</h3>
                    <p>View your selected features in the panel on the left. You can:</p>
                    <ul>
                        <li>Click the <strong>×</strong> next to an item to remove it</li>
                        <li>Click <strong>Clear All</strong> to remove all selections</li>
                        <li>Click <strong>Download Selected</strong> to export your selection as GeoJSON</li>
                    </ul>
                </div>
                
                <div class="tutorial-step">
                    <h3><span class="tutorial-step-number">4</span>Drawing Tools</h3>
                    <p>Use the drawing tools to create custom areas of interest:</p>
                    <ul>
                        <li>Click the <strong>Draw Polygon</strong> button to start drawing</li>
                        <li>Click to add points, double-click to complete the shape</li>
                        <li>Download your drawn areas using the download button</li>
                    </ul>
                </div>
                
                <div class="tutorial-buttons">
                    <button class="tutorial-button secondary" id="dontShowAgain">Don't Show Again</button>
                    <button class="tutorial-button primary" id="tutorialGotIt">Got it, thanks!</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-input-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for a PSAP...">
            <button class="search-button" id="searchButton">🔍</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Toolbar for multiselect and downloads -->
    <div class="toolbar" id="toolbar">
        <button id="layerSwitchBtn">Focus: US PSAPs</button>
        <button id="multiSelectBtn">🔘 Multi-Select: ON</button>
        <button id="drawPolygonBtn">✏️ Draw Polygon</button>
        <button id="downloadBtn" disabled>📥 Download Selected (0)</button>
        <button id="downloadDrawnBtn" style="display:none;">📥 Download Drawn Polygon</button>
        <button id="clearAllBtn" disabled class="danger">❌ Clear Selection</button>
        <button id="helpButton" title="Map Instructions">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="16"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>Map Instructions</span>
        </button>
    </div>
    
    <!-- Selection Panel -->
    <div id="selectionPanel">
        <div class="panel-header">
            <span id="selectionHeaderText">Selected Features</span> (<span id="selectionCount">0</span>)
            <span id="panelToggle" style="cursor: pointer;">−</span>
        </div>
        <div class="panel-content" id="selectionList">
            <!-- Selected items will be populated here -->
        </div>
        <div class="panel-footer">
            Multiple selection is enabled by default. Hold Ctrl/Cmd + click to add more.
        </div>
    </div>

    <div id="status">Single-click to select PSAPs. For multiple: Hold Cmd/Ctrl or Multi-Select Mode.</div>
    
    <!-- Area Selection Modal -->
    <div id="areaSelectionModal" class="modal">
        <div class="modal-content">
            <h2>Select Area</h2>
            <p>Which area would you like to work with?</p>
            <div class="modal-buttons">
                <button id="selectUSBtn" class="select-area-btn">United States</button>
                <button id="selectCanadaBtn" class="select-area-btn">Canada</button>
                <button id="selectDefaultBtn" class="select-area-btn">Other (Default)</button>
            </div>
        </div>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/geometryEngine",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/geometry/projection",
            "esri/geometry/SpatialReference",
            "esri/widgets/Expand"
        ], function(Map, MapView, FeatureLayer, SimpleFillSymbol, SimpleLineSymbol, SimpleRenderer, Graphic, geometryEngine, Sketch, GraphicsLayer, projection, SpatialReference, Expand) {

            // Initialize variables
            let psapLayerView, canadaTownsLayerView;
            let drawnPolygon = null;
            let selectedFeatures = [];
            let highlightSelections = [];
            let activeLayer = 'psap'; // Default to PSAP layer
            let multiSelectMode = true; // Default multi-select to ON
            let drawnPolygons = [];
            let drawingMode = false; // Used in toggleDrawingMode
            let sketch = null; // For sketch widget

            // UI Elements
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadDrawnBtn = document.getElementById('downloadDrawnBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const multiSelectBtn = document.getElementById('multiSelectBtn');
            const drawPolygonBtn = document.getElementById('drawPolygonBtn');
            const selectionPanel = document.getElementById('selectionPanel');
            const selectionList = document.getElementById('selectionList');
            const selectionCount = document.getElementById('selectionCount');
            const panelToggle = document.getElementById('panelToggle');
            const status = document.getElementById('status');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');

            // Create the map
            const map = new Map({
                basemap: "hybrid"
            });

            // Create the map view
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 39.8283], // Center of US
                zoom: 4
            });

            // Define renderer for the layer
            const renderer = new SimpleRenderer({
                symbol: new SimpleFillSymbol({
                    color: [41, 168, 221, 0.4], // Light blue with transparency
                    outline: new SimpleLineSymbol({
                        color: [0, 21, 89, 0.8], // Dark blue outline
                        width: 1
                    })
                })
            });

            // Create the feature layer - PSAP layer instead of Canada towns
            const psapLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/psap_2017/FeatureServer",
                renderer: renderer,
                outFields: ["*"],
                // Set highlight options
                highlightOptions: {
                    color: [255, 243, 0, 0.8], // Bright yellow
                    fillOpacity: 0.8,
                    haloColor: [0, 94, 255], // Blue halo
                    haloOpacity: 1.0,
                    haloSize: 2
                }
            });

            // Create graphics layer for drawings
            const drawLayer = new GraphicsLayer({
                title: "User-Drawn Polygons"
            });
            
            // Create the Canadian Towns layer with its own renderer
            const canadaTownsLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/Canada_Town/FeatureServer",
                title: "Canadian Towns",
                renderer: new SimpleRenderer({
                    symbol: new SimpleFillSymbol({
                        color: [51, 51, 204, 0.3], // Blue with transparency
                        outline: new SimpleLineSymbol({
                            color: [51, 51, 204, 0.8], // Dark blue outline
                            width: 1
                        })
                    })
                }),
                outFields: ["*"],  // Get all fields for proper attribute handling
                popupEnabled: false,  // Disable click popups for Canadian Towns
                // No popupTemplate needed since popups are disabled
                // We'll still show information via custom hover tooltips instead
                // Set highlight options
                highlightOptions: {
                    color: [0, 102, 255, 0.8], // Blue highlight
                    fillOpacity: 0.7,
                    haloColor: [0, 102, 255],
                    haloOpacity: 0.7
                }
            });
            
            // Add all layers to the map
            map.add(psapLayer);
            map.add(canadaTownsLayer);
            map.add(drawLayer);

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            // Reference to layer view for highlighting already declared at the top
            // Using the existing psapLayerView and canadaTownsLayerView variables

            // Centralized function to highlight all selected features
            function highlightSelectedFeatures() {
                console.log('Highlighting selected features:', selectedFeatures.length);
                
                // Clear existing highlights first
                highlightSelections.forEach(highlight => {
                    if (highlight && highlight.remove) highlight.remove();
                });
                highlightSelections = [];
                
                if (selectedFeatures.length === 0) {
                    console.log('No features to highlight');
                    return;
                }
                
                // Apply highlights to all selected features based on which layer they belong to
                selectedFeatures.forEach(feature => {
                    try {
                        // Check which layer the feature belongs to
                        const isPsapFeature = feature.layer === psapLayer;
                        
                        if (isPsapFeature && psapLayerView) {
                            const highlight = psapLayerView.highlight(feature);
                            highlightSelections.push(highlight);
                            console.log('Added PSAP highlight');
                        } else if (!isPsapFeature && canadaTownsLayerView) {
                            const highlight = canadaTownsLayerView.highlight(feature);
                            highlightSelections.push(highlight);
                            console.log('Added Canadian Towns highlight');
                        }
                    } catch (error) {
                        console.error('Error highlighting feature:', error);
                    }
                });
            }

            // Helper function to get consistent feature ID
            function getFeatureId(feature) {
                return feature.attributes.ogc_fid ||
                       feature.attributes.OBJECTID || 
                       feature.attributes.FID ||
                       JSON.stringify(feature.attributes);
            }

            // Helper function to get PSAP name from attributes
            function getPsapName(attributes) {
                return attributes.psap_name || attributes.name || 'Unknown PSAP';
            }
            
            // Helper function to get town name from attributes
            function getTownName(attributes) {
                // For debugging - log all attributes to see what's available
                console.log('Canadian Town attributes:', attributes);
                
                // Try specific field names that should exist in the Canadian Towns layer
                if (attributes.NAME) {
                    return attributes.NAME;
                }
                
                if (attributes.name) {
                    return attributes.name;
                }
                
                if (attributes.TOWN_NAME) {
                    return attributes.TOWN_NAME;
                }
                
                // Prioritize fields with 'name', 'town', or 'city' in them
                const nameFields = Object.keys(attributes).filter(key => 
                    key.toLowerCase().includes('name') || 
                    key.toLowerCase().includes('town') || 
                    key.toLowerCase().includes('city')
                );
                
                for (const field of nameFields) {
                    if (attributes[field] && typeof attributes[field] === 'string' && attributes[field].trim() !== '') {
                        return attributes[field];
                    }
                }
                
                // If no name found, combine the ID and any other useful information
                return `Town ID: ${attributes.OBJECTID || attributes.FID || 'Unknown'}`;
            }

            // Helper function to update selection panel - implementation from Canada app
            function updateSelectionPanel() {
                console.log('Updating selection panel with', selectedFeatures.length, 'features');
                
                // Update count display and button text
                selectionCount.textContent = selectedFeatures.length;
                downloadBtn.textContent = `📥 Download Selected (${selectedFeatures.length})`;
                
                // Count how many features of each type
                const psapCount = selectedFeatures.filter(f => f.layer === psapLayer).length;
                const townCount = selectedFeatures.filter(f => f.layer !== psapLayer).length;
                
                // Create an appropriate header text based on what's selected
                const headerTextElement = document.getElementById('selectionHeaderText');
                if (psapCount > 0 && townCount > 0) {
                    headerTextElement.textContent = `Selected Features (${psapCount} PSAPs, ${townCount} Towns)`;
                } else if (psapCount > 0) {
                    headerTextElement.textContent = `Selected PSAPs`;
                } else if (townCount > 0) {
                    headerTextElement.textContent = `Selected Towns`;
                } else {
                    headerTextElement.textContent = `Selected Features`;
                }
                
                // Show/hide panel and update button states
                if (selectedFeatures.length > 0) {
                    selectionPanel.style.display = 'block';
                    downloadBtn.disabled = false;
                    clearAllBtn.disabled = false;
                } else {
                    selectionPanel.style.display = 'none';
                    downloadBtn.disabled = true;
                    clearAllBtn.disabled = true;
                }
                
                // Clear and rebuild selection list - IMPORTANT: Do this in one place only
                selectionList.innerHTML = '';
                
                // Add each selected feature to the panel
                selectedFeatures.forEach((feature, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'selected-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'item-name';
                    
                    // Get appropriate name based on which layer the feature belongs to
                    const isPsapFeature = feature.layer === psapLayer;
                    
                    if (isPsapFeature) {
                        nameSpan.textContent = getPsapName(feature.attributes);
                    } else {
                        nameSpan.textContent = getTownName(feature.attributes);
                    }
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.textContent = '×';
                    removeBtn.title = 'Remove from selection';
                    removeBtn.onclick = () => removeFromSelection(index);
                    
                    itemDiv.appendChild(nameSpan);
                    itemDiv.appendChild(removeBtn);
                    selectionList.appendChild(itemDiv);
                });
            }
            
            // Helper function to remove item from selection - from Canada app
            function removeFromSelection(index) {
                if (index >= 0 && index < selectedFeatures.length) {
                    // Get the feature to show in status message
                    const feature = selectedFeatures[index];
                    const isPsapFeature = feature.layer === psapLayer;
                    const featureName = isPsapFeature ? 
                        getPsapName(feature.attributes) : 
                        getTownName(feature.attributes);
                    
                    // Remove highlight
                    if (highlightSelections[index]) {
                        highlightSelections[index].remove();
                    }
                    
                    // Remove from arrays
                    selectedFeatures.splice(index, 1);
                    highlightSelections.splice(index, 1);
                    
                    // Update UI
                    updateSelectionPanel();
                    status.textContent = `Removed ${featureName} from selection`;
                }
            }

            // Helper function to clear all selections
            function clearAllSelections() {
                console.log('Clearing all selections');
                
                // Remove all highlights
                highlightSelections.forEach(highlight => {
                    if (highlight && highlight.remove) {
                        try {
                            highlight.remove();
                        } catch (e) {
                            console.error('Error removing highlight:', e);
                        }
                    }
                });

                selectedFeatures = [];
                highlightSelections = [];
                
                // Clear PSAP layer highlights if available
                if (psapLayerView && psapLayerView.highlight) {
                    try {
                        psapLayerView.highlight();
                    } catch (e) {
                        console.error('Error clearing PSAP highlights:', e);
                    }
                }
                
                // Clear Canadian Towns layer highlights if available
                if (canadaTownsLayerView && canadaTownsLayerView.highlight) {
                    try {
                        canadaTownsLayerView.highlight();
                    } catch (e) {
                        console.error('Error clearing Canadian Towns highlights:', e);
                    }
                }
                
                updateSelectionPanel();
                updateStatus();
                
                // Update button state
                clearAllBtn.disabled = true;
                downloadBtn.disabled = true;
                downloadBtn.textContent = '📥 Download Selected (0)';
            }

            // Helper function to update status message
            function updateStatus() {
                if (selectedFeatures.length === 0) {
                    if (activeLayer === 'psap') {
                        status.textContent = 'Click to select PSAPs. Hold Ctrl/Cmd for multiple selection.';
                    } else {
                        status.textContent = 'Click to select Canadian towns. Hold Ctrl/Cmd for multiple selection.';
                    }
                } else {
                    if (activeLayer === 'psap') {
                        status.textContent = `${selectedFeatures.length} PSAP${selectedFeatures.length > 1 ? 's' : ''} selected. Use Ctrl/Cmd+click to add more.`;
                    } else {
                        status.textContent = `${selectedFeatures.length} town${selectedFeatures.length > 1 ? 's' : ''} selected. Use Ctrl/Cmd+click to add more.`;
                    }
                }
            }

            // Toggle selection panel
            panelToggle.addEventListener('click', function() {
                const content = document.querySelector('.panel-content');
                const footer = document.querySelector('.panel-footer');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    footer.style.display = 'block';
                    panelToggle.textContent = '−';
                } else {
                    content.style.display = 'none';
                    footer.style.display = 'none';
                    panelToggle.textContent = '+';
                }
            });

            // Clear all selections
            clearAllBtn.addEventListener('click', clearAllSelections);

            // Search functionality
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            searchButton.addEventListener('click', performSearch);
            
            function performSearch() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length < 2) return;
                
                // Show loading state
                searchResults.innerHTML = '<div class="search-result-item">Searching...</div>';
                searchResults.style.display = 'block';
                
                // Search PSAP layer
                const psapPromise = new Promise((resolve) => {
                    const query = psapLayer.createQuery();
                    query.where = `UPPER(psap_name) LIKE UPPER('%${searchTerm}%') OR 
                                 UPPER(account_id) LIKE UPPER('%${searchTerm}%') OR 
                                 UPPER(NAME) LIKE UPPER('%${searchTerm}%')`;
                    query.outFields = ["*"];
                    query.returnGeometry = true;
                    
                    psapLayer.queryFeatures(query)
                        .then(result => ({
                            features: result.features.map(f => ({
                                ...f,
                                layerType: 'psap'
                            })),
                            type: 'psap'
                        }))
                        .catch(error => {
                            console.error("PSAP search error:", error);
                            return { features: [], type: 'psap' };
                        })
                        .then(resolve);
                });
                
                // Search Canadian Towns layer
                const canadaPromise = new Promise((resolve) => {
                    const query = canadaTownsLayer.createQuery();
                    
                    // Create a more comprehensive search query for town names
                    const nameFields = ['NAME', 'TOWN_NAME', 'CITY_NAME', 'MUNICIPALITY', 'COMMUNITY', 'SETTLEMENT'];
                    const whereClause = nameFields
                        .map(field => `UPPER(${field}) LIKE UPPER('%${searchTerm}%')`)
                        .join(' OR ');
                    
                    query.where = whereClause || "1=0";
                    query.outFields = ["*"];
                    query.returnGeometry = true;
                    
                    canadaTownsLayer.queryFeatures(query)
                        .then(result => ({
                            features: result.features.map(f => ({
                                ...f,
                                layerType: 'canada'
                            })),
                            type: 'canada'
                        }))
                        .catch(error => {
                            console.error("Canadian Towns search error:", error);
                            return { features: [], type: 'canada' };
                        })
                        .then(resolve);
                });
                
                // Combine results from both layers
                Promise.all([psapPromise, canadaPromise]).then(([psapResults, canadaResults]) => {
                    const allResults = [
                        ...psapResults.features,
                        ...canadaResults.features
                    ];
                    
                    displaySearchResults(allResults);
                });
            }
            
            function displaySearchResults(features) {
                searchResults.innerHTML = '';
                
                if (!features || features.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'search-result-item';
                    noResults.textContent = 'No results found';
                    searchResults.appendChild(noResults);
                    searchResults.style.display = 'block';
                    return;
                }
                
                // Group features by type
                const grouped = {
                    psap: [],
                    canada: []
                };
                
                features.forEach(feature => {
                    const type = feature.layerType || 'psap';
                    if (grouped[type]) {
                        grouped[type].push(feature);
                    }
                });
                
                // Display PSAP results first
                if (grouped.psap.length > 0) {
                    const psapHeader = document.createElement('div');
                    psapHeader.className = 'search-result-category';
                    psapHeader.textContent = 'PSAPs';
                    searchResults.appendChild(psapHeader);
                    
                    grouped.psap.forEach(feature => {
                        addSearchResultItem(feature, 'psap');
                    });
                }
                
                // Then display Canadian Towns
                if (grouped.canada.length > 0) {
                    const canadaHeader = document.createElement('div');
                    canadaHeader.className = 'search-result-category';
                    canadaHeader.textContent = 'Canadian Towns';
                    searchResults.appendChild(canadaHeader);
                    
                    grouped.canada.forEach(feature => {
                        addSearchResultItem(feature, 'canada');
                    });
                }
                
                // Make search results visible
                searchResults.style.display = 'block';
            }
            
            function addSearchResultItem(feature, layerType) {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.setAttribute('data-type', layerType);
                
                // Get name from attributes based on layer type
                let name, subtext = '';
                if (layerType === 'psap') {
                    name = feature.attributes.NAME || feature.attributes.PSAP_NAME || feature.attributes.psap_name || 
                          `PSAP ${feature.attributes.OBJECTID || ''}`;
                    subtext = feature.attributes.account_id || '';
                } else {
                    name = getTownName(feature.attributes);
                    subtext = feature.attributes.PROVINCE || feature.attributes.PROVINCE_1 || '';
                }
                
                // Create name element
                const nameEl = document.createElement('div');
                nameEl.textContent = name;
                
                // Create subtext element if available
                if (subtext) {
                    const subtextEl = document.createElement('div');
                    subtextEl.className = 'subtext';
                    subtextEl.textContent = subtext;
                    resultItem.appendChild(subtextEl);
                }
                
                resultItem.prepend(nameEl);
                
                // Click to select
                resultItem.addEventListener('click', function() {
                    // Close search results
                    searchResults.innerHTML = '';
                    searchInput.value = '';
                    searchResults.style.display = 'none';
                    
                    // Select the feature
                    selectFeature(feature);
                    
                    // Zoom to the feature
                    view.goTo({
                        target: feature.geometry,
                        zoom: 10
                    });
                });
                
                searchResults.appendChild(resultItem);
            }
            
            // Hide search results when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    searchResults.style.display = 'none';
                }
            });

            // Select a feature programmatically (used by search)
            function selectFeature(feature) {
                if (!multiSelectMode && selectedFeatures.length > 0) {
                    clearAllSelections();
                }
                
                // Check if already selected
                const existingIndex = selectedFeatures.findIndex(f => 
                    getFeatureId(f) === getFeatureId(feature)
                );
                
                if (existingIndex >= 0) {
                    // Already selected - do nothing
                    return;
                }
                
                // Add to selection
                selectedFeatures.push(feature);
                
                // Highlight the feature
                const layerView = feature.layerType === 'psap' ? psapLayerView : canadaTownsLayerView;
                if (layerView) {
                    const highlight = layerView.highlight(feature);
                    highlightSelections.push(highlight);
                }
                
                // Update selection panel with newly selected feature
                updateSelectionPanel();
                updateStatus();
            }
            
            // Hide tooltip when leaving map area
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
            });
            
            // Show tooltip with feature name on hover for both layers
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    // Check for PSAP layer feature
                    const psapResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    // Check for Canada Towns layer feature
                    const canadaResult = response.results.find(result => 
                        result.graphic && result.graphic.layer === canadaTownsLayer
                    );
                    
                    // First try the focused layer, then the other
                    let hoverResult = null;
                    if (activeLayer === 'psap') {
                        hoverResult = psapResult || canadaResult;
                    } else {
                        hoverResult = canadaResult || psapResult;
                    }
                    
                    // Show tooltip if we found a feature
                    if (hoverResult) {
                        const feature = hoverResult.graphic;
                        let featureName = '';
                        
                        // Determine which layer the feature belongs to and create appropriate tooltip content
                        if (feature.layer === psapLayer) {
                            // For PSAP layer, get the PSAP name and format tooltip
                            featureName = getPsapName(feature.attributes);
                            tooltip.innerHTML = `<strong>${featureName}</strong>`;
                            
                            // Add additional PSAP info if available
                            if (feature.attributes.state) {
                                tooltip.innerHTML += `<br>State: ${feature.attributes.state}`;
                            }
                        } else {
                            // For Canadian Towns layer, get town name and format tooltip with more details
                            featureName = getTownName(feature.attributes);
                            tooltip.innerHTML = `<strong>${featureName}</strong>`;
                            
                            // Add additional town info if available
                            const attrs = feature.attributes;
                            if (attrs.PROVINCE) {
                                tooltip.innerHTML += `<br>Province: ${attrs.PROVINCE}`;
                            }
                            if (attrs.POPULATION) {
                                tooltip.innerHTML += `<br>Population: ${attrs.POPULATION.toLocaleString()}`;
                            }
                        }
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${event.x + 10}px`;
                        tooltip.style.top = `${event.y + 10}px`;
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
            });
            
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
            });

            // Download as GeoJSON
            downloadBtn.addEventListener('click', async function() {
                if (selectedFeatures.length === 0) return;
                
                try {
                    status.textContent = 'Preparing download...';
                    
                    // Process each selected feature
                    const features = await Promise.all(selectedFeatures.map(async feature => {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(feature.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                ...feature.attributes,
                                // Add metadata about projection
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    original_crs: feature.geometry.spatialReference ? 
                                        `EPSG:${feature.geometry.spatialReference.wkid}` : 'Unknown',
                                    target_crs: 'EPSG:4326',
                                    target_crs_name: 'WGS 84'
                                }
                            }
                        };
                    }));
                    
                    // Create GeoJSON object
                    const geoJSON = {
                        type: "FeatureCollection",
                        crs: {
                            type: "name",
                            properties: {
                                name: "urn:ogc:def:crs:EPSG::4326"
                            }
                        },
                        metadata: {
                            exported_by: "RapidSOS PSAP Map",
                            export_date: new Date().toISOString(),
                            feature_count: features.length
                        },
                        features: features
                    };
                    
                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `psap_boundaries_${selectedFeatures.length}_polygons_WGS84_${timestamp}.geojson`;
                    
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    if (activeLayer === 'psap') {
                        status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                    } else if (activeLayer === 'canada') {
                        status.textContent = `Downloaded ${selectedFeatures.length} Canada Towns polygons in WGS84 format`;
                    } else {
                        status.textContent = `Downloaded ${selectedFeatures.length} features in WGS84 format`;
                    }
                } catch (error) {
                    console.error('Error downloading GeoJSON:', error);
                    status.textContent = 'Error preparing download';
                }
            });

            // Helper function to convert ESRI geometry to GeoJSON with projection
            async function convertEsriGeometryToGeoJSON(geometry) {
                try {
                    // Create target spatial reference (WGS84 / EPSG:4326)
                    const wgs84 = new SpatialReference({ wkid: 4326 });

                    let projectedGeometry = geometry;

                    // Check if geometry needs projection
                    if (geometry.spatialReference && geometry.spatialReference.wkid !== 4326) {
                        console.log(`Projecting from EPSG:${geometry.spatialReference.wkid} to EPSG:4326`);

                        // Load projection engine if not already loaded
                        await projection.load();

                        // Project geometry to WGS84
                        projectedGeometry = projection.project(geometry, wgs84);
                    }

                    // Convert to GeoJSON coordinate format
                    if (projectedGeometry.rings) {
                        // Polygon geometry
                        return projectedGeometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }

                    return [];
                } catch (error) {
                    console.error('Error converting geometry coordinates:', error);
                    console.log('Falling back to original coordinates');

                    // Fallback to original method if projection fails
                    if (geometry.rings) {
                        return geometry.rings.map(ring =>
                            ring.map(coord => [coord[0], coord[1]])
                        );
                    }
                    return [];
                }
            }

            // Set up the sketch widget for polygon drawing
            function setupDrawTools() {
                // Create the sketch widget for drawing polygons
                sketch = new Sketch({
                    layer: drawLayer,
                    view: view,
                    creationMode: "update",
                    availableCreateTools: ["polygon"], // Only allow polygon creation
                    defaultCreateOptions: {
                        mode: "click" // Default to click-by-click polygon creation
                    },
                    visibleElements: {
                        createTools: {
                            point: false,
                            polyline: false,
                            polygon: true,
                            rectangle: false,
                            circle: false
                        },
                        selectionTools: {
                            "lasso-selection": false,
                            "rectangle-selection": false
                        },
                        undoRedoMenu: true,
                        settingsMenu: false
                    }
                });
                
                // Track drawing state
                sketch.on(["create", "update", "delete"], function(event) {
                    if (event.state === "complete") {
                        // Show download button when drawing is complete
                        if (drawLayer.graphics.length > 0) {
                            downloadDrawnBtn.style.display = "block";
                            status.textContent = "Polygon drawn! You can now download it or continue editing.";
                        } else {
                            downloadDrawnBtn.style.display = "none";
                        }
                    }
                });
                
                return sketch;
            }
            
            // Toggle drawing mode
            function toggleDrawingMode() {
                drawingMode = !drawingMode;
                
                if (drawingMode) {
                    // Activate drawing mode
                    if (!sketch) {
                        sketch = setupDrawTools();
                    }
                    view.ui.add(sketch, { position: "bottom-right" });
                    drawPolygonBtn.textContent = "✏️ Exit Drawing Mode";
                    drawPolygonBtn.classList.add("active");
                    status.textContent = "Drawing mode active. Click to create polygon vertices, double-click to complete.";
                } else {
                    // Deactivate drawing mode
                    if (sketch) {
                        view.ui.remove(sketch);
                    }
                    drawPolygonBtn.textContent = "✏️ Draw Polygon";
                    drawPolygonBtn.classList.remove("active");
                    status.textContent = "Drawing mode exited.";
                }
            }
            
            // Get a reference to the layer view for highlighting
            view.whenLayerView(psapLayer).then(function(layerView) {
                psapLayerView = layerView;
                console.log("Layer view created for highlighting");
            });

            // Function to download drawn polygons as GeoJSON
            async function downloadDrawnPolygons() {
                // Get all graphics from the draw layer
                const graphics = drawLayer.graphics.toArray();
                
                if (graphics.length === 0) {
                    alert("No polygons drawn! Draw a polygon first.");
                    return;
                }
                
                try {
                    status.textContent = 'Preparing download of drawn polygon...';
                    
                    // Process each drawn graphic
                    const features = await Promise.all(graphics.map(async function(graphic, index) {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(graphic.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                id: index + 1,
                                name: `User Drawn Polygon ${index + 1}`,
                                drawn_date: new Date().toISOString(),
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    source: "User Drawing",
                                    target_crs: "EPSG:4326",
                                    target_crs_name: "WGS 84"
                                }
                            }
                        };
                    }));
                    
                    // Create GeoJSON object
                    const geoJSON = {
                        type: "FeatureCollection",
                        crs: {
                            type: "name",
                            properties: {
                                name: "urn:ogc:def:crs:EPSG::4326"
                            }
                        },
                        metadata: {
                            exported_by: "RapidSOS PSAP Map - Drawing Tool",
                            export_date: new Date().toISOString(),
                            feature_count: features.length
                        },
                        features: features
                    };
                    
                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Create download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `user_drawn_polygons_${timestamp}.geojson`;
                    
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    status.textContent = `Downloaded ${drawnPolygons.length} drawn polygon(s) as GeoJSON`;
                } catch (error) {
                    console.error('Error downloading drawn polygons:', error);
                    alert('Error downloading drawn polygons. Please try again.');
                    status.textContent = 'Error during download';
                }
            }
            
            // Multi-select is now the default behavior, so no toggle function needed
            
            function downloadSelected() {
                if (selectedFeatures.length === 0) return;
                
                try {
                    status.textContent = 'Preparing download...';
                    
                    // Process each selected feature
                    Promise.all(selectedFeatures.map(async feature => {
                        // Convert coordinates with proper projection
                        const coordinates = await convertEsriGeometryToGeoJSON(feature.geometry);
                        
                        return {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: coordinates
                            },
                            properties: {
                                ...feature.attributes,
                                // Add metadata about projection
                                export_metadata: {
                                    exported_date: new Date().toISOString(),
                                    original_crs: feature.geometry.spatialReference ? 
                                        `EPSG:${feature.geometry.spatialReference.wkid}` : 'Unknown',
                                    target_crs: 'EPSG:4326',
                                    target_crs_name: 'WGS 84'
                                }
                            }
                        };
                    })).then(features => {
                        // Create GeoJSON object
                        const geoJSON = {
                            type: "FeatureCollection",
                            crs: {
                                type: "name",
                                properties: {
                                    name: "urn:ogc:def:crs:EPSG::4326"
                                }
                            },
                            metadata: {
                                exported_by: "RapidSOS PSAP Map",
                                export_date: new Date().toISOString(),
                                feature_count: features.length
                            },
                            features: features
                        };
                        
                        // Convert to JSON string and download
                        const json = JSON.stringify(geoJSON, null, 2);
                        const blob = new Blob([json], {type: "application/json"});
                        const url = URL.createObjectURL(blob);
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = `${activeLayer === 'psap' ? 'psap' : 'canada_towns'}_export_${new Date().toISOString().slice(0,10)}.geojson`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(url);
                        
                        if (activeLayer === 'psap') {
                            status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                        } else {
                            status.textContent = `Downloaded ${selectedFeatures.length} Canadian Towns in WGS84 format`;
                        }
                    }).catch(error => {
                        console.error('Error downloading GeoJSON:', error);
                        alert('Error preparing download. Please try again.');
                        status.textContent = 'Error during download';
                    });
                    
                } catch (error) {
                    console.error('Error downloading GeoJSON:', error);
                    alert('Error downloading GeoJSON. Please try again.');
                    status.textContent = 'Error during download';
                }
            }
            
            // Attach event handlers to buttons
            // Make sure clearAllBtn event listener is properly attached
            clearAllBtn.addEventListener('click', clearAllSelections);
            downloadBtn.addEventListener('click', downloadSelected);
            drawPolygonBtn.addEventListener('click', toggleDrawingMode);
            downloadDrawnBtn.addEventListener('click', downloadDrawnPolygons);
            layerSwitchBtn.addEventListener('click', switchActiveLayer);
            
            // Multi-select button functionality
            multiSelectBtn.addEventListener('click', function() {
                multiSelectMode = !multiSelectMode;
                multiSelectBtn.textContent = multiSelectMode ? '🔘 Multi-Select: ON' : '🔘 Multi-Select: OFF';
                status.textContent = multiSelectMode ? 'Multi-select mode activated. Click on multiple features to select them.' : 'Multi-select mode deactivated. Click on a feature to select it.';
            });
            
            // Function to switch between PSAP and Canadian Towns layers
            // Now just changes visual focus but both layers remain selectable
            function switchActiveLayer() {
                if (activeLayer === 'psap') {
                    // Switch to Canadian Towns layer as visual focus
                    activeLayer = 'canada';
                    // Keep both layers visible, but adjust opacity to show which is in focus
                    psapLayer.opacity = 0.3;
                    canadaTownsLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: Canadian Towns';
                    
                    // Get Canada layer view for highlighting
                    if (!canadaTownsLayerView) {
                        view.whenLayerView(canadaTownsLayer).then(function(layerView) {
                            console.log('Created Canadian Towns layer view');
                            canadaTownsLayerView = layerView;
                        });
                    }
                    
                    // Update status text
                    status.textContent = 'Switched to Canadian Towns layer. Click to select towns';
                    
                    // Zoom to Canada
                    view.goTo({
                        target: {
                            xmin: -140.0,
                            ymin: 40.0,
                            xmax: -50.0,
                            ymax: 70.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 40, right: 40, top: 40, bottom: 40 }
                    });
                    
                    console.log('Switched to Canadian Towns layer');
                } else {
                    // Switch to PSAP layer as visual focus
                    activeLayer = 'psap';
                    // Keep both layers visible, but adjust opacity to show which is in focus
                    canadaTownsLayer.opacity = 0.3;
                    psapLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: US PSAPs';
                    
                    // Make sure we have the PSAP layer view for highlighting
                    if (!psapLayerView) {
                        view.whenLayerView(psapLayer).then(function(layerView) {
                            console.log('Created PSAP layer view');
                            psapLayerView = layerView;
                            initialLoadComplete = true;
                        });
                    }
                    
                    // Update status text
                    status.textContent = 'Switched to US PSAPs layer. Click to select PSAPs.';
                    
                    // Zoom back to continental US
                    view.goTo({
                        target: {
                            xmin: -125.0,
                            ymin: 24.0,
                            xmax: -66.0,
                            ymax: 49.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    console.log('Switched to PSAP layer');
                }
            }
            
            // Area selection functionality
            function handleAreaSelection() {
                // Check if user has made a selection before (stored in localStorage)
                if (localStorage.getItem('psapMapAreaSelected') === 'true') {
                    console.log('Area already selected previously, not showing modal');
                    return; // Skip showing the modal entirely
                }
                
                // Show the modal only ONCE
                console.log('Showing area selection modal');
                areaSelectionModal.style.display = 'block';
                
                // Set up the area selection function to permanently mark selection as made
                selectUSBtn.addEventListener('click', function() {
                    // Mark selection as made
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('us');
                });
                
                selectCanadaBtn.addEventListener('click', function() {
                    // Mark selection as made
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('canada');
                });
                
                selectDefaultBtn.addEventListener('click', function() {
                    // Mark selection as made
                    localStorage.setItem('psapMapAreaSelected', 'true');
                    selectArea('default');
                });
            }
            
            // Show tutorial on first visit or when help button is clicked
            const tutorialOverlay = document.getElementById('tutorial-overlay');
            const helpButton = document.getElementById('helpButton');
            const tutorialClose = document.querySelector('.tutorial-close');
            const tutorialGotIt = document.getElementById('tutorialGotIt');
            const dontShowAgain = document.getElementById('dontShowAgain');
            
            // Check if user has seen the tutorial before
            const hasSeenTutorial = localStorage.getItem('hasSeenPSAPMapTutorial');
            
            function showTutorial() {
                tutorialOverlay.style.visibility = 'visible';
                tutorialOverlay.style.opacity = '1';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
            }
            
            function hideTutorial() {
                tutorialOverlay.style.opacity = '0';
                setTimeout(() => {
                    tutorialOverlay.style.visibility = 'hidden';
                    document.body.style.overflow = ''; // Re-enable scrolling
                }, 300);
            }
            
            // Event listeners for tutorial controls
            helpButton.addEventListener('click', showTutorial);
            tutorialClose.addEventListener('click', hideTutorial);
            tutorialGotIt.addEventListener('click', hideTutorial);
            
            dontShowAgain.addEventListener('click', function() {
                localStorage.setItem('hasSeenPSAPMapTutorial', 'true');
                hideTutorial();
            });
            
            // Show tutorial on first visit
            if (!hasSeenTutorial) {
                // Wait for map to load
                setTimeout(() => {
                    showTutorial();
                }, 2000);
            }

            // Call the function ONE time at startup
            window.addEventListener('load', function() {
                // Wait for the map to be fully loaded
                setTimeout(handleAreaSelection, 1500);
            });
            
            // Add click handler for feature selection from both layers
            view.on("click", function(event) {
                // Don't process clicks if drawing mode is active
                if (sketch) {
                    return;
                }
                
                // Get the screen point for hit testing
                const screenPoint = {
                    x: event.x,
                    y: event.y
                };
                
                // Perform hit test to see if user clicked on a feature
                view.hitTest(screenPoint).then(function(response) {
                    // Check both layers for features, not just the active one
                    // First check for PSAP features
                    const psapFeature = response.results.find(result => 
                        result.graphic && result.graphic.layer === psapLayer
                    );
                    
                    // Then check for Canadian Towns features
                    const canadaFeature = response.results.find(result => 
                        result.graphic && result.graphic.layer === canadaTownsLayer
                    );
                    
                    // First try the active layer, then fall back to the other layer
                    let clickedFeature = null;
                    if (activeLayer === 'psap') {
                        clickedFeature = psapFeature || canadaFeature;
                    } else {
                        clickedFeature = canadaFeature || psapFeature;
                    }
                    
                    if (clickedFeature) {
                        const feature = clickedFeature.graphic;
                        console.log('Clicked feature:', feature);
                        
                        // Check for multi-select: either explicit multi-select mode OR modifier keys
                        const isModifierPressed = event.native.ctrlKey || 
                                              event.native.metaKey || 
                                              event.native.shiftKey;
                        
                        const shouldMultiSelect = multiSelectMode || isModifierPressed;
                        console.log('Selection debug:', {
                            multiSelectMode, 
                            isModifierPressed, 
                            shouldMultiSelect, 
                            currentSelectionCount: selectedFeatures.length
                        });
                        
                        // Get feature ID for consistent comparison
                        const featureId = feature.attributes.OBJECTID || feature.attributes.FID;
                        
                        // Check if this feature is already selected
                        const existingIndex = selectedFeatures.findIndex(f => 
                            (f.attributes.OBJECTID === featureId) || (f.attributes.FID === featureId)
                        );
                        
                        if (existingIndex >= 0) {
                            // Feature already selected - remove it (toggle behavior)
                            // Get feature properties for status message
                            const isPsapFeature = feature.layer === psapLayer;
                            const featureName = isPsapFeature ? 
                                getPsapName(feature.attributes) : 
                                getTownName(feature.attributes);
                            
                            // Remove the highlight
                            if (highlightSelections[existingIndex] && highlightSelections[existingIndex].remove) {
                                highlightSelections[existingIndex].remove();
                            }
                            
                            // Remove from arrays
                            selectedFeatures.splice(existingIndex, 1);
                            highlightSelections.splice(existingIndex, 1);
                            
                            // Update UI
                            updateSelectionPanel();
                            status.textContent = `Removed ${featureName} from selection`;
                        } else {
                            // New selection
                            if (!shouldMultiSelect && selectedFeatures.length > 0) {
                                // Single select mode and we have existing selections - clear them first
                                console.log('Clearing previous selections for single select');
                                clearAllSelections();
                            }
                            
                            // Add new selection
                            selectedFeatures.push(feature);
                            console.log('Added feature, total selections:', selectedFeatures.length);
                            
                            // Highlight selected feature based on which layer it belongs to
                            const isPsapFeature = feature.layer === psapLayer;
                            
                            if (isPsapFeature && psapLayerView) {
                                const highlight = psapLayerView.highlight(feature);
                                highlightSelections.push(highlight);
                                const psapName = getPsapName(feature.attributes);
                                status.textContent = `Added ${psapName} to selection (${selectedFeatures.length} total)`;
                            } else if (!isPsapFeature && canadaTownsLayerView) {
                                const highlight = canadaTownsLayerView.highlight(feature);
                                highlightSelections.push(highlight);
                                const townName = getTownName(feature.attributes);
                                status.textContent = `Added ${townName} to selection (${selectedFeatures.length} total)`;
                            }
                            
                            // Update selection panel
                            updateSelectionPanel();
                        }
                    } else {
                        // Clicked on empty area
                        if (!multiSelectMode && !event.native.ctrlKey && !event.native.metaKey && selectedFeatures.length > 0) {
                            // In single-select mode, clear selections when clicking on empty space
                            // (this matches the behavior in the Canada app)
                            clearAllSelections();
                        }
                    }
                });
            });
            
            // Set initial visibility - both layers visible
            psapLayer.visible = true;
            canadaTownsLayer.visible = true;
            
            // Create layer views for both layers
            view.whenLayerView(psapLayer).then(function(layerView) {
                psapLayerView = layerView;
                console.log("PSAP layer view created");
                
                // Highlight any selected features
                highlightSelectedFeatures();
            });
            
            view.whenLayerView(canadaTownsLayer).then(function(layerView) {
                canadaTownsLayerView = layerView;
                console.log("Canada Towns layer view created");
            });
            
            // Area selection modal functionality
            const areaSelectionModal = document.getElementById('areaSelectionModal');
            const selectUSBtn = document.getElementById('selectUSBtn');
            const selectCanadaBtn = document.getElementById('selectCanadaBtn');
            const selectDefaultBtn = document.getElementById('selectDefaultBtn');
            
            // Function to handle area selection
            function selectArea(area) {
                console.log(`Selected area: ${area}`);
                
                // Close the modal
                areaSelectionModal.style.display = 'none';
                
                // Set the appropriate layer as active based on selection
                if (area === 'canada') {
                    activeLayer = 'canada';
                    psapLayer.opacity = 0.3;
                    canadaTownsLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: Canadian Towns';
                    
                    // Zoom to Canada
                    view.goTo({
                        target: {
                            xmin: -141.0,
                            ymin: 41.0,
                            xmax: -52.0,
                            ymax: 83.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    // Update placeholder text for search input
                    searchInput.placeholder = 'Search for a town...';
                    
                } else {
                    // Default to US/other
                    activeLayer = 'psap';
                    canadaTownsLayer.opacity = 0.3;
                    psapLayer.opacity = 1.0;
                    layerSwitchBtn.textContent = 'Focus: US PSAPs';
                    
                    // Zoom to US
                    view.goTo({
                        target: {
                            xmin: -125.0,
                            ymin: 24.0,
                            xmax: -66.0,
                            ymax: 49.0,
                            spatialReference: { wkid: 4326 }
                        },
                        padding: { left: 20, right: 20, top: 20, bottom: 20 }
                    });
                    
                    // Update placeholder text for search input
                    searchInput.placeholder = 'Search for a PSAP...';
                }
            }
            
            // Event listeners for area selection buttons
            selectUSBtn.addEventListener('click', function() {
                selectArea('us');
            });
            
            selectCanadaBtn.addEventListener('click', function() {
                selectArea('canada');
            });
            
            selectDefaultBtn.addEventListener('click', function() {
                selectArea('other');
            });
            
            // Wait for layer to load and zoom to extent
            psapLayer.when(function() {
                console.log("PSAP layer loaded successfully");
                status.textContent = "PSAP data loaded! Click to select boundaries or use Draw Polygon tool.";

                // Zoom to continental US for better default view
                view.goTo({
                    target: {
                        xmin: -125.0,
                        ymin: 24.0,
                        xmax: -66.0,
                        ymax: 49.0,
                        spatialReference: { wkid: 4326 }
                    },
                    padding: { left: 20, right: 20, top: 20, bottom: 20 }
                });

                // Initialize UI
                updateStatus();
            }).catch(function(error) {
                console.error("Error loading layer:", error);
                status.textContent = 'Error loading PSAP layer';
            });
        });
    </script>
</body>
</html>
