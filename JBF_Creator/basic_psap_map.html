<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Basic PSAP Map</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }
        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
        }
        #searchDiv {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 300px;
            height: 40px;
            z-index: 99;
        }
    </style>
</head>

<body>
    <div id="viewDiv"></div>
    <div id="searchDiv"></div>
    <div id="status">Loading map...</div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/widgets/Search"
        ], function(Map, MapView, FeatureLayer, Search) {
            
            console.log("ArcGIS modules loaded");
            
            // Create a simple map
            const map = new Map({
                basemap: "streets-vector" // Similar to Google Maps street view
            });
            
            console.log("Map created");
            
            try {
                // Create the map view
                const view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-98.5795, 39.8283], // Center of US
                    zoom: 4
                });
                
                console.log("View created");
                
                // Status element
                const status = document.getElementById('status');
                
                // Create the PSAP feature layer
                const psapLayer = new FeatureLayer({
                    url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/psap_2017/FeatureServer",
                    outFields: ["*"],
                    opacity: 0.7,
                    // Add a popup template to display all attributes
                    popupTemplate: {
                        title: "{psap_name}",
                        content: [
                            {
                                type: "fields",
                                fieldInfos: [
                                    { fieldName: "ogc_fid", label: "OGC FID" },
                                    { fieldName: "name", label: "Name" },
                                    { fieldName: "psap_name", label: "PSAP Name" },
                                    { fieldName: "fcc_id", label: "FCC ID" },
                                    { fieldName: "telephone", label: "Telephone" },
                                    { fieldName: "state", label: "State" },
                                    { fieldName: "account_id", label: "Account ID" },
                                    { fieldName: "state_1", label: "State (Alt)" }
                                ]
                            }
                        ]
                    }
                });
                
                console.log("PSAP layer created");
                
                // Add the layer to the map
                map.add(psapLayer);
                
                // When view is ready
                view.when(function() {
                    status.textContent = "Map loaded successfully!";
                    console.log("View ready");
                    
                    // Create and configure the search widget
                    const searchWidget = new Search({
                        view: view,
                        container: "searchDiv",
                        includeDefaultSources: false,
                        sources: [
                            {
                                layer: psapLayer,
                                searchFields: ["state", "psap_name", "account_id", "name"],
                                displayField: "psap_name",
                                exactMatch: false,
                                outFields: ["*"],
                                name: "PSAP Locations",
                                placeholder: "Search by name, ID, or location",
                                maxResults: 10,
                                maxSuggestions: 10,
                                suggestionsEnabled: true,
                                minSuggestCharacters: 2
                            }
                        ]
                    });
                    
                    // Add a debug message to see field names
                    psapLayer.when(function() {
                        psapLayer.queryFeatures({
                            where: "1=1",
                            returnGeometry: false,
                            outFields: ["*"],
                            num: 1
                        }).then(function(results) {
                            if (results && results.features && results.features.length > 0) {
                                console.log("Field names in layer:", Object.keys(results.features[0].attributes));
                            }
                        }).catch(function(error) {
                            console.error("Error querying field names:", error);
                        });
                    });
                    
                    console.log("Search widget created");
                    
                    // Wait for PSAP layer to load
                    psapLayer.when(function() {
                        status.textContent = "PSAP data loaded!";
                        console.log("PSAP layer loaded");
                    }).catch(function(error) {
                        status.textContent = "Error loading PSAP layer";
                        console.error("PSAP layer error:", error);
                    });
                }).catch(function(error) {
                    status.textContent = "Error loading map view";
                    console.error("View error:", error);
                });
            } catch (e) {
                console.error("Error in map initialization:", e);
                document.getElementById('status').textContent = "Error initializing map: " + e.message;
            }
        });
    </script>
</body>
</html>
