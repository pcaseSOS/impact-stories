<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Basic PSAP Map</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        /* RapidSOS brand colors */
        :root {
            --royal-blue: #001559; /* Primary dark blue */
            --safety-blue: #29A8DD; /* Primary light blue */
            --white: #FFFFFF;
            --safety-gap: #FFF300; /* Yellow highlight */
            --glow: #005eFF; /* Bright blue highlight */
        }

        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--royal-blue);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        #searchDiv {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 300px;
            height: 40px;
            z-index: 99;
        }
        
        /* Download toolbar */
        .toolbar {
            position: absolute;
            top: 70px;
            right: 15px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar button {
            background: var(--royal-blue);
            color: var(--white);
            border: none;
            padding: 10px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 180px;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .toolbar button:hover {
            background: var(--glow);
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Selection panel */
        #selectionPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 400px;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .panel-header {
            background: var(--royal-blue);
            color: var(--white);
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 0;
        }

        .selected-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
        }

        .selected-item:hover {
            background: #f8f9fa;
        }

        .selected-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }

        .remove-btn {
            background: #dc3545;
            color: var(--white);
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .panel-footer {
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        /* Custom styles for the search widget to match brand colors */
        .esri-search__container {
            border: 2px solid var(--safety-blue) !important;
        }

        .esri-search__submit-button {
            background-color: var(--safety-blue) !important;
        }

        .esri-search__suggestions-menu {
            border-color: var(--safety-blue) !important;
        }

        .esri-search__suggestion--highlighted {
            background-color: var(--safety-blue) !important;
            color: var(--white) !important;
        }

        /* Popup styling */
        .esri-popup__header {
            background-color: var(--royal-blue) !important;
        }

        .esri-popup__header-title {
            color: var(--white) !important;
        }

        /* Brand badge */
        #brandBadge {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--white);
            border: 2px solid var(--safety-blue);
            color: var(--royal-blue);
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 100;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body>
    <div id="viewDiv"></div>
    <div id="searchDiv"></div>
    <div id="status">Loading map...</div>
    <div id="brandBadge">RapidSOS PSAP Map</div>
    
    <!-- Toolbar for downloads -->
    <div class="toolbar">
        <button id="downloadBtn" disabled>üì• Download Selected (0)</button>
        <button id="clearBtn" disabled>üóëÔ∏è Clear Selection</button>
    </div>
    
    <!-- Selection Panel -->
    <div id="selectionPanel">
        <div class="panel-header">
            <span>Selected PSAPs (<span id="selectionCount">0</span>)</span>
            <button id="panelToggle" style="background: none; border: none; color: white; cursor: pointer;">‚àí</button>
        </div>
        <div class="panel-content" id="selectionList">
            <!-- Selected items will be populated here -->
        </div>
        <div class="panel-footer">
            Click on map to select PSAPs
        </div>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/widgets/Search",
            "esri/geometry/projection",
            "esri/geometry/SpatialReference"
        ], function(Map, MapView, FeatureLayer, Search, projection, SpatialReference) {
            
            console.log("ArcGIS modules loaded");
            
            // Array to store selected features and their info
            let selectedFeatures = [];
            
            // Flag to track if the initial map load is complete
            let initialLoadComplete = false;
            
            // UI Elements
            const downloadBtn = document.getElementById('downloadBtn');
            const clearBtn = document.getElementById('clearBtn');
            const selectionPanel = document.getElementById('selectionPanel');
            const selectionList = document.getElementById('selectionList');
            const selectionCount = document.getElementById('selectionCount');
            const panelToggle = document.getElementById('panelToggle');
            
            // Create a simple map
            const map = new Map({
                basemap: "hybrid" // Satellite imagery with roads and labels
            });
            
            console.log("Map created");
            
            try {
                // Create the map view
                const view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-98.5795, 39.8283], // Center of US
                    zoom: 4
                });
                
                console.log("View created");
                
                // Status element
                const status = document.getElementById('status');
                
                // Flag to track if the initial map load is complete
                let initialLoadComplete = false;
                
                // Create the PSAP feature layer with improved visibility
                const psapLayer = new FeatureLayer({
                    url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/psap_2017/FeatureServer",
                    outFields: ["*"],
                    opacity: 0.85, // Increased overall opacity
                    renderer: {
                        type: "simple",
                        symbol: {
                            type: "simple-fill",
                            color: [41, 168, 221, 0.4], // Safety blue with improved opacity
                            outline: {
                                color: [0, 21, 89, 1], // Royal blue with full opacity
                                width: 1.5 // Thicker border for better visibility
                            }
                        }
                    },
                    // Enable popup for the layer
                    popupEnabled: true,
                    // Add a popup template to display all attributes
                    popupTemplate: {
                        title: "{psap_name}",
                        content: [
                            {
                                type: "fields",
                                fieldInfos: [
                                    { fieldName: "ogc_fid", label: "OGC FID" },
                                    { fieldName: "name", label: "Name" },
                                    { fieldName: "psap_name", label: "PSAP Name" },
                                    { fieldName: "fcc_id", label: "FCC ID" },
                                    { fieldName: "telephone", label: "Telephone" },
                                    { fieldName: "state", label: "State" },
                                    { fieldName: "account_id", label: "Account ID" },
                                    { fieldName: "state_1", label: "State (Alt)" }
                                ]
                            }
                        ]
                    }
                });
                
                console.log("PSAP layer created");
                
                // Add the layer to the map
                map.add(psapLayer);
                
                // When view is ready
                view.when(function() {
                    status.textContent = "Map loaded successfully!";
                    console.log("View ready");
                    
                    // Create and configure the search widget
                    const searchWidget = new Search({
                        view: view,
                        container: "searchDiv",
                        includeDefaultSources: false,
                        sources: [
                            {
                                layer: psapLayer,
                                searchFields: ["state", "psap_name", "account_id", "name"],
                                displayField: "psap_name",
                                exactMatch: false,
                                outFields: ["*"],
                                name: "PSAP Locations",
                                placeholder: "Search by name, ID, or location",
                                maxResults: 10,
                                maxSuggestions: 10,
                                suggestionsEnabled: true,
                                minSuggestCharacters: 2
                            }
                        ]
                    });
                    
                    // Add a debug message to see field names
                    psapLayer.when(function() {
                        psapLayer.queryFeatures({
                            where: "1=1",
                            returnGeometry: false,
                            outFields: ["*"],
                            num: 1
                        }).then(function(results) {
                            if (results && results.features && results.features.length > 0) {
                                console.log("Field names in layer:", Object.keys(results.features[0].attributes));
                            }
                        }).catch(function(error) {
                            console.error("Error querying field names:", error);
                        });
                    });
                    
                    // Create a layerView variable we'll use for highlighting
                    let psapLayerView;
                    
                    // Set highlight options globally to ensure consistency
                    const highlightOptions = {
                        color: [255, 243, 0, 0.8],   // Safety Gap yellow with very high opacity
                        haloColor: [0, 94, 255],     // Glow blue from brand colors
                        haloOpacity: 1.0,            // Full opacity for halo
                        fillOpacity: 0.8,            // Higher fill opacity for better visibility
                        haloSize: 3                  // Larger halo for enhanced visibility
                    };
                    
                    // Create a feature filter for highlighting selected features
                    let featureFilter = { objectIds: [] };
                    
                    // Helper function to get feature name
                    function getFeatureName(attributes) {
                        return attributes.psap_name || attributes.name || 'Unknown PSAP';
                    }
                    
                    // Helper function to get feature ID
                    function getFeatureId(feature) {
                        return feature.attributes.ogc_fid || 
                               feature.attributes.OBJECTID || 
                               feature.attributes.FID || 
                               JSON.stringify(feature.attributes);
                    }
                    
                    // Update selection panel display
                    function updateSelectionPanel() {
                        selectionCount.textContent = selectedFeatures.length;
                        downloadBtn.textContent = `üì• Download Selected (${selectedFeatures.length})`;

                        if (selectedFeatures.length > 0) {
                            selectionPanel.style.display = 'block';
                            downloadBtn.disabled = false;
                            clearBtn.disabled = false;
                        } else {
                            selectionPanel.style.display = 'none';
                            downloadBtn.disabled = true;
                            clearBtn.disabled = true;
                        }

                        // Clear and rebuild selection list
                        selectionList.innerHTML = '';

                        selectedFeatures.forEach((feature, index) => {
                            const psapName = getFeatureName(feature.attributes);
                            
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'selected-item';

                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'item-name';
                            nameSpan.textContent = psapName;

                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-btn';
                            removeBtn.textContent = '√ó';
                            removeBtn.title = 'Remove from selection';
                            removeBtn.onclick = () => removeFromSelection(index);

                            itemDiv.appendChild(nameSpan);
                            itemDiv.appendChild(removeBtn);
                            selectionList.appendChild(itemDiv);
                        });
                    }
                    
                    // Highlight handle to store references to highlights
                    let currentHighlights = [];
                    
                    // Highlight selected features with a robust persistent approach
                    function highlightSelectedFeatures() {
                        if (!psapLayerView || !initialLoadComplete) return;
                        
                        console.log("Applying highlights to", selectedFeatures.length, "features");
                        
                        try {
                            // Apply the globally defined highlight options with enhanced visibility
                            psapLayerView.highlightOptions = highlightOptions;
                            
                            // Clear any existing highlights first
                            psapLayerView.highlight();
                            
                            // Reset any feature effects to ensure all polygons are visible
                            psapLayerView.featureEffect = null;
                            
                            // Extract object IDs from the selected features
                            const objectIds = selectedFeatures.map(feature => {
                                return feature.attributes.ogc_fid || 
                                      feature.attributes.OBJECTID || 
                                      feature.attributes.FID;
                            }).filter(id => id !== undefined);
                            
                            console.log("Selected object IDs:", objectIds);
                            
                            // Apply highlight if we have selected features
                            if (objectIds.length > 0) {
                                // Force highlightOptions to be applied again for extra persistence
                                psapLayerView.highlightOptions = {...highlightOptions};
                                
                                // Apply the highlight with a slight delay to ensure it takes effect
                                setTimeout(() => {
                                    psapLayerView.highlight(objectIds);
                                    console.log("Highlight applied to", objectIds.length, "features");
                                }, 50);
                            }
                        } catch (error) {
                            console.error("Error in highlightSelectedFeatures:", error);
                        }
                    }
                    
                    // Remove a feature from selection
                    function removeFromSelection(index) {
                        if (index >= 0 && index < selectedFeatures.length) {
                            // Remove from array
                            selectedFeatures.splice(index, 1);
                            
                            // Update highlights
                            highlightSelectedFeatures();
                            
                            // Update the panel
                            updateSelectionPanel();
                            
                            // Status message
                            status.textContent = "Removed feature from selection";
                        }
                    }
                    
                    // Clear all selections
                    function clearAllSelections() {
                        // Clear the array
                        selectedFeatures = [];
                        
                        // Clear highlights
                        if (psapLayerView) {
                            psapLayerView.highlight();
                            psapLayerView.featureEffect = null; // Also clear the feature effect
                        }
                        
                        // Update the panel
                        updateSelectionPanel();
                        
                        // Status message
                        status.textContent = "Cleared all selections";
                    }
                    
                    // Convert ArcGIS geometry to GeoJSON with projection
                    async function convertToGeoJSON(geometry) {
                        try {
                            // Create target spatial reference (WGS84 / EPSG:4326)
                            const wgs84 = new SpatialReference({ wkid: 4326 });

                            let projectedGeometry = geometry;

                            // Check if geometry needs projection
                            if (geometry.spatialReference && geometry.spatialReference.wkid !== 4326) {
                                console.log(`Projecting from EPSG:${geometry.spatialReference.wkid} to EPSG:4326`);

                                // Load projection engine if not already loaded
                                await projection.load();

                                // Project geometry to WGS84
                                projectedGeometry = projection.project(geometry, wgs84);
                            }

                            // Convert to GeoJSON coordinate format
                            if (projectedGeometry.rings) {
                                // Polygon geometry
                                return projectedGeometry.rings.map(ring =>
                                    ring.map(coord => [coord[0], coord[1]])
                                );
                            }

                            return [];
                        } catch (error) {
                            console.error('Error converting geometry coordinates:', error);
                            console.log('Falling back to original coordinates');

                            // Fallback to original method if projection fails
                            if (geometry.rings) {
                                return geometry.rings.map(ring =>
                                    ring.map(coord => [coord[0], coord[1]])
                                );
                            }
                            return [];
                        }
                    }
                    
                    // Click event for feature selection
                    view.on("click", function(event) {
                        // Get the features at the clicked location
                        view.hitTest(event).then(function(response) {
                            // Find PSAP features from the hitTest results
                            const psapResult = response.results.find(result => 
                                result.graphic && result.graphic.layer === psapLayer
                            );
                            
                            if (psapResult) {
                                const clickedFeature = psapResult.graphic;
                                const featureId = getFeatureId(clickedFeature);
                                
                                // Check if already selected
                                const existingIndex = selectedFeatures.findIndex(f => 
                                    getFeatureId(f) === featureId
                                );
                                
                                if (existingIndex >= 0) {
                                    // Already selected, so remove it
                                    removeFromSelection(existingIndex);
                                } else {
                                    // Add to selection
                                    selectedFeatures.push(clickedFeature);
                                    highlightSelectedFeatures();
                                    updateSelectionPanel();
                                    
                                    // Status message
                                    status.textContent = `Selected ${getFeatureName(clickedFeature.attributes)}`;
                                }
                            }
                        });
                    });
                    
                    // Get a reference to the layer view for highlighting
                    view.whenLayerView(psapLayer).then(function(layerView) {
                        psapLayerView = layerView;
                        console.log("Layer view created for selection highlighting");
                        
                        // Set the highlight options immediately
                        psapLayerView.highlightOptions = highlightOptions;
                        
                        // Make sure to clear any potential auto-highlighting on load
                        psapLayerView.highlight();
                        
                        // Only after the map is fully loaded should we allow highlighting
                        setTimeout(function() {
                            initialLoadComplete = true;
                            console.log("Initial load complete, highlighting enabled");
                            
                            // Apply any existing highlights if the map is refreshed and we have selections
                            if (selectedFeatures.length > 0) {
                                highlightSelectedFeatures();
                            }
                        }, 1000);
                        
                        // Watch for suspended state changes (when layer view is suspended during map interaction)
                        layerView.watch("suspended", function(suspended) {
                            if (!suspended && selectedFeatures.length > 0) {
                                console.log("Layer view no longer suspended, reapplying highlights");
                                setTimeout(function() {
                                    highlightSelectedFeatures();
                                }, 100);
                            }
                        });
                    }).catch(function(error) {
                        console.error("Error creating layer view:", error);
                    });
                    
                    // Re-apply highlights when the view is updated (zoom, pan, etc.)
                    view.watch("stationary", function(isStationary) {
                        if (isStationary && initialLoadComplete && selectedFeatures.length > 0) {
                            // Small delay to ensure the view has completely settled
                            setTimeout(function() {
                                console.log("View is stationary, reapplying highlights");
                                highlightSelectedFeatures();
                            }, 250); // Longer delay to ensure map is fully settled
                        }
                    });
                    
                    // Re-apply highlights when extent changes (zoom/pan)
                    view.watch("extent", function() {
                        if (initialLoadComplete && selectedFeatures.length > 0) {
                            // Apply highlights after extent change is complete
                            setTimeout(function() {
                                highlightSelectedFeatures();
                            }, 300);
                        }
                    });
                    
                    // Reapply highlights when the scale changes
                    view.watch("scale", function() {
                        if (initialLoadComplete && selectedFeatures.length > 0) {
                            setTimeout(function() {
                                console.log("Scale changed, reapplying highlights");
                                highlightSelectedFeatures();
                            }, 200);
                        }
                    });
                    
                    // Also check for highlights at regular intervals to ensure they're maintained
                    setInterval(function() {
                        if (initialLoadComplete && selectedFeatures.length > 0) {
                            console.log("Interval check, ensuring highlights are maintained");
                            highlightSelectedFeatures();
                        }
                    }, 2000); // Check every 2 seconds
                    
                    // Panel toggle functionality
                    panelToggle.addEventListener('click', function() {
                        const content = document.querySelector('.panel-content');
                        const footer = document.querySelector('.panel-footer');

                        if (content.style.display === 'none') {
                            content.style.display = 'block';
                            footer.style.display = 'block';
                            panelToggle.textContent = '‚àí';
                        } else {
                            content.style.display = 'none';
                            footer.style.display = 'none';
                            panelToggle.textContent = '+';
                        }
                    });
                    
                    // Download button functionality
                    downloadBtn.addEventListener('click', async function() {
                        if (selectedFeatures.length === 0) {
                            alert('No PSAPs selected');
                            return;
                        }
                        
                        try {
                            status.textContent = 'Preparing download...';
                            
                            // Process each selected feature
                            const features = await Promise.all(selectedFeatures.map(async (feature) => {
                                // Convert coordinates with proper projection
                                const coordinates = await convertToGeoJSON(feature.geometry);

                                // Get original spatial reference information
                                const originalSR = feature.geometry.spatialReference;
                                const originalWkid = originalSR ? originalSR.wkid : 'Unknown';
                                
                                return {
                                    type: "Feature",
                                    geometry: {
                                        type: feature.geometry.type === "polygon" ? "Polygon" : "MultiPolygon",
                                        coordinates: coordinates
                                    },
                                    properties: {
                                        ...feature.attributes,
                                        // Add metadata
                                        export_metadata: {
                                            exported_date: new Date().toISOString(),
                                            original_crs_wkid: originalWkid,
                                            target_crs: 'EPSG:4326',
                                            target_crs_name: 'WGS 84'
                                        }
                                    }
                                };
                            }));
                            
                            // Create GeoJSON object
                            const geoJSON = {
                                type: "FeatureCollection",
                                crs: {
                                    type: "name",
                                    properties: {
                                        name: "urn:ogc:def:crs:EPSG::4326"
                                    }
                                },
                                metadata: {
                                    exported_by: "RapidSOS PSAP Map",
                                    export_date: new Date().toISOString(),
                                    coordinate_system: {
                                        epsg_code: 4326,
                                        name: "WGS 84"
                                    },
                                    feature_count: features.length
                                },
                                features: features
                            };

                            // Create and download the file
                            const dataStr = JSON.stringify(geoJSON, null, 2);
                            const dataBlob = new Blob([dataStr], {type: 'application/json'});
                            const url = URL.createObjectURL(dataBlob);

                            console.log("Created download URL:", url);
                            console.log("GeoJSON structure (first feature):", features[0]);

                            const downloadLink = document.createElement('a');
                            downloadLink.href = url;

                            // Create filename with timestamp
                            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                            const filename = `psap_boundaries_${selectedFeatures.length}_polygons_WGS84_${timestamp}.geojson`;

                            downloadLink.download = filename;

                            // Force the download to happen
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                            URL.revokeObjectURL(url);

                            status.textContent = `Downloaded ${selectedFeatures.length} PSAP boundary polygons in WGS84 format`;
                        } catch (error) {
                            console.error('Error downloading polygons:', error);
                            alert('Error downloading polygons. Please try again.');
                            status.textContent = 'Error during download';
                        }
                    });
                    
                    // Clear selection button
                    clearBtn.addEventListener('click', function() {
                        clearAllSelections();
                    });
                    
                    console.log("Search widget and selection tools created");
                    
                    // Wait for PSAP layer to load
                    psapLayer.when(function() {
                        status.textContent = "PSAP data loaded!";
                        console.log("PSAP layer loaded");
                    }).catch(function(error) {
                        status.textContent = "Error loading PSAP layer";
                        console.error("PSAP layer error:", error);
                    });
                }).catch(function(error) {
                    status.textContent = "Error loading map view";
                    console.error("View error:", error);
                });
            } catch (e) {
                console.error("Error in map initialization:", e);
                document.getElementById('status').textContent = "Error initializing map: " + e.message;
            }
        });
    </script>
</body>
</html>
