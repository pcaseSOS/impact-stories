<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Canada JBF Creator - Shape Drawing Tool</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }
        
        /* Search bar styles */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .search-input-container {
            display: flex;
            width: 100%;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .search-button {
            background: #0079c1;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .search-button:hover {
            background: #005a87;
        }
        
        .search-results {
            background: white;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background: #f0f0f0;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }

        .toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar button {
            background: #0079c1;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 180px;
            text-align: left;
        }

        .toolbar button:hover {
            background: #005a87;
        }

        .toolbar button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .toolbar button.active {
            background: #28a745;
        }

        .toolbar button.danger {
            background: #dc3545;
        }

        .toolbar button.danger:hover {
            background: #c82333;
        }

        #drawingTools {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            padding: 15px;
        }

        .drawing-panel-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .drawing-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawing-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drawing-option input[type=radio] {
            margin: 0;
        }

        .drawing-option label {
            cursor: pointer;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            word-wrap: break-word;
        }
        
        .tooltip-title {
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 3px;
        }
        
        .tooltip-content {
            font-size: 11px;
            line-height: 1.4;
        }

        #infoPanel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 300px;
            z-index: 100;
        }

        .info-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .info-content {
            font-size: 14px;
            color: #555;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div id="viewDiv"></div>
    
    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-input-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for a PSAP...">
            <button class="search-button" id="searchButton">üîç</button>
        </div>
        <div class="search-results" id="searchResults">
            <!-- Search results will appear here -->
        </div>
    </div>

    <!-- Drawing Tools Panel -->
    <div id="drawingTools">
        <div class="drawing-panel-header">Drawing Tools</div>
        <div class="drawing-options">
            <div class="drawing-option">
                <input type="radio" id="navigateMap" name="drawingTool" value="navigate" checked>
                <label for="navigateMap">Navigate Map</label>
            </div>
            <div class="drawing-option">
                <input type="radio" id="drawPolygon" name="drawingTool" value="polygon">
                <label for="drawPolygon">Draw Polygon</label>
            </div>
            <div class="drawing-option">
                <input type="radio" id="drawLine" name="drawingTool" value="polyline">
                <label for="drawLine">Draw Line</label>
            </div>
            <div class="drawing-option">
                <input type="radio" id="drawPoint" name="drawingTool" value="point">
                <label for="drawPoint">Draw Point</label>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <button id="clearBtn" disabled>üóëÔ∏è Clear Drawing</button>
        <button id="downloadBtn" disabled>üíæ Download GeoJSON</button>
        <button id="downloadFeaturesBtn" disabled>üì• Download Selected PSAPs</button>
    </div>

    <div id="status">Select a drawing tool and start drawing on the map</div>

    <div id="infoPanel">
        <div class="info-title">How to Use This Tool</div>
        <div class="info-content">
            <p><strong>Navigation:</strong> Pan and zoom the map</p>
            <p><strong>Selection:</strong> Click on a PSAP to select it</p>
            <p><strong>Search:</strong> Find PSAPs by name or FCC ID</p>
            <p><strong>Drawing:</strong> Choose a drawing tool to create shapes</p>
            <p><strong>Download:</strong> Get selected PSAPs or drawn shapes as GeoJSON</p>
            <p>All exported data will be in WGS84 projection (EPSG:4326)</p>
        </div>
    </div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/geometry/projection",
            "esri/geometry/SpatialReference",
            "esri/geometry/support/webMercatorUtils",
            "esri/layers/FeatureLayer"
        ], function(Map, MapView, Sketch, GraphicsLayer, projection, SpatialReference, webMercatorUtils, FeatureLayer) {
            // Create a graphics layer for the drawn features
            const graphicsLayer = new GraphicsLayer({
                title: "User Drawings"
            });

            // Create the map
            const map = new Map({
                basemap: "streets-navigation-vector"
            });
            
            // Add PSAP 2017 reference layer
            const psapLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/psap_2017/FeatureServer",
                outFields: ["*"],
                opacity: 0.6,
                title: "PSAP 2017"
            });
            
            // Add the reference layer to the map
            map.add(psapLayer);

            // Add the graphics layer to the map
            map.add(graphicsLayer);

            // Create the map view
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-106.3468, 56.1304], // Center of Canada
                zoom: 4
            });

            // UI Elements
            const clearBtn = document.getElementById('clearBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadFeaturesBtn = document.getElementById('downloadFeaturesBtn');
            const status = document.getElementById('status');
            const drawingOptions = document.querySelectorAll('input[name="drawingTool"]');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');
            
            // Variables to track selected PSAPs
            let selectedPSAPs = [];
            let highlightedPSAPs = [];

            // Create sketch widget
            const sketch = new Sketch({
                layer: graphicsLayer,
                view: view,
                creationMode: "single",
                defaultCreateOptions: {
                    mode: "hybrid" // freehand and click-by-click drawing
                },
                visible: false // Hide it initially as we start in navigation mode
            });

            // Add the sketch widget to the view
            view.ui.add(sketch, "top-left");

            // Function to convert graphics to GeoJSON
            async function graphicsToGeoJSON() {
                // Get all graphics from the layer
                const graphics = graphicsLayer.graphics.toArray();
                
                if (graphics.length === 0) {
                    return null;
                }
                
                // Load the projection module if needed
                await projection.load();
                
                // Convert features to GeoJSON
                const features = await Promise.all(graphics.map(async graphic => {
                    // Ensure the geometry is in WGS84 (EPSG:4326)
                    let geometry = graphic.geometry;
                    
                    // Convert to WGS84 if needed
                    if (geometry.spatialReference.wkid !== 4326) {
                        try {
                            // Try using webMercatorUtils for common conversions
                            if (webMercatorUtils.canProject(geometry)) {
                                geometry = webMercatorUtils.webMercatorToGeographic(geometry);
                            } else {
                                // Use the projection engine for other projections
                                const wgs84 = new SpatialReference({ wkid: 4326 });
                                geometry = projection.project(geometry, wgs84);
                            }
                        } catch (error) {
                            console.error("Projection error:", error);
                            status.textContent = "Error projecting to WGS84";
                        }
                    }
                    
                    // Create a GeoJSON Feature
                    const feature = {
                        type: "Feature",
                        properties: {},
                        geometry: {
                            type: getGeoJSONGeometryType(geometry.type),
                            coordinates: getGeoJSONCoordinates(geometry)
                        }
                    };
                    
                    return feature;
                }));
                
                // Create a GeoJSON FeatureCollection
                const featureCollection = {
                    type: "FeatureCollection",
                    features: features
                };
                
                return featureCollection;
            }
            
            // Helper function to get GeoJSON geometry type
            function getGeoJSONGeometryType(esriType) {
                switch (esriType) {
                    case "point":
                        return "Point";
                    case "polyline":
                        return "LineString";
                    case "polygon":
                        return "Polygon";
                    default:
                        return "Polygon";
                }
            }
            
            // Helper function to get coordinates in GeoJSON format
            function getGeoJSONCoordinates(geometry) {
                if (geometry.type === "point") {
                    return [geometry.x, geometry.y];
                } else if (geometry.type === "polyline") {
                    return geometry.paths[0];
                } else if (geometry.type === "polygon") {
                    return geometry.rings;
                }
                return [];
            }
            
            // Function to download GeoJSON
            async function downloadGeoJSON() {
                const geojson = await graphicsToGeoJSON();
                
                if (!geojson) {
                    status.textContent = "No drawings to download";
                    return;
                }
                
                // Create a download link
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "map_drawing.geojson");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                status.textContent = "GeoJSON downloaded successfully";
            }
            
            // Function to clear all drawings
            function clearDrawings() {
                graphicsLayer.removeAll();
                clearBtn.disabled = true;
                downloadBtn.disabled = true;
                status.textContent = "Drawing cleared. Select a drawing tool and start drawing on the map";
            }
            
            // Function to handle PSAP selection
            function selectPSAP(feature) {
                // Check if already selected
                const existingIndex = selectedPSAPs.findIndex(f => 
                    f.attributes.OBJECTID === feature.attributes.OBJECTID
                );
                
                if (existingIndex < 0) {
                    // Not already selected, add it
                    selectedPSAPs.push(feature);
                    
                    // Highlight selected feature
                    view.whenLayerView(psapLayer).then(function(layerView) {
                        const highlight = layerView.highlight(feature);
                        highlightedPSAPs.push(highlight);
                    });
                    
                    // Enable download button if we have selections
                    downloadFeaturesBtn.disabled = false;
                    
                    status.textContent = `Selected PSAP: ${getPSAPName(feature.attributes)}. Total: ${selectedPSAPs.length}`;
                }
            }
            
            // Function to clear PSAP selections
            function clearPSAPSelections() {
                // Remove all highlights
                highlightedPSAPs.forEach(highlight => {
                    if (highlight) highlight.remove();
                });
                
                selectedPSAPs = [];
                highlightedPSAPs = [];
                downloadFeaturesBtn.disabled = true;
                status.textContent = "All PSAP selections cleared";
            }
            
            // Helper function to get PSAP name from attributes
            function getPSAPName(attributes) {
                return attributes.NAME || attributes.name || attributes.PSAP_NAME || attributes.FCCID || 'Unknown PSAP';
            }
            
            // Function to create tooltip content for a PSAP
            function createPSAPTooltipContent(attributes) {
                let content = '<div class="tooltip-title">' + getPSAPName(attributes) + '</div>';
                content += '<div class="tooltip-content">';
                
                if (attributes.FCCID) {
                    content += `<strong>FCC ID:</strong> ${attributes.FCCID}<br>`;
                }
                
                if (attributes.STATE) {
                    content += `<strong>State:</strong> ${attributes.STATE}<br>`;
                }
                
                if (attributes.COUNTY) {
                    content += `<strong>County:</strong> ${attributes.COUNTY}<br>`;
                }
                
                content += '</div>';
                return content;
            }
            
            // Function to convert PSAP features to GeoJSON and download
            async function downloadSelectedPSAPs() {
                if (selectedPSAPs.length === 0) {
                    status.textContent = "No PSAPs selected for download";
                    return;
                }
                
                // Load the projection module if needed
                await projection.load();
                
                // Convert features to GeoJSON
                const features = await Promise.all(selectedPSAPs.map(async feature => {
                    // Ensure the geometry is in WGS84 (EPSG:4326)
                    let geometry = feature.geometry;
                    
                    // Convert to WGS84 if needed
                    if (geometry.spatialReference.wkid !== 4326) {
                        try {
                            // Try using webMercatorUtils for common conversions
                            if (webMercatorUtils.canProject(geometry)) {
                                geometry = webMercatorUtils.webMercatorToGeographic(geometry);
                            } else {
                                // Use the projection engine for other projections
                                const wgs84 = new SpatialReference({ wkid: 4326 });
                                geometry = projection.project(geometry, wgs84);
                            }
                        } catch (error) {
                            console.error("Projection error:", error);
                            status.textContent = "Error projecting to WGS84";
                        }
                    }
                    
                    // Create a GeoJSON Feature with properties
                    const geoJsonFeature = {
                        type: "Feature",
                        properties: {},
                        geometry: {
                            type: "Polygon",
                            coordinates: geometry.rings
                        }
                    };
                    
                    // Copy attributes to properties
                    Object.keys(feature.attributes).forEach(key => {
                        geoJsonFeature.properties[key] = feature.attributes[key];
                    });
                    
                    return geoJsonFeature;
                }));
                
                // Create a GeoJSON FeatureCollection
                const featureCollection = {
                    type: "FeatureCollection",
                    features: features
                };
                
                // Create a download link
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(featureCollection, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "selected_psaps.geojson");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                status.textContent = `Downloaded ${selectedPSAPs.length} selected PSAPs as GeoJSON`;
            }
            
            // Function to search for PSAPs
            function searchPSAPs(searchText) {
                if (!searchText.trim()) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                const query = psapLayer.createQuery();
                // Use wildcards to find partial matches
                const searchPattern = searchText.replace(/\s+/g, '%');
                let whereClause = '';
                
                // Search in name and ID fields
                whereClause = `UPPER(NAME) LIKE UPPER('%${searchPattern}%') OR UPPER(FCCID) LIKE UPPER('%${searchPattern}%')`;
                
                query.where = whereClause;
                query.outFields = ['*'];
                query.returnGeometry = true;
                query.num = 10; // Limit to 10 results
                
                psapLayer.queryFeatures(query).then(function(result) {
                    // Clear previous results
                    searchResults.innerHTML = '';
                    
                    if (result.features.length > 0) {
                        searchResults.style.display = 'block';
                        
                        // Create result items
                        result.features.forEach(feature => {
                            const psapName = getPSAPName(feature.attributes);
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.textContent = psapName;
                            
                            // Add click event to zoom to the PSAP
                            resultItem.addEventListener('click', function() {
                                // Zoom to the feature
                                view.goTo({
                                    target: feature.geometry,
                                    zoom: 10
                                }, {
                                    duration: 1000,
                                    easing: 'ease-out'
                                }).then(function() {
                                    // Select the PSAP
                                    selectPSAP(feature);
                                    
                                    // Show status message
                                    status.textContent = `Zoomed to: ${psapName}`;
                                });
                                
                                // Hide search results
                                searchResults.style.display = 'none';
                            });
                            
                            searchResults.appendChild(resultItem);
                        });
                    } else {
                        searchResults.style.display = 'block';
                        const noResults = document.createElement('div');
                        noResults.className = 'search-result-item';
                        noResults.textContent = 'No matching PSAPs found';
                        searchResults.appendChild(noResults);
                    }
                }).catch(function(error) {
                    console.error('Search error:', error);
                    status.textContent = 'Error searching for PSAPs';
                });
            }
            
            // Event listeners
            clearBtn.addEventListener('click', clearDrawings);
            downloadBtn.addEventListener('click', downloadGeoJSON);
            downloadFeaturesBtn.addEventListener('click', downloadSelectedPSAPs);
            
            // Search button click event
            searchButton.addEventListener('click', function() {
                searchPSAPs(searchInput.value);
            });
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchPSAPs(searchInput.value);
                }
            });
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.search-container')) {
                    searchResults.style.display = 'none';
                }
            });
            
            // Show search results when input is focused
            searchInput.addEventListener('focus', function() {
                if (searchInput.value.trim() && searchResults.children.length > 0) {
                    searchResults.style.display = 'block';
                }
            });
            
            // Search as you type (with debounce)
            let debounceTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(function() {
                    searchPSAPs(searchInput.value);
                }, 300); // 300ms delay
            });
            
            // Handle drawing option changes
            drawingOptions.forEach(option => {
                option.addEventListener('change', function() {
                    if (this.checked) {
                        if (this.value === 'navigate') {
                            // Hide sketch widget, enable navigation mode
                            sketch.visible = false;
                            status.textContent = "Navigation mode - click and drag to pan, mouse wheel to zoom";
                        } else {
                            // Show sketch widget, start drawing
                            sketch.visible = true;
                            sketch.create(this.value);
                            status.textContent = `Drawing ${this.value} - click on the map to start`;
                        }
                    }
                });
            });
            
            // Listen for sketch events
            sketch.on("create", function(event) {
                if (event.state === "complete") {
                    // Enable the clear and download buttons
                    clearBtn.disabled = false;
                    downloadBtn.disabled = false;
                    status.textContent = "Drawing complete - click Download to save as GeoJSON";
                    
                    // Start a new drawing of the same type
                    const selectedTool = document.querySelector('input[name="drawingTool"]:checked').value;
                    sketch.create(selectedTool);
                }
            });
            
            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);
            
            // Handle mouse move for hover effect on PSAPs
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    if (response.results.length > 0 &&
                        response.results[0].graphic.layer === psapLayer) {
                        
                        const graphic = response.results[0].graphic;
                        
                        // Show tooltip with PSAP info
                        tooltip.innerHTML = createPSAPTooltipContent(graphic.attributes);
                        tooltip.style.display = 'block';
                        tooltip.style.left = event.x + 15 + 'px';
                        tooltip.style.top = event.y - 15 + 'px';
                        
                        view.container.style.cursor = "pointer";
                    } else {
                        tooltip.style.display = 'none';
                        view.container.style.cursor = "default";
                    }
                });
            });
            
            // Handle mouse leave
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
                view.container.style.cursor = "default";
            });
            
            // Handle click for PSAP selection
            view.on("click", function(event) {
                // Only handle clicks in navigation mode
                const currentMode = document.querySelector('input[name="drawingTool"]:checked').value;
                if (currentMode !== 'navigate') return;
                
                view.hitTest(event).then(function(response) {
                    if (response.results.length > 0 &&
                        response.results[0].graphic.layer === psapLayer) {
                        
                        const graphic = response.results[0].graphic;
                        selectPSAP(graphic);
                    }
                });
            });
            
            // Wait for the view to load
            view.when(function() {
                // Start with navigation mode
                sketch.visible = false;
                
                // Set initial status
                status.textContent = "Navigation mode - click a PSAP to select it or search by name";
            });
        });
    </script>
</body>
</html>
