<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Building Outline Mapper</title>
    <style>
        /* Ensure map container takes full viewport */
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        /* Position the map container */
        #viewDiv {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
        
        /* Instructions panel */
        #instructions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            max-width: 300px;
            max-height: 70vh;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.4;
        }
        
        #instructions h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        #instructions ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        #instructions li {
            margin-bottom: 8px;
        }
        
        /* Help button */
        .help-button {
            background: #0079c1;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            width: 100%;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        
        .help-button:hover {
            background: #005e95;
        }
        
        #toggleInstructions {
            background: #0079c1;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
        }
        
        #toggleInstructions:hover {
            background: #005e95;
        }
        
        /* Ensure popups are always on top */
        .esri-popup {
            z-index: 1002 !important;
        }
        
        /* Make sure the building info dialog is on top */
        #buildingInfo {
            z-index: 1003 !important;
        }
        
        .hidden {
            display: none;
        }
        
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        #topbar {
            background: #fff;
            padding: 10px;
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Toolbar styles */
        #topbar {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        /* Make sure toolbar buttons are clickable */
        #topbar button, 
        #topbar .esri-widget,
        #topbar .esri-component {
            pointer-events: auto;
            margin: 2px 0;
            padding: 6px 8px;
            font-size: 13px;
        }

        .tool-button {
            padding: 8px 12px;
            background: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tool-button.active {
            background: #0079c1;
            color: white;
            border-color: #005e95;
        }

        #search {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1;
            width: 300px;
        }

        #search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        #status {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            z-index: 1;
            font-size: 14px;
        }

        .esri-ui-top-right {
            top: 60px !important;
        }
        
        /* Building info window styles */
        #buildingInfo {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1001;
            width: 320px;
            max-width: 90vw;
        }
        
        #buildingInfo h3 {
            margin-top: 0;
            color: #333;
        }
        
        #buildingInfo label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        
        #buildingInfo input, #buildingInfo textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #buildingInfo button {
            background: #0079c1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #buildingInfo button:hover {
            background: #005e95;
        }
        
        .building-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    
    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/Search",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/layers/WebTileLayer",
            "esri/Graphic",
            "esri/geometry/geometryEngine",
            "esri/widgets/Expand",
            "esri/widgets/BasemapToggle",
            "esri/widgets/BasemapGallery",
            "esri/geometry/geometryEngineAsync",
            "esri/geometry/Extent",
            "esri/geometry/Polygon",
            "esri/geometry/Point",
            "esri/geometry/support/webMercatorUtils",
            "esri/request"
        ], function(
            Map, MapView, Search, Sketch, GraphicsLayer, WebTileLayer, Graphic, geometryEngine, 
            Expand, BasemapToggle, BasemapGallery, geometryEngineAsync,
            Extent, Polygon, Point, webMercatorUtils, esriRequest
        ) {
            // Create a basic map with a default basemap
            const map = new Map({
                basemap: "streets-navigation-vector"
            });
            
            // Add Google Maps as a basemap
            const googleMapsAPIKey = "AIzaSyCzDGrRiILLXTXgVWH-37LpDu--8kjXz9I";
            if (googleMapsAPIKey) {
                const googleMapsLayer = new WebTileLayer({
                    urlTemplate: `https://mt1.google.com/vt/lyrs=m&x={col}&y={row}&z={level}&key=${googleMapsAPIKey}`,
                    copyright: "Google Maps"
                });
                
                const googleSatelliteLayer = new WebTileLayer({
                    urlTemplate: `https://mt1.google.com/vt/lyrs=s&x={col}&y={row}&z={level}&key=${googleMapsAPIKey}`,
                    copyright: "Google Satellite"
                });
                
                const googleHybridLayer = new WebTileLayer({
                    urlTemplate: `https://mt1.google.com/vt/lyrs=y&x={col}&y={row}&z={level}&key=${googleMapsAPIKey}`,
                    copyright: "Google Hybrid"
                });
                
                // Store custom basemaps for later use
                window.customBasemaps = {
                    "google-streets": {
                        baseLayers: [googleMapsLayer],
                        title: "Google Maps"
                    },
                    "google-satellite": {
                        baseLayers: [googleSatelliteLayer],
                        title: "Google Satellite"
                    },
                    "google-hybrid": {
                        baseLayers: [googleHybridLayer],
                        title: "Google Hybrid"
                    }
                };
            }

            // Create a view for the map
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 39.8283], // Center of the US
                zoom: 4,
                popup: {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: false,
                        breakpoint: false,
                        position: "top-right"
                    }
                },
                ui: {
                    components: ["attribution", "zoom"]
                },
                constraints: {
                    minZoom: 2
                }
            });
            
            // Add a basemap toggle for switching between different map types
            view.when(function() {
                const basemapToggle = new BasemapToggle({
                    view: view,
                    nextBasemap: "satellite"
                });
                
                // Add the basemap toggle to the UI
                view.ui.add(basemapToggle, "bottom-right");
            });

            const buildingFootprintsLayer = new GraphicsLayer();
            map.add(buildingFootprintsLayer);
            
            // Function to fetch building footprints from OSM
            async function fetchBuildingFootprints(extent) {
                // Convert extent to WGS84 for OSM query
                const wgs84Extent = webMercatorUtils.webMercatorToGeographic(extent);
                const [xmin, ymin, xmax, ymax] = [
                    wgs84Extent.xmin, 
                    wgs84Extent.ymin, 
                    wgs84Extent.xmax, 
                    wgs84Extent.ymax
                ];
                
                // Overpass API query for buildings
                const query = `
                    [out:json][timeout:25];
                    (
                      way[building](${ymin},${xmin},${ymax},${xmax});
                      relation[building](${ymin},${xmin},${ymax},${xmax});
                    );
                    (._;>;);
                    out body;
                `.replace(/\s+/g, ' ').trim();
                
                try {
                    const response = await esriRequest(
                        `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`,
                        { responseType: "json" }
                    );
                    
                    return response.data.elements || [];
                } catch (error) {
                    console.error("Error fetching building data:", error);
                    return [];
                }
            }
            
            // Function to process OSM data and create graphics
            function processOSMBuildings(elements) {
                // Clear previous footprints
                buildingFootprintsLayer.removeAll();
                
                const buildings = elements.filter(el => el.type === 'way' && el.tags && el.tags.building);
                let buildingCount = 0;
                
                buildings.forEach(building => {
                    if (building.nodes && building.nodes.length >= 3) {
                        // Convert OSM nodes to points
                        const points = building.nodes.map(nodeId => {
                            const node = elements.find(el => el.type === 'node' && el.id === nodeId);
                            return node ? [node.lon, node.lat] : null;
                        }).filter(Boolean);
                        
                        if (points.length >= 3) {
                            // Create a polygon graphic
                            const polygon = {
                                type: "polygon",
                                rings: [points.map(p => [p[0], p[1]])]
                            };
                            
                            // Get building name from OSM tags if available
                            const buildingName = building.tags.name || `Building ${building.id}`;
                            const buildingType = building.tags.building || 'building';
                            
                            const graphic = new Graphic({
                                geometry: polygon,
                                symbol: {
                                    type: "simple-fill",
                                    color: [0, 0, 255, 0.5],
                                    outline: {
                                        color: [0, 0, 200],
                                        width: 1
                                    }
                                },
                                attributes: {
                                    id: building.id,
                                    name: buildingName,
                                    type: buildingType,
                                    source: 'OSM',
                                    notes: '',
                                    area: geometryEngine.geodesicArea(polygon, "square-meters").toFixed(2) + " m²",
                                    timestamp: new Date().toISOString()
                                },
                                popupTemplate: {
                                    title: "{name}",
                                    content: [
                                        {
                                            type: "fields",
                                            fieldInfos: [
                                                { fieldName: "type", label: "Type" },
                                                { fieldName: "area", label: "Area" },
                                                { fieldName: "notes", label: "Notes" }
                                            ]
                                        }
                                    ]
                                }
                            });
                            
                            // Add click event to show edit dialog
                            graphic.on('click', (event) => {
                                if (editMode) {
                                    showBuildingInfo(graphic);
                                }
                            });
                            
                            buildingFootprintsLayer.add(graphic);
                            buildingCount++;
                        }
                    }
                });
                
                return buildingCount;
            }
            
            // Show building info dialog
            function showBuildingInfo(graphic) {
                const infoDiv = document.getElementById('buildingInfo');
                const nameInput = document.getElementById('buildingName');
                const notesInput = document.getElementById('buildingNotes');
                const saveBtn = document.getElementById('saveBuildingInfo');
                const cancelBtn = document.getElementById('cancelBuildingInfo');
                
                // Set current values
                nameInput.value = graphic.attributes.name || '';
                notesInput.value = graphic.attributes.notes || '';
                
                // Position the dialog
                infoDiv.style.display = 'block';
                
                // Save handler
                const saveHandler = () => {
                    graphic.attributes.name = nameInput.value.trim() || `Building ${graphic.attributes.id}`;
                    graphic.attributes.notes = notesInput.value.trim();
                    
                    // Update the popup title
                    if (graphic.popupTemplate) {
                        graphic.popupTemplate.title = graphic.attributes.name;
                    }
                    
                    infoDiv.style.display = 'none';
                    
                    // Clean up event listeners
                    saveBtn.removeEventListener('click', saveHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };
                
                // Cancel handler
                const cancelHandler = () => {
                    infoDiv.style.display = 'none';
                    
                    // Clean up event listeners
                    saveBtn.removeEventListener('click', saveHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };
                
                // Add event listeners
                saveBtn.addEventListener('click', saveHandler);
                cancelBtn.addEventListener('click', cancelHandler);
                
                // Close on escape key
                const keyHandler = (e) => {
                    if (e.key === 'Escape') {
                        cancelHandler();
                        document.removeEventListener('keydown', keyHandler);
                    }
                };
                document.addEventListener('keydown', keyHandler);
            }

            // Create a container for the search widget
            const searchContainer = document.createElement("div");
            searchContainer.id = "searchWidget";
            document.body.appendChild(searchContainer);
            
            // Initialize the search widget
            const searchWidget = new Search({
                view: view,
                container: searchContainer,
                includeDefaultSources: true,
                popupEnabled: false,
                popupOpenOnSelect: false,
                resultGraphicEnabled: false
            });
            
            // Position the search widget
            searchContainer.style.position = 'absolute';
            searchContainer.style.top = '15px';
            searchContainer.style.right = '15px';
            searchContainer.style.zIndex = '100';
            
            // Handle search completion
            searchWidget.on("search-complete", function(event) {
                if (event.results && event.results.length > 0) {
                    const result = event.results[0];
                    // Zoom to the search result
                    view.goTo({
                        target: result.extent || result.feature.geometry,
                        padding: 100
                    }).then(() => {
                        // Show a message to refresh buildings
                        document.getElementById('status').textContent = 
                            'Click "Refresh Buildings" to detect buildings in this area.';
                    });
                }
            });
            
            // Handle search errors
            searchWidget.on("search-error", function() {
                document.getElementById('status').textContent = 
                    'Search error. Please try a different location or check your connection.';
            });
            
            // Toggle instructions panel
            document.getElementById('toggleInstructions').addEventListener('click', function() {
                const content = document.getElementById('instructions-content');
                const button = document.getElementById('toggleInstructions');
                
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    button.textContent = 'Hide Help';
                    button.title = 'Hide help instructions';
                } else {
                    content.classList.add('hidden');
                    button.textContent = 'Show Help';
                    button.title = 'Show help instructions';
                }
            });
            
            // Initially hide the instructions
            document.getElementById('instructions-content').classList.add('hidden');
            document.getElementById('toggleInstructions').textContent = 'Show Help';
            document.getElementById('toggleInstructions').title = 'Show help instructions';

            // Create a layer for custom buildings
            const customBuildingsLayer = new GraphicsLayer();
            map.add(customBuildingsLayer);
            
            // Add a button to toggle between viewing and editing mode
            let editMode = false;
            const toggleEditMode = document.createElement('button');
            toggleEditMode.id = 'toggleEditMode';
            toggleEditMode.className = 'tool-button';
            toggleEditMode.innerHTML = '✏️ Toggle Edit Mode';
            toggleEditMode.title = 'Toggle between viewing and editing building footprints';
            toggleEditMode.addEventListener('click', () => {
                editMode = !editMode;
                if (editMode) {
                    toggleEditMode.classList.add('active');
                    document.getElementById('status').textContent = 
                        'Edit mode: ON. Click on buildings to edit them, or use the Draw tool to add new ones.';
                } else {
                    toggleEditMode.classList.remove('active');
                    document.getElementById('status').textContent = 'Edit mode: OFF';
                }
            });
            document.getElementById('topbar').appendChild(toggleEditMode);
            
            // Add a button to quickly switch to the most recent imagery
            const recentImageryBtn = document.createElement('button');
            recentImageryBtn.className = 'tool-button';
            recentImageryBtn.innerHTML = '🛰️ Show Newest Available Imagery';
            recentImageryBtn.title = 'Switch to the most recent imagery available for this area';
            recentImageryBtn.addEventListener('click', () => {
                // Switch to the Clarity basemap which often has newer imagery
                basemapGallery.activeBasemap = basemapGallery.source.items.find(
                    item => item.portalItem && item.portalItem.id === 'c8b0d7d5372944ac8c245b0d9a6733d9'
                );
                
                // Show a message
                document.getElementById('status').textContent = 
                    'Switched to Esri Clarity (Beta) which may have newer imagery. Check other basemaps if needed.';
                
                // Expand the basemap selector
                view.ui.find('basemap-gallery-expand').expand();
            });
            document.getElementById('topbar').appendChild(recentImageryBtn);

            // Initialize the sketch widget when the view is ready
            view.when(() => {
                sketch = new Sketch({
                    layer: sketchLayer,
                    view: view,
                    creationMode: "update",
                    availableCreateTools: ["polygon"],
                    container: document.createElement("div"),
                    defaultCreateOptions: {
                        mode: "hybrid"
                    }
                });

                // Create basemap gallery with additional options
                const basemapGallery = new BasemapGallery({
                    view: view,
                    container: document.createElement("div"),
                    source: [
                        {
                            portalItem: {
                                id: "10df2279f9684e4a9f6a7f08febac2a9"  // World Imagery
                            },
                            title: "Esri World Imagery"
                        },
                        {
                            portalItem: {
                                id: "b9d3190d1e474e5ab9455abda8990fb0"  // World Imagery with Labels
                            },
                            title: "Imagery with Labels"
                        },
                        ...(window.customBasemaps ? [
                            window.customBasemaps["google-streets"],
                            window.customBasemaps["google-satellite"],
                            window.customBasemaps["google-hybrid"]
                        ] : [])
                    ]
                });
                
                // Add the basemap gallery to the UI in a compact expand widget
                const bgExpand = new Expand({
                    view: view,
                    content: basemapGallery,
                    expandIcon: "basemap",
                    expandTooltip: "Change Basemap",
                    expandIconClass: "esri-icon-basemap",
                    group: "top-right"
                });
                
                view.ui.add(bgExpand, "top-right");
                
                // Add a button to check for newer imagery at current location
                const checkNewerImageryBtn = document.createElement('button');
                checkNewerImageryBtn.className = 'tool-button';
                checkNewerImageryBtn.innerHTML = '🔄 Check for Newer Imagery';
                checkNewerImageryBtn.title = 'Check for more recent satellite imagery at this location';
                checkNewerImageryBtn.addEventListener('click', () => {
                    // Show a message about checking for newer imagery
                    const status = document.getElementById('status');
                    status.textContent = 'Checking for newer imagery in this area...';
                    
                    // This is a simplified check - in a real app, you might query a service
                    // that provides metadata about available imagery dates
                    setTimeout(() => {
                        status.textContent = 'Tip: Try the "Esri Clarity" or "Maxar Premium" basemaps for potentially newer imagery in this area.';
                    }, 1000);
                    
                    // Scroll the basemap selector into view
                    basemapToggle.expand();
                });
                document.getElementById('topbar').appendChild(checkNewerImageryBtn);
                
                // Add a button to report outdated imagery
                const reportOutdatedBtn = document.createElement('button');
                reportOutdatedBtn.className = 'tool-button';
                reportOutdatedBtn.innerHTML = '⚠️ Report Outdated Imagery';
                reportOutdatedBtn.title = 'Report outdated or incorrect imagery to Esri';
                reportOutdatedBtn.addEventListener('click', () => {
                    // Get current map center
                    const center = view.center;
                    const zoom = view.zoom;
                    
                    // Create a URL to report outdated imagery to Esri
                    const reportUrl = `https://www.esri.com/en-us/arcgis/products/arcgis-online/imagery-updates`;
                    
                    // Open the reporting page in a new tab
                    window.open(reportUrl, '_blank');
                    
                    // Show a message
                    document.getElementById('status').textContent = 
                        'Please report outdated imagery through the Esri Imagery Updates page.';
                });
                document.getElementById('topbar').appendChild(reportOutdatedBtn);

                // Create the sketch widget
                let sketch;
                const sketchLayer = new GraphicsLayer();
                map.add(sketchLayer);
                
                // Update UI when the sketch is created
                sketch.on("create", function(event) {
                    if (event.state === "complete") {
                        // Convert the sketch to a graphic and add it to the graphics layer
                        const graphic = event.graphic.clone();
                        graphic.symbol = {
                            type: "simple-fill",
                            color: [255, 0, 0, 0.3],
                            style: "solid",
                            outline: {
                                color: [255, 0, 0],
                                width: 2
                            }
                        };
                        graphicsLayer.add(graphic);
                        
                        // Clear the sketch layer
                        sketchLayer.removeAll();
                        
                        // Update status
                        document.getElementById('status').textContent = 
                            `Building outline added. Total: ${graphicsLayer.graphics.length} buildings`;
                    }
                });

                // Update status when sketch is updated
                sketch.on("update", function(event) {
                    if (event.state === "complete") {
                        document.getElementById('status').textContent = 
                            `Building outline updated. Total: ${graphicsLayer.graphics.length} buildings`;
                    }
                });
            });

            // Toggle drawing mode
            document.getElementById('drawBtn').addEventListener('click', function() {
                if (this.classList.contains('active')) {
                    // Disable drawing
                    view.ui.remove(sketch);
                    this.classList.remove('active');
                    document.getElementById('status').textContent = "Drawing mode deactivated";
                } else {
                    // Enable drawing
                    view.ui.add(sketch, "top-right");
                    this.classList.add('active');
                    document.getElementById('status').textContent = "Click on the map to start drawing a building outline";
                }
            });

            // Clear all graphics
            document.getElementById('clearBtn').addEventListener('click', function() {
                if (confirm("Are you sure you want to clear all building outlines?")) {
                    graphicsLayer.removeAll();
                    document.getElementById('status').textContent = "All building outlines cleared";
                }
            });

            // Download the building outlines as GeoJSON
            document.getElementById('downloadBtn').addEventListener('click', function() {
                if (graphicsLayer.graphics.length === 0) {
                    alert("No building outlines to download");
                    return;
                }

                
                // Create a GeoJSON feature collection
                const featureCollection = {
                    type: "FeatureCollection",
                    features: graphicsLayer.graphics.map(g => ({
                        type: "Feature",
                        geometry: g.geometry.toJSON(),
                        properties: {
                            id: g.attributes?.id || Date.now(),
                            area: geometryEngine.geodesicArea(g.geometry, "square-meters").toFixed(2) + " m²"
                        }
                    }))
                };

                // Create a download link
                const dataStr = "data:text/json;charset=utf-8," + 
                    encodeURIComponent(JSON.stringify(featureCollection, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `building_outlines_${new Date().toISOString().split('T')[0]}.geojson`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                document.getElementById('status').textContent = `Downloaded ${graphicsLayer.graphics.length} building outlines`;
            });

            // Update status when the view is ready
            view.when(() => {
                document.getElementById('status').textContent = 
                    "Search for a location to detect buildings or use the Draw tool to create custom outlines.";
                
                // Add click handler for selecting buildings
                view.on('click', async (event) => {
                    if (!editMode) return;
                    
                    // Check if we clicked on a building
                    const hitTest = await view.hitTest(event);
                    const buildingGraphic = hitTest.results.find(result => 
                        result.graphic && 
                        result.graphic.layer === buildingFootprintsLayer
                    );
                    
                    if (buildingGraphic) {
                        // Start editing the clicked building
                        if (sketch) {
                            sketchLayer.removeAll();
                            sketchLayer.add(buildingGraphic.graphic);
                            sketch.update([buildingGraphic.graphic]);
                            document.getElementById('status').textContent = 
                                'Editing building. Click to add points, double-click to finish.';
                        }
                    }
                });
            });
            
            // Add a button to refresh buildings in the current view
            const refreshButton = document.createElement('button');
            refreshButton.className = 'tool-button';
            refreshButton.innerHTML = '🔄 Refresh Buildings';
            refreshButton.title = 'Refresh building detection in the current view';
            refreshButton.addEventListener('click', async () => {
                if (confirm("Refreshing will remove all detected buildings. Your custom buildings will be preserved. Continue?")) {
                    const extent = view.extent;
                    document.getElementById('status').textContent = "Updating building data...";
                    
                    try {
                        const elements = await fetchBuildingFootprints(extent);
                        const buildingCount = processOSMBuildings(elements);
                        document.getElementById('status').textContent = 
                            `Updated: ${buildingCount} buildings detected in this area.`;
                            
                        // Zoom to the buildings with some padding
                        await view.goTo({
                            target: buildingFootprintsLayer.graphics,
                            padding: 50
                        });
                        
                    } catch (error) {
                        console.error("Error refreshing buildings:", error);
                        document.getElementById('status').textContent = 
                            "Error updating building data. Please try again.";
                    }
                }
            });
            document.getElementById('topbar').appendChild(refreshButton);
            
            // Update the download function to include all buildings
            document.getElementById('downloadBtn').addEventListener('click', function() {
                // Combine both OSM and custom buildings
                const allBuildings = [...buildingFootprintsLayer.graphics.toArray(), ...customBuildingsLayer.graphics.toArray()];
                
                if (allBuildings.length === 0) {
                    alert("No buildings to download");
                    return;
                }
                
                // Create a GeoJSON feature collection
                const featureCollection = {
                    type: "FeatureCollection",
                    features: allBuildings.map(g => ({
                        type: "Feature",
                        geometry: g.geometry.toJSON(),
                        properties: {
                            id: g.attributes.id,
                            name: g.attributes.name,
                            type: g.attributes.type,
                            source: g.attributes.source,
                            notes: g.attributes.notes,
                            area: g.attributes.area,
                            timestamp: g.attributes.timestamp || new Date().toISOString()
                        }
                    }))
                };

                // Create a download link
                const dataStr = "data:text/json;charset=utf-8," + 
                    encodeURIComponent(JSON.stringify(featureCollection, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `building_footprints_${new Date().toISOString().split('T')[0]}.geojson`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                document.getElementById('status').textContent = 
                    `Downloaded ${allBuildings.length} buildings as GeoJSON`;
            });
            
            // Add a button to clear all custom buildings
            const clearCustomBtn = document.createElement('button');
            clearCustomBtn.className = 'tool-button';
            clearCustomBtn.innerHTML = '🗑️ Clear Custom Buildings';
            clearCustomBtn.title = 'Remove all custom buildings';
            clearCustomBtn.addEventListener('click', () => {
                if (customBuildingsLayer.graphics.length > 0 && 
                    confirm(`Are you sure you want to remove all ${customBuildingsLayer.graphics.length} custom buildings?`)) {
                    customBuildingsLayer.removeAll();
                    document.getElementById('status').textContent = 'All custom buildings removed';
                }
            });
            document.getElementById('topbar').appendChild(clearCustomBtn);
        });
    </script>
</head>

<body>
    <div id="instructions">
        <button id="toggleInstructions" class="help-button">Show Help</button>
        <div id="instructions-content" class="hidden">
            <h3>Building Outline Mapper</h3>
            <ol>
                <li><strong>Search</strong> for a location using the box in the top-right</li>
                <li>Click <strong>Refresh Buildings</strong> to detect buildings</li>
                <li><strong>Click</strong> on any building to view details</li>
                <li>Toggle <strong>Edit Mode</strong> to modify buildings</li>
                <li>Use <strong>Draw</strong> to add new buildings</li>
                <li>Click <strong>Show Newest Imagery</strong> for updated images</li>
            </ol>
            <p><strong>Tips:</strong></p>
            <ul>
                <li>Zoom in for better building detection</li>
                <li>Click and hold to pan the map</li>
                <li>Use mouse wheel to zoom in/out</li>
                <li>Right-click and drag to rotate (3D mode)</li>
            </ul>
        </div>
    </div>
    
    <div id="viewDiv"></div>
    
    <div id="search">
        <input type="text" placeholder="Search for a location..." />
    </div>
    
    <div id="topbar">
        <button id="drawBtn" class="tool-button" title="Draw Building Outline">
            <span>✏️ Draw</span>
        </button>
        <button id="clearBtn" class="tool-button" title="Clear All Outlines">
            <span>🗑️ Clear All</span>
        </button>
        <button id="downloadBtn" class="tool-button" title="Download Outlines">
            <span>💾 Download</span>
        </button>
    </div>
    
    <div id="status">Loading map...</div>
    
    <!-- Building Info Dialog -->
    <div id="buildingInfo">
        <h3>Building Details</h3>
        <div class="form-group">
            <label for="buildingName">Building Name:</label>
            <input type="text" id="buildingName" placeholder="Enter building name" />
        </div>
        <div class="form-group">
            <label for="buildingNotes">Notes:</label>
            <textarea id="buildingNotes" rows="3" placeholder="Add any notes about this building"></textarea>
        </div>
        <div class="form-actions">
            <button id="cancelBuildingInfo" class="btn btn-secondary">Cancel</button>
            <button id="saveBuildingInfo" class="btn btn-primary">Save</button>
        </div>
    </div>
</body>
</html>
