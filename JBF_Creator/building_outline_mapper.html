<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Building Outline Mapper</title>
    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        #topbar {
            background: #fff;
            padding: 10px;
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-button {
            padding: 8px 12px;
            background: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tool-button.active {
            background: #0079c1;
            color: white;
            border-color: #005e95;
        }

        #search {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1;
            width: 300px;
        }

        #search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        #status {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            z-index: 1;
            font-size: 14px;
        }

        .esri-ui-top-right {
            top: 60px !important;
        }
        
        /* Building info window styles */
        #buildingInfo {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 300px;
        }
        
        #buildingInfo h3 {
            margin-top: 0;
            color: #333;
        }
        
        #buildingInfo label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        
        #buildingInfo input, #buildingInfo textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #buildingInfo button {
            background: #0079c1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #buildingInfo button:hover {
            background: #005e95;
        }
        
        .building-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    
    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/Search",
            "esri/widgets/Sketch",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/geometry/geometryEngine",
            "esri/widgets/Expand",
            "esri/widgets/BasemapToggle",
            "esri/widgets/BasemapGallery",
            "esri/geometry/geometryEngineAsync",
            "esri/geometry/Extent",
            "esri/geometry/Polygon",
            "esri/geometry/Point",
            "esri/geometry/support/webMercatorUtils",
            "esri/request"
        ], function(
            Map, MapView, Search, Sketch, GraphicsLayer, Graphic, geometryEngine, 
            Expand, BasemapToggle, BasemapGallery, geometryEngineAsync,
            Extent, Polygon, Point, webMercatorUtils, esriRequest
        ) {
            // Create a map with the latest imagery basemap
            const map = new Map({
                basemap: "satellite"
            });

            // Create a view for the map
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 39.8283], // Center of the US
                zoom: 4
            });

            // Create a graphics layer for the building outlines
            const graphicsLayer = new GraphicsLayer();
            map.add(graphicsLayer);
            
            // Layer for detected building footprints
            const buildingFootprintsLayer = new GraphicsLayer();
            map.add(buildingFootprintsLayer);
            
            // Function to fetch building footprints from OSM
            async function fetchBuildingFootprints(extent) {
                // Convert extent to WGS84 for OSM query
                const wgs84Extent = webMercatorUtils.webMercatorToGeographic(extent);
                const [xmin, ymin, xmax, ymax] = [
                    wgs84Extent.xmin, 
                    wgs84Extent.ymin, 
                    wgs84Extent.xmax, 
                    wgs84Extent.ymax
                ];
                
                // Overpass API query for buildings
                const query = `
                    [out:json][timeout:25];
                    (
                      way[building](${ymin},${xmin},${ymax},${xmax});
                      relation[building](${ymin},${xmin},${ymax},${xmax});
                    );
                    (._;>;);
                    out body;
                `.replace(/\s+/g, ' ').trim();
                
                try {
                    const response = await esriRequest(
                        `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`,
                        { responseType: "json" }
                    );
                    
                    return response.data.elements || [];
                } catch (error) {
                    console.error("Error fetching building data:", error);
                    return [];
                }
            }
            
            // Function to process OSM data and create graphics
            function processOSMBuildings(elements) {
                // Clear previous footprints
                buildingFootprintsLayer.removeAll();
                
                const buildings = elements.filter(el => el.type === 'way' && el.tags && el.tags.building);
                let buildingCount = 0;
                
                buildings.forEach(building => {
                    if (building.nodes && building.nodes.length >= 3) {
                        // Convert OSM nodes to points
                        const points = building.nodes.map(nodeId => {
                            const node = elements.find(el => el.type === 'node' && el.id === nodeId);
                            return node ? [node.lon, node.lat] : null;
                        }).filter(Boolean);
                        
                        if (points.length >= 3) {
                            // Create a polygon graphic
                            const polygon = {
                                type: "polygon",
                                rings: [points.map(p => [p[0], p[1]])]
                            };
                            
                            // Get building name from OSM tags if available
                            const buildingName = building.tags.name || `Building ${building.id}`;
                            const buildingType = building.tags.building || 'building';
                            
                            const graphic = new Graphic({
                                geometry: polygon,
                                symbol: {
                                    type: "simple-fill",
                                    color: [0, 0, 255, 0.5],
                                    outline: {
                                        color: [0, 0, 200],
                                        width: 1
                                    }
                                },
                                attributes: {
                                    id: building.id,
                                    name: buildingName,
                                    type: buildingType,
                                    source: 'OSM',
                                    notes: '',
                                    area: geometryEngine.geodesicArea(polygon, "square-meters").toFixed(2) + " m¬≤",
                                    timestamp: new Date().toISOString()
                                },
                                popupTemplate: {
                                    title: "{name}",
                                    content: [
                                        {
                                            type: "fields",
                                            fieldInfos: [
                                                { fieldName: "type", label: "Type" },
                                                { fieldName: "area", label: "Area" },
                                                { fieldName: "notes", label: "Notes" }
                                            ]
                                        }
                                    ]
                                }
                            });
                            
                            // Add click event to show edit dialog
                            graphic.on('click', (event) => {
                                if (editMode) {
                                    showBuildingInfo(graphic);
                                }
                            });
                            
                            buildingFootprintsLayer.add(graphic);
                            buildingCount++;
                        }
                    }
                });
                
                return buildingCount;
            }
            
            // Show building info dialog
            function showBuildingInfo(graphic) {
                const infoDiv = document.getElementById('buildingInfo');
                const nameInput = document.getElementById('buildingName');
                const notesInput = document.getElementById('buildingNotes');
                const saveBtn = document.getElementById('saveBuildingInfo');
                const cancelBtn = document.getElementById('cancelBuildingInfo');
                
                // Set current values
                nameInput.value = graphic.attributes.name || '';
                notesInput.value = graphic.attributes.notes || '';
                
                // Position the dialog
                infoDiv.style.display = 'block';
                
                // Save handler
                const saveHandler = () => {
                    graphic.attributes.name = nameInput.value.trim() || `Building ${graphic.attributes.id}`;
                    graphic.attributes.notes = notesInput.value.trim();
                    
                    // Update the popup title
                    if (graphic.popupTemplate) {
                        graphic.popupTemplate.title = graphic.attributes.name;
                    }
                    
                    infoDiv.style.display = 'none';
                    
                    // Clean up event listeners
                    saveBtn.removeEventListener('click', saveHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };
                
                // Cancel handler
                const cancelHandler = () => {
                    infoDiv.style.display = 'none';
                    
                    // Clean up event listeners
                    saveBtn.removeEventListener('click', saveHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };
                
                // Add event listeners
                saveBtn.addEventListener('click', saveHandler);
                cancelBtn.addEventListener('click', cancelHandler);
                
                // Close on escape key
                const keyHandler = (e) => {
                    if (e.key === 'Escape') {
                        cancelHandler();
                        document.removeEventListener('keydown', keyHandler);
                    }
                };
                document.addEventListener('keydown', keyHandler);
            }

            // Add the search widget with custom behavior
            const searchWidget = new Search({
                view: view,
                container: "search",
                popupEnabled: false,
                includeDefaultSources: false,
                sources: [{
                    name: "Esri World Geocoder",
                    placeholder: "Search for an address or place",
                    apiKey: null, // You can add an API key here if needed
                    singleLineFieldName: "SingleLine",
                    outFields: ["*"],
                    zoomScale: 2000,
                    maxResults: 6,
                    searchExtent: null,
                    countryCode: ""
                }]
            });
            
            // When search completes, fetch buildings in the area
            searchWidget.on("search-complete", async (event) => {
                if (event.results && event.results.length > 0) {
                    const result = event.results[0];
                    const extent = result.extent;
                    
                    // Show loading message
                    document.getElementById('status').textContent = "Detecting buildings in this area...";
                    
                    try {
                        // Fetch buildings from OSM
                        const elements = await fetchBuildingFootprints(extent);
                        const buildingCount = processOSMBuildings(elements);
                        
                        // Update status
                        document.getElementById('status').textContent = 
                            `Detected ${buildingCount} buildings. Click on a building to edit its details.`;
                            
                        // Zoom to the buildings with some padding
                        await view.goTo({
                            target: buildingFootprintsLayer.graphics,
                            padding: 50
                        });
                        
                    } catch (error) {
                        console.error("Error processing buildings:", error);
                        document.getElementById('status').textContent = 
                            "Error detecting buildings. Please try another location.";
                    }
                }
            });
            
            // Function to create a new building with default attributes
            function createNewBuilding(geometry) {
                const id = 'custom_' + Date.now();
                const area = geometryEngine.geodesicArea(geometry, "square-meters").toFixed(2) + " m¬≤";
                
                return new Graphic({
                    geometry: geometry,
                    symbol: {
                        type: "simple-fill",
                        color: [0, 200, 0, 0.5],
                        outline: {
                            color: [0, 150, 0],
                            width: 2
                        }
                    },
                    attributes: {
                        id: id,
                        name: `Building ${id}`,
                        type: 'building',
                        source: 'custom',
                        notes: '',
                        area: area,
                        timestamp: new Date().toISOString()
                    },
                    popupTemplate: {
                        title: "{name}",
                        content: [
                            {
                                type: "fields",
                                fieldInfos: [
                                    { fieldName: "type", label: "Type" },
                                    { fieldName: "area", label: "Area" },
                                    { fieldName: "notes", label: "Notes" }
                                ]
                            }
                        ]
                    }
                });
            }

            // Create the sketch widget
            let sketch;
            const sketchLayer = new GraphicsLayer();
            map.add(sketchLayer);
            
            // Create a layer for custom buildings
            const customBuildingsLayer = new GraphicsLayer();
            map.add(customBuildingsLayer);
            
            // Add a button to toggle between viewing and editing mode
            let editMode = false;
            const toggleEditMode = document.createElement('button');
            toggleEditMode.id = 'toggleEditMode';
            toggleEditMode.className = 'tool-button';
            toggleEditMode.innerHTML = '‚úèÔ∏è Toggle Edit Mode';
            toggleEditMode.title = 'Toggle between viewing and editing building footprints';
            toggleEditMode.addEventListener('click', () => {
                editMode = !editMode;
                if (editMode) {
                    toggleEditMode.classList.add('active');
                    document.getElementById('status').textContent = 
                        'Edit mode: Click on a building to edit it';
                } else {
                    toggleEditMode.classList.remove('active');
                    document.getElementById('status').textContent = 
                        'View mode: Click on buildings to select them';
                }
            });
            document.getElementById('topbar').appendChild(toggleEditMode);

            // Initialize the sketch widget when the view is ready
            view.when(() => {
                sketch = new Sketch({
                    layer: sketchLayer,
                    view: view,
                    creationMode: "update",
                    availableCreateTools: ["polygon"],
                    container: document.createElement("div"),
                    defaultCreateOptions: {
                        mode: "hybrid"
                    }
                });

                // Add a basemap gallery in the top right corner
                const basemapGallery = new BasemapGallery({
                    view: view
                });

                const bgExpand = new Expand({
                    view: view,
                    content: basemapGallery,
                    expandTooltip: "Basemap Gallery"
                });

                view.ui.add(bgExpand, "top-right");
                
                // Add a basemap toggle
                const basemapToggle = new BasemapToggle({
                    view: view,
                    nextBasemap: "hybrid"
                });
                
                view.ui.add(basemapToggle, "bottom-right");

                // Update UI when the sketch is created
                sketch.on("create", function(event) {
                    if (event.state === "complete") {
                        // Convert the sketch to a graphic and add it to the graphics layer
                        const graphic = event.graphic.clone();
                        graphic.symbol = {
                            type: "simple-fill",
                            color: [255, 0, 0, 0.3],
                            style: "solid",
                            outline: {
                                color: [255, 0, 0],
                                width: 2
                            }
                        };
                        graphicsLayer.add(graphic);
                        
                        // Clear the sketch layer
                        sketchLayer.removeAll();
                        
                        // Update status
                        document.getElementById('status').textContent = 
                            `Building outline added. Total: ${graphicsLayer.graphics.length} buildings`;
                    }
                });

                // Update status when sketch is updated
                sketch.on("update", function(event) {
                    if (event.state === "complete") {
                        document.getElementById('status').textContent = 
                            `Building outline updated. Total: ${graphicsLayer.graphics.length} buildings`;
                    }
                });
            });

            // Toggle drawing mode
            document.getElementById('drawBtn').addEventListener('click', function() {
                if (this.classList.contains('active')) {
                    // Disable drawing
                    view.ui.remove(sketch);
                    this.classList.remove('active');
                    document.getElementById('status').textContent = "Drawing mode deactivated";
                } else {
                    // Enable drawing
                    view.ui.add(sketch, "top-right");
                    this.classList.add('active');
                    document.getElementById('status').textContent = "Click on the map to start drawing a building outline";
                }
            });

            // Clear all graphics
            document.getElementById('clearBtn').addEventListener('click', function() {
                if (confirm("Are you sure you want to clear all building outlines?")) {
                    graphicsLayer.removeAll();
                    document.getElementById('status').textContent = "All building outlines cleared";
                }
            });

            // Download the building outlines as GeoJSON
            document.getElementById('downloadBtn').addEventListener('click', function() {
                if (graphicsLayer.graphics.length === 0) {
                    alert("No building outlines to download");
                    return;
                }

                
                // Create a GeoJSON feature collection
                const featureCollection = {
                    type: "FeatureCollection",
                    features: graphicsLayer.graphics.map(g => ({
                        type: "Feature",
                        geometry: g.geometry.toJSON(),
                        properties: {
                            id: g.attributes?.id || Date.now(),
                            area: geometryEngine.geodesicArea(g.geometry, "square-meters").toFixed(2) + " m¬≤"
                        }
                    }))
                };

                // Create a download link
                const dataStr = "data:text/json;charset=utf-8," + 
                    encodeURIComponent(JSON.stringify(featureCollection, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `building_outlines_${new Date().toISOString().split('T')[0]}.geojson`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                document.getElementById('status').textContent = `Downloaded ${graphicsLayer.graphics.length} building outlines`;
            });

            // Update status when the view is ready
            view.when(() => {
                document.getElementById('status').textContent = 
                    "Search for a location to detect buildings or use the Draw tool to create custom outlines.";
                
                // Add click handler for selecting buildings
                view.on('click', async (event) => {
                    if (!editMode) return;
                    
                    // Check if we clicked on a building
                    const hitTest = await view.hitTest(event);
                    const buildingGraphic = hitTest.results.find(result => 
                        result.graphic && 
                        result.graphic.layer === buildingFootprintsLayer
                    );
                    
                    if (buildingGraphic) {
                        // Start editing the clicked building
                        if (sketch) {
                            sketchLayer.removeAll();
                            sketchLayer.add(buildingGraphic.graphic);
                            sketch.update([buildingGraphic.graphic]);
                            document.getElementById('status').textContent = 
                                'Editing building. Click to add points, double-click to finish.';
                        }
                    }
                });
            });
            
            // Add a button to refresh buildings in the current view
            const refreshButton = document.createElement('button');
            refreshButton.className = 'tool-button';
            refreshButton.innerHTML = 'üîÑ Refresh Buildings';
            refreshButton.title = 'Refresh building detection in the current view';
            refreshButton.addEventListener('click', async () => {
                if (confirm("Refreshing will remove all detected buildings. Your custom buildings will be preserved. Continue?")) {
                    const extent = view.extent;
                    document.getElementById('status').textContent = "Updating building data...";
                    
                    try {
                        const elements = await fetchBuildingFootprints(extent);
                        const buildingCount = processOSMBuildings(elements);
                        document.getElementById('status').textContent = 
                            `Updated: ${buildingCount} buildings detected in this area.`;
                    } catch (error) {
                        console.error("Error refreshing buildings:", error);
                        document.getElementById('status').textContent = 
                            "Error updating building data. Please try again.";
                    }
                }
            });
            document.getElementById('topbar').appendChild(refreshButton);
            
            // Update the download function to include all buildings
            document.getElementById('downloadBtn').addEventListener('click', function() {
                // Combine both OSM and custom buildings
                const allBuildings = [...buildingFootprintsLayer.graphics.toArray(), ...customBuildingsLayer.graphics.toArray()];
                
                if (allBuildings.length === 0) {
                    alert("No buildings to download");
                    return;
                }
                
                // Create a GeoJSON feature collection
                const featureCollection = {
                    type: "FeatureCollection",
                    features: allBuildings.map(g => ({
                        type: "Feature",
                        geometry: g.geometry.toJSON(),
                        properties: {
                            id: g.attributes.id,
                            name: g.attributes.name,
                            type: g.attributes.type,
                            source: g.attributes.source,
                            notes: g.attributes.notes,
                            area: g.attributes.area,
                            timestamp: g.attributes.timestamp || new Date().toISOString()
                        }
                    }))
                };

                // Create a download link
                const dataStr = "data:text/json;charset=utf-8," + 
                    encodeURIComponent(JSON.stringify(featureCollection, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `building_footprints_${new Date().toISOString().split('T')[0]}.geojson`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                document.getElementById('status').textContent = 
                    `Downloaded ${allBuildings.length} buildings as GeoJSON`;
            });
            
            // Add a button to clear all custom buildings
            const clearCustomBtn = document.createElement('button');
            clearCustomBtn.className = 'tool-button';
            clearCustomBtn.innerHTML = 'üóëÔ∏è Clear Custom Buildings';
            clearCustomBtn.title = 'Remove all custom buildings';
            clearCustomBtn.addEventListener('click', () => {
                if (customBuildingsLayer.graphics.length > 0 && 
                    confirm(`Are you sure you want to remove all ${customBuildingsLayer.graphics.length} custom buildings?`)) {
                    customBuildingsLayer.removeAll();
                    document.getElementById('status').textContent = 'All custom buildings removed';
                }
            });
            document.getElementById('topbar').appendChild(clearCustomBtn);
        });
    </script>
</head>

<body>
    <div id="viewDiv"></div>
    
    <div id="search">
        <input type="text" placeholder="Search for a location..." />
    </div>
    
    <div id="topbar">
        <button id="drawBtn" class="tool-button" title="Draw Building Outline">
            <span>‚úèÔ∏è Draw</span>
        </button>
        <button id="clearBtn" class="tool-button" title="Clear All Outlines">
            <span>üóëÔ∏è Clear All</span>
        </button>
        <button id="downloadBtn" class="tool-button" title="Download Outlines">
            <span>üíæ Download</span>
        </button>
    </div>
    
    <div id="status">Loading map...</div>
    
    <!-- Building Info Dialog -->
    <div id="buildingInfo">
        <h3>Building Details</h3>
        <div class="form-group">
            <label for="buildingName">Building Name:</label>
            <input type="text" id="buildingName" placeholder="Enter building name" />
        </div>
        <div class="form-group">
            <label for="buildingNotes">Notes:</label>
            <textarea id="buildingNotes" rows="3" placeholder="Add any notes about this building"></textarea>
        </div>
        <div class="form-actions">
            <button id="cancelBuildingInfo" class="btn btn-secondary">Cancel</button>
            <button id="saveBuildingInfo" class="btn btn-primary">Save</button>
        </div>
    </div>
</body>
</html>
