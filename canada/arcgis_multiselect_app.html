<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Canada Towns Interactive Map</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
        }

        #downloadBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #0079c1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #downloadBtn:hover {
            background: #005a87;
        }

        #downloadBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #status {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <div id="viewDiv"></div>
    <button id="downloadBtn" disabled>Download Selected Polygon</button>
    <div id="status">Click a polygon to select it for download</div>

    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/renderers/SimpleRenderer",
            "esri/Graphic",
            "esri/geometry/geometryEngine"
        ], function(Map, MapView, FeatureLayer, SimpleFillSymbol, SimpleLineSymbol, SimpleRenderer, Graphic, geometryEngine) {

            let selectedFeature = null;
            let highlightSelect = null;

            // Create the map
            const map = new Map({
                basemap: "streets-navigation-vector"
            });

            // Create the map view
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-106.3468, 56.1304], // Center of Canada
                zoom: 4
            });

            // Define renderer for the layer
            const renderer = new SimpleRenderer({
                symbol: new SimpleFillSymbol({
                    color: [51, 51, 204, 0.3],
                    outline: new SimpleLineSymbol({
                        color: [51, 51, 204, 0.8],
                        width: 1
                    })
                })
            });

            // Create the feature layer
            const canadaTownsLayer = new FeatureLayer({
                url: "https://services3.arcgis.com/8lRAGVDTn4JslcF7/arcgis/rest/services/Canada_Town/FeatureServer",
                renderer: renderer,
                outFields: ["*"]
            });

            // Add the layer to the map
            map.add(canadaTownsLayer);

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.display = 'none';
            document.body.appendChild(tooltip);

            // Handle mouse move for hover effect
            view.on("pointer-move", function(event) {
                view.hitTest(event).then(function(response) {
                    if (response.results.length > 0 &&
                        response.results[0].graphic.layer === canadaTownsLayer) {

                        const graphic = response.results[0].graphic;
                        const attributes = graphic.attributes;

                        // Show tooltip with town name
                        let townName = attributes.NAME || attributes.name || attributes.TOWN_NAME || 'Unknown Town';

                        // Check other possible field names for town name
                        Object.keys(attributes).forEach(key => {
                            if ((key.toLowerCase().includes('name') ||
                                 key.toLowerCase().includes('town') ||
                                 key.toLowerCase().includes('city')) &&
                                 attributes[key] && townName === 'Unknown Town') {
                                townName = attributes[key];
                            }
                        });

                        tooltip.innerHTML = `<strong>${townName}</strong>`;
                        tooltip.style.display = 'block';
                        tooltip.style.left = event.x + 15 + 'px';
                        tooltip.style.top = event.y - 15 + 'px';

                        view.container.style.cursor = "pointer";
                    } else {
                        tooltip.style.display = 'none';
                        view.container.style.cursor = "default";
                    }
                });
            });

            // Handle mouse leave
            view.on("pointer-leave", function() {
                tooltip.style.display = 'none';
                view.container.style.cursor = "default";
            });

            // Handle click for selection
            view.on("click", function(event) {
                view.hitTest(event).then(function(response) {
                    // Clear previous selection
                    if (highlightSelect) {
                        highlightSelect.remove();
                        highlightSelect = null;
                    }

                    if (response.results.length > 0 &&
                        response.results[0].graphic.layer === canadaTownsLayer) {

                        const graphic = response.results[0].graphic;
                        selectedFeature = graphic;

                        // Highlight selected feature
                        view.whenLayerView(canadaTownsLayer).then(function(layerView) {
                            highlightSelect = layerView.highlight(graphic);
                        });

                        // Enable download button
                        document.getElementById('downloadBtn').disabled = false;

                        // Update status
                        const attributes = graphic.attributes;
                        let townName = attributes.NAME || attributes.name || attributes.TOWN_NAME || 'Selected Town';
                        Object.keys(attributes).forEach(key => {
                            if ((key.toLowerCase().includes('name') ||
                                 key.toLowerCase().includes('town') ||
                                 key.toLowerCase().includes('city')) &&
                                 attributes[key] && townName === 'Selected Town') {
                                townName = attributes[key];
                            }
                        });

                        document.getElementById('status').textContent = `Selected: ${townName}`;
                    } else {
                        selectedFeature = null;
                        document.getElementById('downloadBtn').disabled = true;
                        document.getElementById('status').textContent = 'Click a polygon to select it for download';
                    }
                });
            });

            // Download functionality
            document.getElementById('downloadBtn').addEventListener('click', function() {
                if (!selectedFeature) {
                    alert('No polygon selected');
                    return;
                }

                try {
                    // Create GeoJSON from the selected feature
                    const geoJSON = {
                        type: "FeatureCollection",
                        features: [{
                            type: "Feature",
                            geometry: {
                                type: selectedFeature.geometry.type === "polygon" ? "Polygon" : "MultiPolygon",
                                coordinates: convertEsriGeometryToGeoJSON(selectedFeature.geometry)
                            },
                            properties: selectedFeature.attributes
                        }]
                    };

                    // Create and download the file
                    const dataStr = JSON.stringify(geoJSON, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);

                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;

                    // Get town name for filename
                    const attributes = selectedFeature.attributes;
                    let townName = attributes.NAME || attributes.name || attributes.TOWN_NAME || 'selected_town';
                    Object.keys(attributes).forEach(key => {
                        if ((key.toLowerCase().includes('name') ||
                             key.toLowerCase().includes('town') ||
                             key.toLowerCase().includes('city')) &&
                             attributes[key] && townName === 'selected_town') {
                            townName = attributes[key];
                        }
                    });

                    // Clean filename
                    townName = townName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    downloadLink.download = `${townName}_polygon.geojson`;

                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Error downloading polygon:', error);
                    alert('Error downloading polygon. Please try again.');
                }
            });

            // Helper function to convert Esri geometry to GeoJSON coordinates
            function convertEsriGeometryToGeoJSON(geometry) {
                if (geometry.rings) {
                    // Polygon geometry
                    return geometry.rings.map(ring =>
                        ring.map(coord => [coord[0], coord[1]])
                    );
                }
                return [];
            }

            // Wait for layer to load and zoom to extent
            canadaTownsLayer.when(function() {
                console.log("Canada Towns layer loaded successfully");

                // Get layer extent and zoom to it
                if (canadaTownsLayer.fullExtent) {
                    view.goTo(canadaTownsLayer.fullExtent);
                }
            }).catch(function(error) {
                console.error("Error loading layer:", error);
                document.getElementById('status').textContent = 'Error loading Canada Towns layer';
            });
        });
    </script>
</body>
</html>